<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Chapter 25 Design widgets | Outstanding User Interfaces with Shiny</title>
<meta name="author" content="David Granjon">
<meta name="description" content="Framework7 brings dozen of different widgets like a photo browser, virtual lists (high performance lists), messages, notifications, toasts. Figure 25.1 shows from left to right the chat widget,...">
<meta name="generator" content="bookdown 0.24 with bs4_book()">
<meta property="og:title" content="Chapter 25 Design widgets | Outstanding User Interfaces with Shiny">
<meta property="og:type" content="book">
<meta property="og:image" content="https://raw.githubusercontent.com/DivadNojnarg/outstanding-shiny-ui/master/images/intro/crc-press-cover.svg">
<meta property="og:description" content="Framework7 brings dozen of different widgets like a photo browser, virtual lists (high performance lists), messages, notifications, toasts. Figure 25.1 shows from left to right the chat widget,...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Chapter 25 Design widgets | Outstanding User Interfaces with Shiny">
<meta name="twitter:description" content="Framework7 brings dozen of different widgets like a photo browser, virtual lists (high performance lists), messages, notifications, toasts. Figure 25.1 shows from left to right the chat widget,...">
<meta name="twitter:image" content="https://raw.githubusercontent.com/DivadNojnarg/outstanding-shiny-ui/master/images/intro/crc-press-cover.svg">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/header-attrs-2.11/header-attrs.js"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.3.0/transition.js"></script><script src="libs/bs3compat-0.3.0/tabs.js"></script><script src="libs/bs3compat-0.3.0/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><link rel="stylesheet" href="css/style.css">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">Outstanding User Interfaces with Shiny</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">Welcome</a></li>
<li><a class="" href="foreword.html">Foreword</a></li>
<li class="book-part">Introduction</li>
<li><a class="" href="web-intro.html"><span class="header-section-number">1</span> Shiny and the Web</a></li>
<li><a class="" href="htmltools-overview.html"><span class="header-section-number">2</span> Manipulate HTML tags from R with {htmltools}</a></li>
<li><a class="" href="web-dependencies.html"><span class="header-section-number">3</span> Discover Shiny dependencies</a></li>
<li><a class="" href="htmltools-dependencies.html"><span class="header-section-number">4</span> Handle HTML dependencies with {htmltools}</a></li>
<li><a class="" href="web-applications.html"><span class="header-section-number">5</span> Web application concepts</a></li>
<li class="book-part">Beautify with CSS and Sass</li>
<li><a class="" href="beautify-css.html"><span class="header-section-number">6</span> CSS for Shiny</a></li>
<li><a class="" href="beautify-sass.html"><span class="header-section-number">7</span> Tidy your CSS with Sass</a></li>
<li><a class="" href="beautify-with-fresh.html"><span class="header-section-number">8</span> Beautify with {fresh}</a></li>
<li><a class="" href="beautify-with-bootstraplib.html"><span class="header-section-number">9</span> Become a theming wizard with {bslib}</a></li>
<li class="book-part">Unleash interactivity with JavaScript</li>
<li><a class="" href="survival-kit-javascript.html"><span class="header-section-number">10</span> JavaScript for Shiny</a></li>
<li><a class="" href="shiny-intro.html"><span class="header-section-number">11</span> Communicate between R and JS</a></li>
<li><a class="" href="shiny-input-system.html"><span class="header-section-number">12</span> Understand and develop new Shiny inputs</a></li>
<li><a class="" href="shiny-input-lifecycle.html"><span class="header-section-number">13</span> Shiny inputs lifecycles</a></li>
<li><a class="" href="shiny-input-gems.html"><span class="header-section-number">14</span> Mastering Shinyâ€™s events</a></li>
<li><a class="" href="shiny-custom-handler.html"><span class="header-section-number">15</span> Optimize your apps with custom handlers</a></li>
<li class="book-part">Practice: A Bootstrap 4 dashboard template</li>
<li><a class="" href="custom-templates-dependencies.html"><span class="header-section-number">16</span> Define dependencies</a></li>
<li><a class="" href="custom-templates-skeleton.html"><span class="header-section-number">17</span> Create template elements</a></li>
<li><a class="" href="custom-templates-inputs.html"><span class="header-section-number">18</span> Develop custom input widgets</a></li>
<li><a class="" href="custom-templates-interactivity.html"><span class="header-section-number">19</span> Adding more interactivity</a></li>
<li><a class="" href="custom-templates-testing.html"><span class="header-section-number">20</span> Testing and validating templates elements</a></li>
<li class="book-part">Toward a better workflow</li>
<li><a class="" href="workflow-charpente.html"><span class="header-section-number">21</span> Automate new template creation with {charpente}</a></li>
<li class="book-part">Case study: Mobile development for Shiny</li>
<li><a class="" href="mobile-shiny-intro.html"><span class="header-section-number">22</span> Introduction</a></li>
<li><a class="" href="mobile-shinyMobile.html"><span class="header-section-number">23</span> Reconstruct {shinyMobile}</a></li>
<li><a class="" href="mobile-pwa.html"><span class="header-section-number">24</span> {shinyMobile} and PWA</a></li>
<li><a class="active" href="mobile-widgets.html"><span class="header-section-number">25</span> Design widgets</a></li>
<li><a class="" href="mobile-going-further.html"><span class="header-section-number">26</span> Fine tune {shinyMobile}</a></li>
<li class="book-part">Going further</li>
<li><a class="" href="going-further-reactR.html"><span class="header-section-number">27</span> Shiny and React with {reactR}</a></li>
<li><a class="" href="going-further-webdev.html"><span class="header-section-number">28</span> Divide and Conquere</a></li>
<li><a class="" href="going-further-where-to-go.html"><span class="header-section-number">29</span> What to do next?</a></li>
<li class="book-part">Appendix</li>
<li><a class="" href="code-outputs.html"><span class="header-section-number">A</span> Code outputs</a></li>
<li><a class="" href="references.html">References</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/DivadNojnarg/outstanding-shiny-ui">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="mobile-widgets" class="section level1" number="25">
<h1>
<span class="header-section-number">25</span> Design widgets<a class="anchor" aria-label="anchor" href="#mobile-widgets"><i class="fas fa-link"></i></a>
</h1>
<p>Framework7 brings dozen of different <strong>widgets</strong> like a photo browser, virtual lists (high performance lists), messages, notifications, toasts. Figure <a href="mobile-widgets.html#fig:mobile-widgets-examples">25.1</a> shows from left to right the chat widget, the floating action buttons and the gauges.</p>
<div class="figure">
<span style="display:block;" id="fig:mobile-widgets-examples"></span>
<img src="images/mobile/mobile-widget-chat.png" alt="Framework7 widgets. From left to right: chat, floating action button and gauges." width="33%"><img src="images/mobile/mobile-widget-fab.png" alt="Framework7 widgets. From left to right: chat, floating action button and gauges." width="33%"><img src="images/mobile/mobile-widget-gauges.png" alt="Framework7 widgets. From left to right: chat, floating action button and gauges." width="33%"><p class="caption">
FIGURE 25.1: Framework7 widgets. From left to right: chat, floating action button and gauges.
</p>
</div>
<p>Looking at the <a href="https://v5.framework7.io/docs/">documentation</a>, the API is most of the time always the same that is, we create the widget:</p>
<div class="sourceCode" id="cb942"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb942-1"><a href="mobile-widgets.html#cb942-1" aria-hidden="true" tabindex="-1"></a>app<span class="op">.</span><span class="at">widget</span><span class="op">.</span><span class="fu">create</span>(parameters)<span class="op">;</span></span></code></pre></div>
<p>and we update, open or close it later:</p>
<div class="sourceCode" id="cb943"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb943-1"><a href="mobile-widgets.html#cb943-1" aria-hidden="true" tabindex="-1"></a>app<span class="op">.</span><span class="at">widget</span><span class="op">.</span><span class="fu">update</span>(newParameters)<span class="op">;</span></span>
<span id="cb943-2"><a href="mobile-widgets.html#cb943-2" aria-hidden="true" tabindex="-1"></a>app<span class="op">.</span><span class="at">widget</span><span class="op">.</span><span class="fu">open</span>()<span class="op">;</span></span>
<span id="cb943-3"><a href="mobile-widgets.html#cb943-3" aria-hidden="true" tabindex="-1"></a>app<span class="op">.</span><span class="at">widget</span><span class="op">.</span><span class="fu">close</span>()<span class="op">;</span></span></code></pre></div>
<p>I must admit, there are few deviations like the navbar (<code>app.navbar.show()</code>) or the modal <a href="https://v5.framework7.io/docs/dialog.html#dialog-shortcuts">dialog</a> but we have enough common points to design a main wrapper that creates any widget and update/open/close it.</p>
<p>What we do below significantly simplifies the R/JS API by providing a general method to initialize and update some of those widgets.</p>
<div class="warningblock">
<p>As a reminder, the code examples shown throughout this chapter are gathered in the <code>{OSUICode}</code> package accessible here: <a href="https://github.com/DivadNojnarg/OSUICode/tree/1d42aa7531705954d3c21921c8bbb10623b20d12" class="uri">https://github.com/DivadNojnarg/OSUICode/tree/1d42aa7531705954d3c21921c8bbb10623b20d12</a>, specifically at <a href="https://github.com/DivadNojnarg/OSUICode/blob/1d42aa7531705954d3c21921c8bbb10623b20d12/R/shinyMobile.R#L151" class="uri">https://github.com/DivadNojnarg/OSUICode/blob/1d42aa7531705954d3c21921c8bbb10623b20d12/R/shinyMobile.R#L151</a> for widgets.</p>
</div>
<div id="build-the-ui" class="section level2" number="25.1">
<h2>
<span class="header-section-number">25.1</span> Build the UI<a class="anchor" aria-label="anchor" href="#build-the-ui"><i class="fas fa-link"></i></a>
</h2>
<p>We know that JavaScript must receive a configuration object to create the widget instance.
As shown earlier in this book, there is a simple way to achieve this. Letâ€™s consider the <a href="https://v5.framework7.io/docs/gauge.html">gauge</a> example:</p>
<p>On the UI side, we expect to have:</p>
<div class="sourceCode" id="cb944"><pre class="sourceCode html"><code class="sourceCode html"><span id="cb944-1"><a href="mobile-widgets.html#cb944-1" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;div</span> <span class="er">class</span><span class="ot">=</span><span class="st">"gauge"</span><span class="kw">&gt;&lt;/div&gt;</span></span></code></pre></div>
<p>Upon widget instantiation, Framework7 populates this container with the relevant tags and attributes. The <code><a href="https://rdrr.io/pkg/OSUICode/man/f7_gauge.html">f7_gauge()</a></code> function creates a <code>div</code> tag with the <code>gauge</code> class as well as a configuration tag:</p>
<div class="sourceCode" id="cb945"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">f7_gauge</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">id</span>, <span class="va">value</span>, <span class="va">options</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span>

  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span><span class="op">(</span><span class="va">options</span><span class="op">[[</span><span class="st">"valueText"</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">options</span><span class="op">[[</span><span class="st">"valueText"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">value</span> <span class="op">*</span> <span class="fl">100</span>, <span class="st">"%"</span><span class="op">)</span>
  <span class="op">}</span>

  <span class="va">gaugeProps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>value <span class="op">=</span> <span class="va">value</span><span class="op">)</span>, <span class="va">options</span><span class="op">)</span>

  <span class="va">gaugeConfig</span> <span class="op">&lt;-</span> <span class="fu">shiny</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/htmltools/man/builder.html">tags</a></span><span class="op">$</span><span class="fu">script</span><span class="op">(</span>
    type <span class="op">=</span> <span class="st">"application/json"</span>,
    `data-for` <span class="op">=</span> <span class="va">id</span>,
    <span class="fu">jsonlite</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/jsonlite/man/fromJSON.html">toJSON</a></span><span class="op">(</span>
      x <span class="op">=</span> <span class="va">gaugeProps</span>,
      auto_unbox <span class="op">=</span> <span class="cn">TRUE</span>,
      json_verbatim <span class="op">=</span> <span class="cn">TRUE</span>
    <span class="op">)</span>
  <span class="op">)</span>

  <span class="fu">shiny</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/htmltools/man/builder.html">tags</a></span><span class="op">$</span><span class="fu">div</span><span class="op">(</span>
    class <span class="op">=</span> <span class="st">"gauge"</span>,
    id <span class="op">=</span> <span class="va">id</span>,
    <span class="va">gaugeConfig</span>
  <span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>We provide a default for the <code>valueText</code> option that should display the current
value followed by a <code>%</code> symbol. Note that the class is crucial to target the relevant tag on the JS side. All other widgets more or less follow the same scheme. Be careful about <strong>partial matching</strong>
with the <code><a href="https://rdrr.io/r/base/Extract.html">$</a></code> operator. This is the reason why we used <code><a href="https://rdrr.io/r/base/Extract.html">[[</a></code> instead: with <code><a href="https://rdrr.io/r/base/Extract.html">$</a></code>, <code>valueText</code> could be
matched with <code>valueTextColor</code>, leading to unexpected behavior.</p>
</div>
<div id="widgets-without-preexisting-ui" class="section level2" number="25.2">
<h2>
<span class="header-section-number">25.2</span> Widgets without preexisting UI<a class="anchor" aria-label="anchor" href="#widgets-without-preexisting-ui"><i class="fas fa-link"></i></a>
</h2>
<p>There are few widgets like <strong>toasts</strong> and <strong>notifications</strong> that donâ€™t have any predefined UI element when the app starts. In this case, we simply send the configuration to JS, through the <strong>session</strong>:</p>
<div class="sourceCode" id="cb946"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">f7_notif</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span>
  <span class="va">id</span> <span class="op">=</span> <span class="cn">NULL</span>, 
  <span class="va">text</span>, 
  <span class="va">options</span> <span class="op">=</span> <span class="cn">NULL</span>, 
  <span class="va">session</span> <span class="op">=</span> <span class="fu">shiny</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/shiny/man/domains.html">getDefaultReactiveDomain</a></span><span class="op">(</span><span class="op">)</span>
<span class="op">)</span> <span class="op">{</span>

  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span><span class="op">(</span><span class="va">options</span><span class="op">$</span><span class="va">icon</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">options</span><span class="op">$</span><span class="va">icon</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">options</span><span class="op">$</span><span class="va">icon</span><span class="op">)</span>
  <span class="op">}</span>

  <span class="va">message</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
    <span class="fu"><a href="https://rdrr.io/pkg/OSUICode/man/dropNulls.html">dropNulls</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>id <span class="op">=</span> <span class="va">session</span><span class="op">$</span><span class="fu">ns</span><span class="op">(</span><span class="va">id</span><span class="op">)</span>, text <span class="op">=</span> <span class="va">text</span><span class="op">)</span><span class="op">)</span>, 
    <span class="va">options</span>
  <span class="op">)</span>
  <span class="co"># see my-app.js function</span>
  <span class="va">session</span><span class="op">$</span><span class="fu">sendCustomMessage</span><span class="op">(</span><span class="st">"notification"</span>, <span class="va">message</span><span class="op">)</span>

<span class="op">}</span></code></pre></div>
<p>Pay attention to the <code>options$icon</code> element. As we canâ€™t convert shiny tags to <strong>JSON</strong>, it
must be converted to character first. If multiple parameters should contain tags,
you must treat them accordingly.</p>
</div>
<div id="mobile-widgets-initialize" class="section level2" number="25.3">
<h2>
<span class="header-section-number">25.3</span> Initialize the widget<a class="anchor" aria-label="anchor" href="#mobile-widgets-initialize"><i class="fas fa-link"></i></a>
</h2>
<p>On the JS side, we create a new script, <code>widgets.js</code>:</p>
<div class="sourceCode" id="cb947"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/RinteRface/charpente">charpente</a></span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/charpente/man/create_file.html">create_js</a></span><span class="op">(</span><span class="st">"widgets"</span><span class="op">)</span></code></pre></div>
<p>We set an array containing all compatible widget names in two categories and concatenate
in a <code>widgets</code> element:</p>
<div class="sourceCode" id="cb948"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb948-1"><a href="mobile-widgets.html#cb948-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> uiWidgets <span class="op">=</span> [<span class="st">"gauge"</span><span class="op">,</span> <span class="st">"swiper"</span><span class="op">,</span> <span class="st">"searchbar"</span>]<span class="op">;</span></span>
<span id="cb948-2"><a href="mobile-widgets.html#cb948-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> serverWidgets <span class="op">=</span> [<span class="st">"toast"</span><span class="op">,</span> <span class="st">"photoBrowser"</span><span class="op">,</span> <span class="st">"notification"</span>]<span class="op">;</span></span>
<span id="cb948-3"><a href="mobile-widgets.html#cb948-3" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> widgets <span class="op">=</span> uiWidgets<span class="op">.</span><span class="fu">concat</span>(serverWidgets)<span class="op">;</span></span></code></pre></div>
<p>Notice that as we are going to use the <code>app</code> object, we import them from the <code>init.js</code> script, located
in the same <code>./srcjs</code> folder.</p>
<p>We then define the <code>activateWidget</code> function, only considering UI widgets.</p>
<div class="sourceCode" id="cb949"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb949-1"><a href="mobile-widgets.html#cb949-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> activateWidget <span class="op">=</span> (widget) <span class="kw">=&gt;</span> {</span>
<span id="cb949-2"><a href="mobile-widgets.html#cb949-2" aria-hidden="true" tabindex="-1"></a> <span class="co">// function logic</span></span>
<span id="cb949-3"><a href="mobile-widgets.html#cb949-3" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<p>Since we have two widgets categories, this function first checks whether the widget is part of the <code>uiWidgets</code> array with <code>indexOf</code>:</p>
<div class="sourceCode" id="cb950"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb950-1"><a href="mobile-widgets.html#cb950-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> activateWidget <span class="op">=</span> (widget) <span class="kw">=&gt;</span> {</span>
<span id="cb950-2"><a href="mobile-widgets.html#cb950-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (uiWidgets<span class="op">.</span><span class="fu">indexOf</span>(widget) <span class="op">&gt;</span> <span class="op">-</span><span class="dv">1</span>) {</span>
<span id="cb950-3"><a href="mobile-widgets.html#cb950-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Init widget</span></span>
<span id="cb950-4"><a href="mobile-widgets.html#cb950-4" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb950-5"><a href="mobile-widgets.html#cb950-5" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<p>As there may be multiple widgets of the same type, we must loop through all
possible elements. This is where the class is important and must match the widget generic name.
For instance, the gauge has the <code>gauge</code> class and the methods are always <code>app.gauge.</code>.
How do we loop through multiple widgets? We use the jQuery <code>each</code> method:</p>
<div class="sourceCode" id="cb951"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb951-1"><a href="mobile-widgets.html#cb951-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> activateWidget <span class="op">=</span> (widget) <span class="kw">=&gt;</span> {</span>
<span id="cb951-2"><a href="mobile-widgets.html#cb951-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (uiWidgets<span class="op">.</span><span class="fu">indexOf</span>(widget) <span class="op">&gt;</span> <span class="op">-</span><span class="dv">1</span>) {</span>
<span id="cb951-3"><a href="mobile-widgets.html#cb951-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">$</span>(<span class="st">"."</span> <span class="op">+</span> widget)<span class="op">.</span><span class="fu">each</span>(<span class="kw">function</span>() {</span>
<span id="cb951-4"><a href="mobile-widgets.html#cb951-4" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Init widget</span></span>
<span id="cb951-5"><a href="mobile-widgets.html#cb951-5" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb951-6"><a href="mobile-widgets.html#cb951-6" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb951-7"><a href="mobile-widgets.html#cb951-7" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<p>We see that <code>$("." + widget)</code> gives <code>$(".gauge")</code> when the widget is a gauge, which
targets all gauges one by one. Then for each gauge, we extract the configuration containing
all options passed by the end user. Remember that each element has a unique id.
We extract the current element <code>$(this)</code> in the <code>$el</code> variable and search for a
script tag pointing to the unique tag having <code>$el.attr("id")</code> as id. The configuration is parsed
and converted to an object. Note that most of the time, Framework7 expects to have a <code>el</code>
attributes which simply contains the CSS selector of the current element,
in other words its unique id <code>'#' + $el.attr("id")</code>:</p>
<div class="sourceCode" id="cb952"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb952-1"><a href="mobile-widgets.html#cb952-1" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> $el <span class="op">=</span> <span class="fu">$</span>(<span class="kw">this</span>)<span class="op">;</span></span>
<span id="cb952-2"><a href="mobile-widgets.html#cb952-2" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> config <span class="op">=</span> <span class="fu">$</span>(<span class="bu">document</span>)<span class="op">.</span><span class="fu">find</span>(</span>
<span id="cb952-3"><a href="mobile-widgets.html#cb952-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">"script[data-for='"</span> <span class="op">+</span> $el<span class="op">.</span><span class="fu">attr</span>(<span class="st">"id"</span>) <span class="op">+</span> <span class="st">"']"</span></span>
<span id="cb952-4"><a href="mobile-widgets.html#cb952-4" aria-hidden="true" tabindex="-1"></a>)<span class="op">;</span></span>
<span id="cb952-5"><a href="mobile-widgets.html#cb952-5" aria-hidden="true" tabindex="-1"></a>config <span class="op">=</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">parse</span>(config<span class="op">.</span><span class="fu">html</span>())<span class="op">;</span></span>
<span id="cb952-6"><a href="mobile-widgets.html#cb952-6" aria-hidden="true" tabindex="-1"></a><span class="co">// add the id</span></span>
<span id="cb952-7"><a href="mobile-widgets.html#cb952-7" aria-hidden="true" tabindex="-1"></a>config<span class="op">.</span><span class="at">el</span> <span class="op">=</span> <span class="st">'#'</span> <span class="op">+</span> $el<span class="op">.</span><span class="fu">attr</span>(<span class="st">"id"</span>)<span class="op">;</span></span></code></pre></div>
<p>The final step consists in initializing the widget, which is quite straightforward if we notice that
<code>app.gauge</code> is the same as <code>app["gauge"]</code>. We obtain the general code:</p>
<div class="sourceCode" id="cb953"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb953-1"><a href="mobile-widgets.html#cb953-1" aria-hidden="true" tabindex="-1"></a>app[widget]<span class="op">.</span><span class="fu">create</span>(config)<span class="op">;</span></span></code></pre></div>
<p>For the server widgets, it is even simpler. We recover the message with a <code>Shiny.addCustomMessageHandler("type", callback)</code> and
initialize it. The only possible source of problem is the custom message <code>type</code> that must be the same
as the one specified in the R function with <code>session$sendCustomMessage("type", message)</code>. As shown in the below code, we can chain methods and immediately open the widget, right after its creation. Moreover, it is always good practice to let Shiny know about the widget state, that is whether it is currently opened. This is the reason why we added an <code>on</code> property to the message. All widgets trigger <a href="https://v5.framework7.io/docs/notification.html#dom-events">events</a>,
for instance notifications have the <code>notification:opened</code> and <code>notification:closed</code>. For each event, we set an input value on the fly, with <code>Shiny.setInputValue</code> as explained in Chapter <a href="shiny-input-system.html#quick-inputs">12.3</a>. This way, our future users can know exactly when the widget is closed or opened, thereby being able to trigger any subsequent action. This obviously requires the widget to pass an optional <code>id</code> attribute to ensure the uniqueness!</p>
<div class="sourceCode" id="cb954"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb954-1"><a href="mobile-widgets.html#cb954-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Server widget logic</span></span>
<span id="cb954-2"><a href="mobile-widgets.html#cb954-2" aria-hidden="true" tabindex="-1"></a>Shiny<span class="op">.</span><span class="fu">addCustomMessageHandler</span>(widget<span class="op">,</span> <span class="kw">function</span>(message) {</span>
<span id="cb954-3"><a href="mobile-widgets.html#cb954-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (message<span class="op">.</span><span class="at">id</span> <span class="op">!==</span> <span class="kw">undefined</span>) {</span>
<span id="cb954-4"><a href="mobile-widgets.html#cb954-4" aria-hidden="true" tabindex="-1"></a>    message<span class="op">.</span><span class="at">on</span> <span class="op">=</span> {</span>
<span id="cb954-5"><a href="mobile-widgets.html#cb954-5" aria-hidden="true" tabindex="-1"></a>      <span class="dt">opened</span><span class="op">:</span> <span class="kw">function</span>() {</span>
<span id="cb954-6"><a href="mobile-widgets.html#cb954-6" aria-hidden="true" tabindex="-1"></a>        Shiny<span class="op">.</span><span class="fu">setInputValue</span>(message<span class="op">.</span><span class="at">id</span><span class="op">,</span> <span class="kw">true</span>)<span class="op">;</span></span>
<span id="cb954-7"><a href="mobile-widgets.html#cb954-7" aria-hidden="true" tabindex="-1"></a>      }<span class="op">,</span></span>
<span id="cb954-8"><a href="mobile-widgets.html#cb954-8" aria-hidden="true" tabindex="-1"></a>      <span class="dt">closed</span><span class="op">:</span> <span class="kw">function</span>() {</span>
<span id="cb954-9"><a href="mobile-widgets.html#cb954-9" aria-hidden="true" tabindex="-1"></a>        Shiny<span class="op">.</span><span class="fu">setInputValue</span>(message<span class="op">.</span><span class="at">id</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb954-10"><a href="mobile-widgets.html#cb954-10" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb954-11"><a href="mobile-widgets.html#cb954-11" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span> </span>
<span id="cb954-12"><a href="mobile-widgets.html#cb954-12" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb954-13"><a href="mobile-widgets.html#cb954-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb954-14"><a href="mobile-widgets.html#cb954-14" aria-hidden="true" tabindex="-1"></a>  app[widget]<span class="op">.</span><span class="fu">create</span>(message)<span class="op">.</span><span class="fu">open</span>()<span class="op">;</span></span>
<span id="cb954-15"><a href="mobile-widgets.html#cb954-15" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<p>We create an <code>else</code> statement following the <code>if</code> condition (handling the UI widgets) and put the server widget logic inside:</p>
<div class="sourceCode" id="cb955"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb955-1"><a href="mobile-widgets.html#cb955-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> activateWidget <span class="op">=</span> (widget) <span class="kw">=&gt;</span> {</span>
<span id="cb955-2"><a href="mobile-widgets.html#cb955-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (uiWidgets<span class="op">.</span><span class="fu">indexOf</span>(widget) <span class="op">&gt;</span> <span class="op">-</span><span class="dv">1</span>) {</span>
<span id="cb955-3"><a href="mobile-widgets.html#cb955-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">// UI widget logic</span></span>
<span id="cb955-4"><a href="mobile-widgets.html#cb955-4" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb955-5"><a href="mobile-widgets.html#cb955-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Server widget logic</span></span>
<span id="cb955-6"><a href="mobile-widgets.html#cb955-6" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb955-7"><a href="mobile-widgets.html#cb955-7" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<p>The full JavaScript code may be found <a href="https://github.com/DivadNojnarg/outstanding-shiny-ui-code/blob/5bc49eab9496696a06da3f62d6aaf8ef468cdad4/srcjs/widgets.js#L7">here</a>.</p>
<p>The final step aims at activating all widgets. We proceed with a <code>forEach</code> loop:</p>
<div class="sourceCode" id="cb956"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb956-1"><a href="mobile-widgets.html#cb956-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Loop over all widgets to activate them</span></span>
<span id="cb956-2"><a href="mobile-widgets.html#cb956-2" aria-hidden="true" tabindex="-1"></a>widgets<span class="op">.</span><span class="fu">forEach</span>(<span class="kw">function</span>(w) {</span>
<span id="cb956-3"><a href="mobile-widgets.html#cb956-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">activateWidget</span>(w)<span class="op">;</span></span>
<span id="cb956-4"><a href="mobile-widgets.html#cb956-4" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<p>Letâ€™s try below with a notification example, where we capture the state of the notification in an input element. This allows to trigger another notification on the server side, in another <code><a href="https://rdrr.io/pkg/shiny/man/observeEvent.html">observeEvent()</a></code>.</p>
<div class="sourceCode" id="cb957"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">### RUN ### </span>
<span class="co"># OSUICode::run_example( </span>
<span class="co">#  "shinyMobile/notification" </span>
<span class="co">#   "package = "OSUICode" </span>
<span class="co"># ) </span>

<span class="co">### APP CODE ### </span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://shiny.rstudio.com/">shiny</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">OSUICode</span><span class="op">)</span>

<span class="va">ui</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/OSUICode/man/f7_page.html">f7_page</a></span><span class="op">(</span>
  allowPWA <span class="op">=</span> <span class="cn">FALSE</span>,
  navbar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/OSUICode/man/f7_navbar.html">f7_navbar</a></span><span class="op">(</span><span class="st">"Notifications"</span><span class="op">)</span>,
  toolbar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/OSUICode/man/f7_toolbar.html">f7_toolbar</a></span><span class="op">(</span><span class="op">)</span>,
  title <span class="op">=</span> <span class="st">"Notifications"</span>
<span class="op">)</span>

<span class="va">server</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">input</span>, <span class="va">output</span>, <span class="va">session</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/observeEvent.html">observeEvent</a></span><span class="op">(</span><span class="cn">TRUE</span>, once <span class="op">=</span> <span class="cn">TRUE</span>, <span class="op">{</span>
    <span class="fu"><a href="https://rdrr.io/pkg/OSUICode/man/f7_notif.html">f7_notif</a></span><span class="op">(</span>
      id <span class="op">=</span> <span class="st">"welcome"</span>,
      <span class="st">"Helloooooo"</span>,
      options <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>closeTimeout <span class="op">=</span> <span class="fl">2000</span><span class="op">)</span>
    <span class="op">)</span>
  <span class="op">}</span><span class="op">)</span>

  <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/observeEvent.html">observeEvent</a></span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">welcome</span>, <span class="op">{</span>
    <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/showNotification.html">showNotification</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span><span class="op">(</span><span class="st">"Notification is %s"</span>, <span class="va">input</span><span class="op">$</span><span class="va">welcome</span><span class="op">)</span><span class="op">)</span>
  <span class="op">}</span><span class="op">)</span>
<span class="op">}</span>

<span class="fu"><a href="https://rdrr.io/pkg/shiny/man/shinyApp.html">shinyApp</a></span><span class="op">(</span><span class="va">ui</span>, <span class="va">server</span><span class="op">)</span></code></pre></div>
<div class="figure">
<span style="display:block;" id="fig:mobile-shinyMobile-notification"></span>
<img src="images/mobile/mobile-shinymobile-notification.png" alt="Notification widget (top)." width="100%"><p class="caption">
FIGURE 25.2: Notification widget (top).
</p>
</div>
</div>
<div id="mobile-widgets-update" class="section level2" number="25.4">
<h2>
<span class="header-section-number">25.4</span> Update widgets<a class="anchor" aria-label="anchor" href="#mobile-widgets-update"><i class="fas fa-link"></i></a>
</h2>
<p>We would like to develop a similar generalized interface to update any element in the DOM. Instead of having a collection of function like <code>update_f7_gauge()</code> or <code>update_f7_swiper()</code>, we want a single <code><a href="https://rdrr.io/pkg/OSUICode/man/update_f7_instance.html">update_f7_instance()</a></code> function, which will be easier to maintain.</p>
<p>We leverage the <code>app.data</code> element (see Chapter <a href="mobile-shinyMobile.html#mobile-global-data">23.5.6</a>) to store all instances by widget type. Inside <code>helper_config.js</code>, we add a empty gauge array to <code>config.data</code>:</p>
<div class="sourceCode" id="cb958"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb958-1"><a href="mobile-widgets.html#cb958-1" aria-hidden="true" tabindex="-1"></a>config<span class="op">.</span><span class="at">data</span> <span class="op">=</span> <span class="kw">function</span>() {</span>
<span id="cb958-2"><a href="mobile-widgets.html#cb958-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> {</span>
<span id="cb958-3"><a href="mobile-widgets.html#cb958-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">// any other widget type to cache ...</span></span>
<span id="cb958-4"><a href="mobile-widgets.html#cb958-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">gauge</span><span class="op">:</span> []</span>
<span id="cb958-5"><a href="mobile-widgets.html#cb958-5" aria-hidden="true" tabindex="-1"></a>  }<span class="op">;</span></span>
<span id="cb958-6"><a href="mobile-widgets.html#cb958-6" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<p>The array name must be the same as the app method. For instance,
we have <code>app.gauge</code>, which means that we should create <code>config.data.gauge</code> and not <code>config.data.gauges</code>, as it would lead to errors later.</p>
<p>Once the cache is available, we have to modify the JavaScript that creates the widget instance,
to store the new instance in the cache, as shown Figure <a href="mobile-widgets.html#fig:mobile-widget-store">25.3</a>. We add the following code, where <code>w</code> refers to the widget instance:</p>
<div class="sourceCode" id="cb959"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb959-1"><a href="mobile-widgets.html#cb959-1" aria-hidden="true" tabindex="-1"></a><span class="co">// ui widgets</span></span>
<span id="cb959-2"><a href="mobile-widgets.html#cb959-2" aria-hidden="true" tabindex="-1"></a>app<span class="op">.</span><span class="at">data</span>[widget][$el<span class="op">.</span><span class="fu">attr</span>(<span class="st">"id"</span>)] <span class="op">=</span> w<span class="op">;</span></span></code></pre></div>
<div class="noteblock">
<p>This manipulation does not make sense for server widgets
as they are already generated by the server.</p>
</div>
<p>The <code>activateWidget</code> function should be:</p>
<div class="sourceCode" id="cb960"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb960-1"><a href="mobile-widgets.html#cb960-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Instantiate a widget</span></span>
<span id="cb960-2"><a href="mobile-widgets.html#cb960-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> activateWidget <span class="op">=</span> (widget) <span class="kw">=&gt;</span> {</span>
<span id="cb960-3"><a href="mobile-widgets.html#cb960-3" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Handle ui side widgets</span></span>
<span id="cb960-4"><a href="mobile-widgets.html#cb960-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (uiWidgets<span class="op">.</span><span class="fu">indexOf</span>(widget) <span class="op">&gt;</span> <span class="op">-</span><span class="dv">1</span>) {</span>
<span id="cb960-5"><a href="mobile-widgets.html#cb960-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">$</span>(<span class="st">"."</span> <span class="op">+</span> widget)<span class="op">.</span><span class="fu">each</span>(<span class="kw">function</span>() {</span>
<span id="cb960-6"><a href="mobile-widgets.html#cb960-6" aria-hidden="true" tabindex="-1"></a>      <span class="co">// unchanged</span></span>
<span id="cb960-7"><a href="mobile-widgets.html#cb960-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb960-8"><a href="mobile-widgets.html#cb960-8" aria-hidden="true" tabindex="-1"></a>      <span class="co">// feed the create method</span></span>
<span id="cb960-9"><a href="mobile-widgets.html#cb960-9" aria-hidden="true" tabindex="-1"></a>      <span class="kw">let</span> w <span class="op">=</span> app[widget]<span class="op">.</span><span class="fu">create</span>(config)<span class="op">;</span></span>
<span id="cb960-10"><a href="mobile-widgets.html#cb960-10" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Store the widget instance in the app data cache</span></span>
<span id="cb960-11"><a href="mobile-widgets.html#cb960-11" aria-hidden="true" tabindex="-1"></a>      app<span class="op">.</span><span class="at">data</span>[widget][$el<span class="op">.</span><span class="fu">attr</span>(<span class="st">"id"</span>)] <span class="op">=</span> w<span class="op">;</span></span>
<span id="cb960-12"><a href="mobile-widgets.html#cb960-12" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb960-13"><a href="mobile-widgets.html#cb960-13" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb960-14"><a href="mobile-widgets.html#cb960-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Server widgets logic</span></span>
<span id="cb960-15"><a href="mobile-widgets.html#cb960-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Unchanged</span></span>
<span id="cb960-16"><a href="mobile-widgets.html#cb960-16" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb960-17"><a href="mobile-widgets.html#cb960-17" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<p>Once done, this is time to design <code><a href="https://rdrr.io/pkg/OSUICode/man/update_f7_instance.html">update_f7_instance()</a></code>. The R code sends a message to
the current session containing:</p>
<ul>
<li>The <strong>id</strong> of the element to update.</li>
<li>The new <strong>configuration</strong>.</li>
</ul>
<p>Since we send a <strong>JSON</strong>, the hardest part is to correctly process shiny tags. How do we track shiny tags? As a reminder, letâ€™s run the code below:</p>
<div class="sourceCode" id="cb961"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="fu">shiny</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/htmltools/man/builder.html">div</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>#&gt; [1] "shiny.tag"</code></pre>
<div class="sourceCode" id="cb963"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="fu">shiny</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/htmltools/man/tagList.html">tagList</a></span><span class="op">(</span><span class="fu">shiny</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/htmltools/man/builder.html">div</a></span><span class="op">(</span><span class="op">)</span>, <span class="fu">shiny</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/htmltools/man/builder.html">h1</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>#&gt; [1] "shiny.tag.list" "list"</code></pre>
<p>For each configuration element, we must check whether its class contains <code>shiny.tag</code> or <code>shiny.tag.list</code> and convert it to a character. Moreover, it may contain a nested list, like this:</p>
<div class="sourceCode" id="cb965"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">options</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
  buttons <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
   <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
     text <span class="op">=</span> <span class="st">"Some text"</span>,
     icon <span class="op">=</span> <span class="fu"><a href="https://rinterface.github.io/shinyMobile/reference/f7Icon.html">f7Icon</a></span><span class="op">(</span><span class="st">"info"</span><span class="op">)</span>,
     color <span class="op">=</span> <span class="st">"pink"</span>
   <span class="op">)</span>
  <span class="op">)</span>
<span class="op">)</span></code></pre></div>
<p>In that case, our function must be <strong>recursive</strong> to handle any item having the <code>list</code> class. If the element is simple text or numeric, we return it as is.</p>
<p>We finally get:</p>
<div class="sourceCode" id="cb966"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">update_f7_instance</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span>
  <span class="va">id</span>, 
  <span class="va">options</span>, 
  <span class="va">session</span> <span class="op">=</span> <span class="fu">shiny</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/shiny/man/domains.html">getDefaultReactiveDomain</a></span><span class="op">(</span><span class="op">)</span>
<span class="op">)</span> <span class="op">{</span>

  <span class="co"># Convert any shiny tag into character so that toJSON </span>
  <span class="co"># does not cry</span>
  <span class="va">listRenderTags</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">l</span><span class="op">)</span> <span class="op">{</span>
    <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span>
      X <span class="op">=</span> <span class="va">l</span>,
      <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span>
        <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/class.html">inherits</a></span><span class="op">(</span><span class="va">x</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"shiny.tag"</span>, <span class="st">"shiny.tag.list"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
          <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
        <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/class.html">inherits</a></span><span class="op">(</span><span class="va">x</span>, <span class="st">"list"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
          <span class="co"># Recursive part</span>
          <span class="fu">listRenderTags</span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
        <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
          <span class="va">x</span>
        <span class="op">}</span>
      <span class="op">}</span>
    <span class="op">)</span>
  <span class="op">}</span>
  <span class="va">options</span> <span class="op">&lt;-</span> <span class="fu">listRenderTags</span><span class="op">(</span><span class="va">options</span><span class="op">)</span>

  <span class="va">message</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>id <span class="op">=</span> <span class="va">session</span><span class="op">$</span><span class="fu">ns</span><span class="op">(</span><span class="va">id</span><span class="op">)</span>, options <span class="op">=</span> <span class="va">options</span><span class="op">)</span>
  <span class="va">session</span><span class="op">$</span><span class="fu">sendCustomMessage</span><span class="op">(</span><span class="st">"update-instance"</span>, <span class="va">message</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>On the JS side, we receive the message, still in the <code>widget.js</code> script:</p>
<div class="sourceCode" id="cb967"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb967-1"><a href="mobile-widgets.html#cb967-1" aria-hidden="true" tabindex="-1"></a>Shiny<span class="op">.</span><span class="fu">addCustomMessageHandler</span>(</span>
<span id="cb967-2"><a href="mobile-widgets.html#cb967-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">'update-instance'</span><span class="op">,</span> </span>
<span id="cb967-3"><a href="mobile-widgets.html#cb967-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">function</span>(message) {</span>
<span id="cb967-4"><a href="mobile-widgets.html#cb967-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Treat message ...</span></span>
<span id="cb967-5"><a href="mobile-widgets.html#cb967-5" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb967-6"><a href="mobile-widgets.html#cb967-6" aria-hidden="true" tabindex="-1"></a>)<span class="op">;</span></span></code></pre></div>
<p>All widgets are stored by <strong>type</strong> in the app data, for instance, the element having for unique id
<code>mygauge</code> is located in <code>app.data["gauge"]["mygauge"]</code>. As there is no easy way to recover the widget type given its id, the first step of the message handler is to find where our instance is located. We design a nested <strong>for</strong> loop. The outer loop scans all <code>app.data</code> <strong>properties</strong> (ie widget categories), while the inner loop scans all existing instances for each category. Whenever, the <code>message.id</code> matches the instance name, we store the corresponding widget category in a variable:</p>
<div class="sourceCode" id="cb968"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb968-1"><a href="mobile-widgets.html#cb968-1" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> instanceFamily<span class="op">;</span></span>
<span id="cb968-2"><a href="mobile-widgets.html#cb968-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (<span class="kw">const</span> property <span class="kw">in</span> app<span class="op">.</span><span class="at">data</span>) {</span>
<span id="cb968-3"><a href="mobile-widgets.html#cb968-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (<span class="kw">const</span> e <span class="kw">in</span> app<span class="op">.</span><span class="at">data</span>[property]) {</span>
<span id="cb968-4"><a href="mobile-widgets.html#cb968-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (e <span class="op">===</span> message<span class="op">.</span><span class="at">id</span>) {</span>
<span id="cb968-5"><a href="mobile-widgets.html#cb968-5" aria-hidden="true" tabindex="-1"></a>      instanceFamily <span class="op">=</span> property<span class="op">;</span></span>
<span id="cb968-6"><a href="mobile-widgets.html#cb968-6" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb968-7"><a href="mobile-widgets.html#cb968-7" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb968-8"><a href="mobile-widgets.html#cb968-8" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>We then access the old instance using the newly defined variable and the <code>message.id</code>.
We capture its parameters located in <code>oldInstance.params</code>. From there, multiple options are available:</p>
<ul>
<li>We extend the old configuration with the new one.</li>
<li>We entirely overwrite the existing options.</li>
</ul>
<p>In what follows, we decided to merge the old and new configurations using <code>app.utils.extend</code>:</p>
<div class="sourceCode" id="cb969"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb969-1"><a href="mobile-widgets.html#cb969-1" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> oldInstance <span class="op">=</span> app<span class="op">.</span><span class="at">data</span>[instanceFamily][message<span class="op">.</span><span class="at">id</span>]<span class="op">;</span></span>
<span id="cb969-2"><a href="mobile-widgets.html#cb969-2" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> oldConfig <span class="op">=</span> oldInstance<span class="op">.</span><span class="at">params</span><span class="op">;</span></span>
<span id="cb969-3"><a href="mobile-widgets.html#cb969-3" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> newConfig <span class="op">=</span> app<span class="op">.</span><span class="at">utils</span><span class="op">.</span><span class="fu">extend</span>(oldConfig<span class="op">,</span>  message<span class="op">.</span><span class="at">options</span>)<span class="op">;</span></span></code></pre></div>
<p>The next steps consist of destroying the old instance, initializing the new instance, and refreshing
the <code>app.data</code> cache:</p>
<div class="sourceCode" id="cb970"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb970-1"><a href="mobile-widgets.html#cb970-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Destroy old instance</span></span>
<span id="cb970-2"><a href="mobile-widgets.html#cb970-2" aria-hidden="true" tabindex="-1"></a>oldInstance<span class="op">.</span><span class="fu">destroy</span>()<span class="op">;</span></span>
<span id="cb970-3"><a href="mobile-widgets.html#cb970-3" aria-hidden="true" tabindex="-1"></a><span class="co">// Create new config</span></span>
<span id="cb970-4"><a href="mobile-widgets.html#cb970-4" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> newInstance <span class="op">=</span> app[instanceFamily]<span class="op">.</span><span class="fu">create</span>(newConfig)<span class="op">;</span></span>
<span id="cb970-5"><a href="mobile-widgets.html#cb970-5" aria-hidden="true" tabindex="-1"></a><span class="co">// Update app data</span></span>
<span id="cb970-6"><a href="mobile-widgets.html#cb970-6" aria-hidden="true" tabindex="-1"></a>app<span class="op">.</span><span class="at">data</span>[instanceFamily][message<span class="op">.</span><span class="at">id</span>] <span class="op">=</span> newInstance<span class="op">;</span></span></code></pre></div>
<p>The whole code can be found <a href="https://github.com/DivadNojnarg/outstanding-shiny-ui-code/blob/5bc49eab9496696a06da3f62d6aaf8ef468cdad4/srcjs/widgets.js#L55">here</a>.
The update concept is illustrated Figure <a href="mobile-widgets.html#fig:mobile-widget-store">25.3</a>.</p>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:mobile-widget-store"></span>
<img src="images/mobile/mobile-widget-store.png" alt="Initializing and updating widgets in the app.data store." width="100%"><p class="caption">
FIGURE 25.3: Initializing and updating widgets in the app.data store.
</p>
</div>
<p>The code below is an example showing how to update a gauge from the server (Figure <a href="mobile-widgets.html#fig:mobile-widget-update-gauge">25.4</a>). As you may notice, this
approach is not perfect as the user has to explicitly update the <code>valueText</code> field so that
it reflects the new value. Similarly, you may ask why the gauge value has to be between 0 and 1,
instead of 0 and 100. The reason comes from the Framework7 API. One might be tempted to convert the value inside <code><a href="https://rdrr.io/pkg/OSUICode/man/f7_gauge.html">f7_gauge()</a></code> (so that the user only provides number between 0 and 100), but
this would also mean to manually convert the value in the <code><a href="https://rdrr.io/pkg/OSUICode/man/update_f7_instance.html">update_f7_instance()</a></code> function later. As stated in previous chapters, there is always a compromise between a simple API that is easy for the developer to maintain and the userâ€™s experience. This issue may/should be solved with comprehensive documentation.</p>
<div class="sourceCode" id="cb971"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">### RUN ### </span>
<span class="co"># OSUICode::run_example( </span>
<span class="co">#  "shinyMobile/update-gauge" </span>
<span class="co">#   "package = "OSUICode" </span>
<span class="co"># ) </span>

<span class="co">### APP CODE ### </span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://shiny.rstudio.com/">shiny</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">OSUICode</span><span class="op">)</span>

<span class="va">ui</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/OSUICode/man/f7_page.html">f7_page</a></span><span class="op">(</span>
  allowPWA <span class="op">=</span> <span class="cn">FALSE</span>,
  <span class="fu"><a href="https://rdrr.io/pkg/htmltools/man/builder.html">div</a></span><span class="op">(</span>
    class <span class="op">=</span> <span class="st">"block"</span>,
    <span class="fu"><a href="https://rdrr.io/pkg/OSUICode/man/f7_gauge.html">f7_gauge</a></span><span class="op">(</span>
      <span class="st">"mygauge"</span>,
      value <span class="op">=</span> <span class="fl">0.1</span>,
      options <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
        type  <span class="op">=</span> <span class="st">"semicircle"</span>,
        borderColor <span class="op">=</span> <span class="st">"#2196f3"</span>,
        borderWidth <span class="op">=</span> <span class="fl">10</span>,
        valueFontSize <span class="op">=</span> <span class="fl">41</span>,
        valueTextColor <span class="op">=</span> <span class="st">"#2196f3"</span>,
        labelText <span class="op">=</span> <span class="st">"amount of something"</span>
      <span class="op">)</span>
    <span class="op">)</span>
  <span class="op">)</span>,
  navbar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/OSUICode/man/f7_navbar.html">f7_navbar</a></span><span class="op">(</span><span class="st">"Update gauge instance"</span><span class="op">)</span>,
  toolbar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/OSUICode/man/f7_toolbar.html">f7_toolbar</a></span><span class="op">(</span><span class="op">)</span>,
  title <span class="op">=</span> <span class="st">"shinyMobile"</span>
<span class="op">)</span>

<span class="va">server</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">input</span>, <span class="va">output</span>, <span class="va">session</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/observeEvent.html">observeEvent</a></span><span class="op">(</span><span class="cn">TRUE</span>, once <span class="op">=</span> <span class="cn">TRUE</span>, <span class="op">{</span>
    <span class="fu"><a href="https://rdrr.io/r/base/Sys.sleep.html">Sys.sleep</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/pkg/OSUICode/man/update_f7_instance.html">update_f7_instance</a></span><span class="op">(</span>
      <span class="st">"mygauge"</span>,
      options <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
        value <span class="op">=</span> <span class="fl">0.75</span>,
        valueText <span class="op">=</span> <span class="st">"75 %"</span>,
        labelText <span class="op">=</span> <span class="st">"New label!"</span>
      <span class="op">)</span>
    <span class="op">)</span>
  <span class="op">}</span><span class="op">)</span>
<span class="op">}</span>

<span class="fu"><a href="https://rdrr.io/pkg/shiny/man/shinyApp.html">shinyApp</a></span><span class="op">(</span><span class="va">ui</span>, <span class="va">server</span><span class="op">)</span></code></pre></div>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:mobile-widget-update-gauge"></span>
<img src="images/mobile/mobile-widget-update-gauge.png" alt="Update gauge on the server side. We inspect app.data.gauge within the JS console." width="100%"><p class="caption">
FIGURE 25.4: Update gauge on the server side. We inspect app.data.gauge within the JS console.
</p>
</div>
<div class="noteblock">
<p>If you donâ€™t see the <code>Install</code> button, copy over the <code>www</code> folder from your PWA app.</p>
</div>
</div>
<div id="more-complex-elements" class="section level2" number="25.5">
<h2>
<span class="header-section-number">25.5</span> More complex elements<a class="anchor" aria-label="anchor" href="#more-complex-elements"><i class="fas fa-link"></i></a>
</h2>
<p>We consider the <code>tooltip</code> <a href="https://v5.framework7.io/docs/tooltip.html">example</a>. A tooltip is a help text generally displayed on hover (or click) over a specific element. They are commonly used to improve user experience in all websites. Framework7 provides two tooltips APIs:</p>
<ul>
<li>A purely UI side API where the tooltip is attached to a tag.</li>
<li>A server side API where the tooltip is dynamically injected in the page content.</li>
</ul>
<p>While the first approach is obviously not interesting for us since it does not involve a single line of JS, the second approach heavily relies on the <code>app.data</code> object. This is the one we choose to study.</p>
<div id="add-a-tooltip" class="section level3" number="25.5.1">
<h3>
<span class="header-section-number">25.5.1</span> Add a tooltip<a class="anchor" aria-label="anchor" href="#add-a-tooltip"><i class="fas fa-link"></i></a>
</h3>
<p>In the following, we design the <code><a href="https://rdrr.io/pkg/OSUICode/man/add_f7_tooltip.html">add_f7_tooltip()</a></code> function that may be added right after the existing gauge and notification widgets. Since a tooltip is attached to a DOM element, <code><a href="https://rdrr.io/pkg/OSUICode/man/add_f7_tooltip.html">add_f7_tooltip()</a></code> must provide parameters to identify its target, that is either <strong>id</strong> or CSS <strong>selector</strong>, but not both. Therefore, we create a helper function, <code>validate_selector()</code>, that checks if the end user provides <code>id</code> or <code>selector</code>.</p>
<div class="sourceCode" id="cb972"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">validate_selector</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">id</span>, <span class="va">selector</span><span class="op">)</span> <span class="op">{</span>
  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span><span class="op">(</span><span class="va">id</span><span class="op">)</span> <span class="op">&amp;&amp;</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span><span class="op">(</span><span class="va">selector</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
    <span class="kw"><a href="https://rdrr.io/r/base/stop.html">stop</a></span><span class="op">(</span><span class="st">"Please choose either target or selector!"</span><span class="op">)</span>
  <span class="op">}</span>
<span class="op">}</span></code></pre></div>
<p><code>%OR%</code> ensures that we return <code>a</code> if not <code>NULL</code> otherwise <code>b</code>.</p>
<div class="sourceCode" id="cb973"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="st">"%OR%"</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">a</span>, <span class="va">b</span><span class="op">)</span> <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span><span class="op">(</span><span class="va">a</span><span class="op">)</span><span class="op">)</span> <span class="va">a</span> <span class="kw">else</span> <span class="va">b</span></code></pre></div>
<p><code><a href="https://rdrr.io/pkg/OSUICode/man/add_f7_tooltip.html">add_f7_tooltip()</a></code> sends the tooltip target as well a list of options to JS with the <code>add_tooltip</code> identifier.</p>
<div class="sourceCode" id="cb974"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">add_f7_tooltip</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span>
  <span class="va">id</span> <span class="op">=</span> <span class="cn">NULL</span>, 
  <span class="va">selector</span> <span class="op">=</span> <span class="cn">NULL</span>, 
  <span class="va">options</span>,
  <span class="va">session</span> <span class="op">=</span> <span class="fu">shiny</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/shiny/man/domains.html">getDefaultReactiveDomain</a></span><span class="op">(</span><span class="op">)</span>
<span class="op">)</span> <span class="op">{</span>
  <span class="co"># We use already defined popover functions</span>
  <span class="fu">validate_selector</span><span class="op">(</span><span class="va">id</span>, <span class="va">selector</span><span class="op">)</span>
  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span><span class="op">(</span><span class="va">id</span><span class="op">)</span><span class="op">)</span> <span class="va">id</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"#"</span>, <span class="va">session</span><span class="op">$</span><span class="fu">ns</span><span class="op">(</span><span class="va">id</span><span class="op">)</span><span class="op">)</span>
  <span class="va">options</span><span class="op">$</span><span class="va">targetEl</span> <span class="op">&lt;-</span> <span class="va">id</span> <span class="op">%OR%</span> <span class="va">selector</span>
  <span class="va">session</span><span class="op">$</span><span class="fu">sendCustomMessage</span><span class="op">(</span><span class="st">"add_tooltip"</span>, <span class="va">options</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>On the JS side within <code>widgets.js</code>, we recover the message by building a custom message handler with <code>Shiny.addCustomMessageHandler</code> pointing to <code>add_tooltip</code>. Again, if there is a mismatch between R and JS <strong>type</strong>, the API wonâ€™t work. Like all Framework7 widgets,
creating a tooltip is rather straightforward:</p>
<div class="sourceCode" id="cb975"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb975-1"><a href="mobile-widgets.html#cb975-1" aria-hidden="true" tabindex="-1"></a>Shiny<span class="op">.</span><span class="fu">addCustomMessageHandler</span>(<span class="st">'add_tooltip'</span><span class="op">,</span> <span class="kw">function</span>(message) {</span>
<span id="cb975-2"><a href="mobile-widgets.html#cb975-2" aria-hidden="true" tabindex="-1"></a>  app<span class="op">.</span><span class="at">tooltip</span><span class="op">.</span><span class="fu">create</span>(message)<span class="op">.</span><span class="fu">show</span>()<span class="op">;</span></span>
<span id="cb975-3"><a href="mobile-widgets.html#cb975-3" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<p>As mentioned earlier, this syntax is fine since <code>message</code> is a JSON element and we can also chain methods. There is however a problem: <code>add_tooltip</code> is fired
each time the user triggers a specific element on the R side. It means the tooltip <strong>instance</strong> is
created each time, which is not optimal. To fix this issue, we set a tooltips cache in the <code>app.data</code> object and accordingly modify <code>helpers_config.js</code>:</p>
<div class="sourceCode" id="cb976"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb976-1"><a href="mobile-widgets.html#cb976-1" aria-hidden="true" tabindex="-1"></a>config<span class="op">.</span><span class="at">data</span> <span class="op">=</span> <span class="kw">function</span>() {</span>
<span id="cb976-2"><a href="mobile-widgets.html#cb976-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> {</span>
<span id="cb976-3"><a href="mobile-widgets.html#cb976-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">gauge</span><span class="op">:</span> []<span class="op">,</span> </span>
<span id="cb976-4"><a href="mobile-widgets.html#cb976-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">tooltips</span><span class="op">:</span> []</span>
<span id="cb976-5"><a href="mobile-widgets.html#cb976-5" aria-hidden="true" tabindex="-1"></a>  }<span class="op">;</span></span>
<span id="cb976-6"><a href="mobile-widgets.html#cb976-6" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<p>We update the previous custom handler so that we:</p>
<ul>
<li>Check if the tooltip instance is already in the cached <code>app.data</code> before creating an instance. If is is already there, nothing has to be done.</li>
<li>Each time we create a new instance, we save it in the <code>app.data</code> cache to retrieve it later.</li>
</ul>
<div class="sourceCode" id="cb977"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb977-1"><a href="mobile-widgets.html#cb977-1" aria-hidden="true" tabindex="-1"></a>Shiny<span class="op">.</span><span class="fu">addCustomMessageHandler</span>(<span class="st">'add_tooltip'</span><span class="op">,</span> <span class="kw">function</span>(message) {</span>
<span id="cb977-2"><a href="mobile-widgets.html#cb977-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">// We store all created instances in app data so that we don't</span></span>
<span id="cb977-3"><a href="mobile-widgets.html#cb977-3" aria-hidden="true" tabindex="-1"></a>  <span class="co">// recreate them later if they exist ...</span></span>
<span id="cb977-4"><a href="mobile-widgets.html#cb977-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (app<span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="at">tooltips</span>[message<span class="op">.</span><span class="at">targetEl</span>] <span class="op">===</span> <span class="kw">undefined</span>) {</span>
<span id="cb977-5"><a href="mobile-widgets.html#cb977-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">// create instance</span></span>
<span id="cb977-6"><a href="mobile-widgets.html#cb977-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> t <span class="op">=</span> app<span class="op">.</span><span class="at">tooltip</span><span class="op">.</span><span class="fu">create</span>(message)<span class="op">;</span></span>
<span id="cb977-7"><a href="mobile-widgets.html#cb977-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Open tooltip</span></span>
<span id="cb977-8"><a href="mobile-widgets.html#cb977-8" aria-hidden="true" tabindex="-1"></a>    t<span class="op">.</span><span class="fu">show</span>()<span class="op">;</span></span>
<span id="cb977-9"><a href="mobile-widgets.html#cb977-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Storage in app data (tooltips array)</span></span>
<span id="cb977-10"><a href="mobile-widgets.html#cb977-10" aria-hidden="true" tabindex="-1"></a>    app<span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="at">tooltips</span>[message<span class="op">.</span><span class="at">targetEl</span>] <span class="op">=</span> t<span class="op">;</span></span>
<span id="cb977-11"><a href="mobile-widgets.html#cb977-11" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb977-12"><a href="mobile-widgets.html#cb977-12" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<p>We store the current instance with <code>app.data.tooltips[message.targetEl] = t;</code>.
The <strong>reference</strong> is given by <code>message.targetEl</code> that is the target to apply the tooltip on. When multiple tooltips are created, we may search for them by target name, which is a reasonable choice. For instance <code>app.data.tooltips["#mybutton"]</code> points to the tooltip associated to the element having <code>#mybutton</code> as id. So far so good!</p>
<div class="sourceCode" id="cb978"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">### RUN ### </span>
<span class="co"># OSUICode::run_example( </span>
<span class="co">#  "shinyMobile/add-tooltip" </span>
<span class="co">#   "package = "OSUICode" </span>
<span class="co"># ) </span>

<span class="co">### APP CODE ### </span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://shiny.rstudio.com/">shiny</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">OSUICode</span><span class="op">)</span>

<span class="va">shinyMobile_options</span><span class="op">$</span><span class="va">dark</span> <span class="op">&lt;-</span> <span class="cn">FALSE</span>

<span class="va">ui</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/OSUICode/man/f7_page.html">f7_page</a></span><span class="op">(</span>
  allowPWA <span class="op">=</span> <span class="cn">FALSE</span>,
  options <span class="op">=</span> <span class="va">shinyMobile_options</span>,
  <span class="va">tags</span><span class="op">$</span><span class="fu">div</span><span class="op">(</span>
    class <span class="op">=</span> <span class="st">"block"</span>,
    <span class="va">tags</span><span class="op">$</span><span class="fu">button</span><span class="op">(</span>
      id <span class="op">=</span> <span class="st">"mybutton"</span>,
      class <span class="op">=</span> <span class="st">"button button-large button-fill"</span>,
      <span class="st">"Click"</span>
    <span class="op">)</span>
  <span class="op">)</span>,
  navbar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/OSUICode/man/f7_navbar.html">f7_navbar</a></span><span class="op">(</span><span class="st">"Add tooltip"</span><span class="op">)</span>,
  toolbar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/OSUICode/man/f7_toolbar.html">f7_toolbar</a></span><span class="op">(</span><span class="op">)</span>,
  title <span class="op">=</span> <span class="st">"Notifications"</span>
<span class="op">)</span>

<span class="va">server</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">input</span>, <span class="va">output</span>, <span class="va">session</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/observeEvent.html">observeEvent</a></span><span class="op">(</span><span class="cn">TRUE</span>, once <span class="op">=</span> <span class="cn">TRUE</span>, <span class="op">{</span>
    <span class="fu"><a href="https://rdrr.io/pkg/OSUICode/man/add_f7_tooltip.html">add_f7_tooltip</a></span><span class="op">(</span>
      id <span class="op">=</span> <span class="st">"mybutton"</span>,
      options <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>text <span class="op">=</span> <span class="st">"This is a button"</span><span class="op">)</span>
    <span class="op">)</span>
  <span class="op">}</span><span class="op">)</span>
<span class="op">}</span>

<span class="fu"><a href="https://rdrr.io/pkg/shiny/man/shinyApp.html">shinyApp</a></span><span class="op">(</span><span class="va">ui</span>, <span class="va">server</span><span class="op">)</span></code></pre></div>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:mobile-widget-add-tooltip"></span>
<img src="images/mobile/mobile-widget-add-tooltip.png" alt="Create a tooltip on the server and attach it on a DOM element." width="50%"><p class="caption">
FIGURE 25.5: Create a tooltip on the server and attach it on a DOM element.
</p>
</div>
</div>
<div id="update-a-tooltip" class="section level3" number="25.5.2">
<h3>
<span class="header-section-number">25.5.2</span> Update a tooltip<a class="anchor" aria-label="anchor" href="#update-a-tooltip"><i class="fas fa-link"></i></a>
</h3>
<p>Framework7 does not provide any native <code>enable/disable</code> method, which means that once the tooltip is activated on a given element, it is visible forever (Figure <a href="mobile-widgets.html#fig:mobile-widget-add-tooltip">25.5</a>), unless destroyed.
The main purpose of <code><a href="https://rdrr.io/pkg/OSUICode/man/update_f7_tooltip.html">update_f7_tooltip()</a></code> is to avoid this, by temporarily disabling any tooltip and reactivating it later. Like for <code><a href="https://rdrr.io/pkg/OSUICode/man/add_f7_tooltip.html">add_f7_tooltip()</a></code>, we may target either by <code>id</code> or provide a more complex CSS selector. We support two actions: toggle the tooltip (enable/disable) and update, that is change data like the displayed text.</p>
<div class="sourceCode" id="cb979"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">update_f7_tooltip</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span>
  <span class="va">id</span> <span class="op">=</span> <span class="cn">NULL</span>, 
  <span class="va">selector</span> <span class="op">=</span> <span class="cn">NULL</span>,
  <span class="va">action</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"toggle"</span>, <span class="st">"update"</span><span class="op">)</span>, 
  <span class="va">text</span> <span class="op">=</span> <span class="cn">NULL</span>,
  <span class="va">session</span> <span class="op">=</span> <span class="fu">shiny</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/shiny/man/domains.html">getDefaultReactiveDomain</a></span><span class="op">(</span><span class="op">)</span>
<span class="op">)</span> <span class="op">{</span>
  <span class="fu">validate_selector</span><span class="op">(</span><span class="va">id</span>, <span class="va">selector</span><span class="op">)</span>
  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span><span class="op">(</span><span class="va">id</span><span class="op">)</span><span class="op">)</span> <span class="va">id</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"#"</span>, <span class="va">session</span><span class="op">$</span><span class="fu">ns</span><span class="op">(</span><span class="va">id</span><span class="op">)</span><span class="op">)</span>
  <span class="va">targetEl</span> <span class="op">&lt;-</span> <span class="va">id</span> <span class="op">%OR%</span> <span class="va">selector</span>
  <span class="va">message</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/OSUICode/man/dropNulls.html">dropNulls</a></span><span class="op">(</span>
    <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
      targetEl <span class="op">=</span> <span class="va">targetEl</span>, 
      action <span class="op">=</span> <span class="va">action</span>, 
      text <span class="op">=</span> <span class="va">text</span>
    <span class="op">)</span>
  <span class="op">)</span>
  <span class="va">session</span><span class="op">$</span><span class="fu">sendCustomMessage</span><span class="op">(</span><span class="st">"update_tooltip"</span>, <span class="va">message</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p><code>update_f_tooltip()</code> sends three elements to JS, namely the tooltip target element <code>message.targetEl</code>, the optional new text, that is <code>message.text</code> and the action to perform <code>message.action</code> (either update or toggle state).</p>
<p>The corresponding JS handler:</p>
<ul>
<li>Checks if the specified tooltip instance exists and only update if it is the case.</li>
<li>Handles two situations: update the tooltip content or toggle the tooltip visibility.
It is actually more than just showing/hiding the tooltip. Remember that each tooltip is shown
on hover so applying hide on a visible tooltip will only have effect until the user
hovers again over the same tooltip, which is useless.</li>
</ul>
<p>In <code>widgets.js</code>, right after the <code>add_tooltip</code> handler, we add the <code>update</code> logic, that consists in changing the text:</p>
<div class="sourceCode" id="cb980"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb980-1"><a href="mobile-widgets.html#cb980-1" aria-hidden="true" tabindex="-1"></a>Shiny<span class="op">.</span><span class="fu">addCustomMessageHandler</span>(</span>
<span id="cb980-2"><a href="mobile-widgets.html#cb980-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">'update_tooltip'</span><span class="op">,</span> <span class="kw">function</span>(message) {</span>
<span id="cb980-3"><a href="mobile-widgets.html#cb980-3" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Don't do anything if the instance is not there in app data</span></span>
<span id="cb980-4"><a href="mobile-widgets.html#cb980-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (app<span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="at">tooltips</span>[message<span class="op">.</span><span class="at">targetEl</span>] <span class="op">!==</span> <span class="kw">undefined</span>) {</span>
<span id="cb980-5"><a href="mobile-widgets.html#cb980-5" aria-hidden="true" tabindex="-1"></a>      <span class="kw">let</span> t <span class="op">=</span> app<span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="at">tooltips</span>[message<span class="op">.</span><span class="at">targetEl</span>]<span class="op">;</span></span>
<span id="cb980-6"><a href="mobile-widgets.html#cb980-6" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (message<span class="op">.</span><span class="at">action</span> <span class="op">===</span> <span class="st">"update"</span>) {</span>
<span id="cb980-7"><a href="mobile-widgets.html#cb980-7" aria-hidden="true" tabindex="-1"></a>        t<span class="op">.</span><span class="fu">setText</span>(message<span class="op">.</span><span class="at">text</span>)<span class="op">;</span></span>
<span id="cb980-8"><a href="mobile-widgets.html#cb980-8" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb980-9"><a href="mobile-widgets.html#cb980-9" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb980-10"><a href="mobile-widgets.html#cb980-10" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<p>The corresponding tooltip instance is accessed in <code>app.data</code> with <code>app.data.tooltips[message.targetEl]</code>
and stored in a local variable, <code>t</code>. We apply the Framework7 tooltip <a href="https://v5.framework7.io/docs/tooltip.html#tooltip-app-methods">method</a> <code>setText</code> only if the user action corresponds to <code>update</code>.</p>
<p>The next step is to handle the <code>toggle</code> case. We check whether the current instance is active applying the <code>app.tooltip.get</code> method on <code>message.targetEl</code>. If the instance is alive, we get an object, while we obtain undefined if it does not exist. We then call the <code>app.tooltip.destroy</code> method on the current instance:</p>
<div class="sourceCode" id="cb981"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb981-1"><a href="mobile-widgets.html#cb981-1" aria-hidden="true" tabindex="-1"></a>Shiny<span class="op">.</span><span class="fu">addCustomMessageHandler</span>(</span>
<span id="cb981-2"><a href="mobile-widgets.html#cb981-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">'update_tooltip'</span><span class="op">,</span> <span class="kw">function</span>(message) {</span>
<span id="cb981-3"><a href="mobile-widgets.html#cb981-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Don't do anything if the instance is not there in app data</span></span>
<span id="cb981-4"><a href="mobile-widgets.html#cb981-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (app<span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="at">tooltips</span>[message<span class="op">.</span><span class="at">targetEl</span>] <span class="op">!==</span> <span class="kw">undefined</span>) {</span>
<span id="cb981-5"><a href="mobile-widgets.html#cb981-5" aria-hidden="true" tabindex="-1"></a>      <span class="kw">let</span> t <span class="op">=</span> app<span class="op">.</span><span class="at">tooltip</span><span class="op">.</span><span class="fu">get</span>(message<span class="op">.</span><span class="at">targetEl</span>)<span class="op">;</span></span>
<span id="cb981-6"><a href="mobile-widgets.html#cb981-6" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (message<span class="op">.</span><span class="at">action</span> <span class="op">===</span> <span class="st">"update"</span>) {</span>
<span id="cb981-7"><a href="mobile-widgets.html#cb981-7" aria-hidden="true" tabindex="-1"></a>        t<span class="op">.</span><span class="fu">setText</span>(message<span class="op">.</span><span class="at">text</span>)<span class="op">;</span></span>
<span id="cb981-8"><a href="mobile-widgets.html#cb981-8" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> <span class="cf">if</span> (message<span class="op">.</span><span class="at">action</span> <span class="op">===</span> <span class="st">"toggle"</span>) {</span>
<span id="cb981-9"><a href="mobile-widgets.html#cb981-9" aria-hidden="true" tabindex="-1"></a>        <span class="co">// destroy</span></span>
<span id="cb981-10"><a href="mobile-widgets.html#cb981-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (t) {</span>
<span id="cb981-11"><a href="mobile-widgets.html#cb981-11" aria-hidden="true" tabindex="-1"></a>          t<span class="op">.</span><span class="fu">destroy</span>()<span class="op">;</span></span>
<span id="cb981-12"><a href="mobile-widgets.html#cb981-12" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb981-13"><a href="mobile-widgets.html#cb981-13" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb981-14"><a href="mobile-widgets.html#cb981-14" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb981-15"><a href="mobile-widgets.html#cb981-15" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<p>Wait a moment! There are two issues with this code. As <code>t</code> is a variable pointing
to the current instance, if we destroy that instance, <code>t</code> will point to a destroyed element the next time it is called, and any action like <code>setText</code> will raise an error. The trick is to create a shallow clone with <code>Object.assign</code> that wonâ€™t be affected by the <code>destroy</code> method, save the shallow clone in the <code>app.data</code> cache and destroy the old instance. Therefore we update the <code>tooltips.js</code> script:</p>
<div class="sourceCode" id="cb982"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb982-1"><a href="mobile-widgets.html#cb982-1" aria-hidden="true" tabindex="-1"></a>Shiny<span class="op">.</span><span class="fu">addCustomMessageHandler</span>(</span>
<span id="cb982-2"><a href="mobile-widgets.html#cb982-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">'update_tooltip'</span><span class="op">,</span> <span class="kw">function</span>(message) {</span>
<span id="cb982-3"><a href="mobile-widgets.html#cb982-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (app<span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="at">tooltips</span>[message<span class="op">.</span><span class="at">targetEl</span>] <span class="op">!==</span> <span class="kw">undefined</span>) {</span>
<span id="cb982-4"><a href="mobile-widgets.html#cb982-4" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Try to get the instance</span></span>
<span id="cb982-5"><a href="mobile-widgets.html#cb982-5" aria-hidden="true" tabindex="-1"></a>      <span class="kw">let</span> t <span class="op">=</span> app<span class="op">.</span><span class="at">tooltip</span><span class="op">.</span><span class="fu">get</span>(message<span class="op">.</span><span class="at">targetEl</span>)<span class="op">;</span></span>
<span id="cb982-6"><a href="mobile-widgets.html#cb982-6" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (message<span class="op">.</span><span class="at">action</span> <span class="op">===</span> <span class="st">"update"</span>) {</span>
<span id="cb982-7"><a href="mobile-widgets.html#cb982-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (t) {</span>
<span id="cb982-8"><a href="mobile-widgets.html#cb982-8" aria-hidden="true" tabindex="-1"></a>          t<span class="op">.</span><span class="fu">setText</span>(message<span class="op">.</span><span class="at">text</span>)<span class="op">;</span></span>
<span id="cb982-9"><a href="mobile-widgets.html#cb982-9" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb982-10"><a href="mobile-widgets.html#cb982-10" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> <span class="cf">if</span> (message<span class="op">.</span><span class="at">action</span> <span class="op">===</span> <span class="st">"toggle"</span>) {</span>
<span id="cb982-11"><a href="mobile-widgets.html#cb982-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (t) {</span>
<span id="cb982-12"><a href="mobile-widgets.html#cb982-12" aria-hidden="true" tabindex="-1"></a>          <span class="co">// create copy that won't be modified if </span></span>
<span id="cb982-13"><a href="mobile-widgets.html#cb982-13" aria-hidden="true" tabindex="-1"></a>          <span class="co">// t is destroyed!</span></span>
<span id="cb982-14"><a href="mobile-widgets.html#cb982-14" aria-hidden="true" tabindex="-1"></a>          <span class="kw">let</span> cachedTooltip <span class="op">=</span> <span class="bu">Object</span><span class="op">.</span><span class="fu">assign</span>({}<span class="op">,</span> t)<span class="op">;</span></span>
<span id="cb982-15"><a href="mobile-widgets.html#cb982-15" aria-hidden="true" tabindex="-1"></a>          <span class="co">// save copy to replace the deleted one in the app data</span></span>
<span id="cb982-16"><a href="mobile-widgets.html#cb982-16" aria-hidden="true" tabindex="-1"></a>          app<span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="at">tooltips</span>[message<span class="op">.</span><span class="at">targetEl</span>] <span class="op">=</span> cachedTooltip<span class="op">;</span></span>
<span id="cb982-17"><a href="mobile-widgets.html#cb982-17" aria-hidden="true" tabindex="-1"></a>          <span class="co">// destroy current instance</span></span>
<span id="cb982-18"><a href="mobile-widgets.html#cb982-18" aria-hidden="true" tabindex="-1"></a>          t<span class="op">.</span><span class="fu">destroy</span>()<span class="op">;</span></span>
<span id="cb982-19"><a href="mobile-widgets.html#cb982-19" aria-hidden="true" tabindex="-1"></a>        } </span>
<span id="cb982-20"><a href="mobile-widgets.html#cb982-20" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb982-21"><a href="mobile-widgets.html#cb982-21" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb982-22"><a href="mobile-widgets.html#cb982-22" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<p>We also check whether the instance is alive before updating it. We are still missing the <code>re-activation</code> step that consists in rebuilding the tooltip instance based on the cached data <code>app.data.tooltips[message.targetEl]</code> previously saved. All parameters are contained in the <code>params</code> object (instance element):</p>
<div class="sourceCode" id="cb983"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb983-1"><a href="mobile-widgets.html#cb983-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Capture parameters</span></span>
<span id="cb983-2"><a href="mobile-widgets.html#cb983-2" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> pars <span class="op">=</span> app<span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="at">tooltips</span>[message<span class="op">.</span><span class="at">targetEl</span>]<span class="op">.</span><span class="at">params</span><span class="op">;</span></span>
<span id="cb983-3"><a href="mobile-widgets.html#cb983-3" aria-hidden="true" tabindex="-1"></a><span class="co">// Recreate the tooltip based on the copy configuration</span></span>
<span id="cb983-4"><a href="mobile-widgets.html#cb983-4" aria-hidden="true" tabindex="-1"></a>t <span class="op">=</span> app<span class="op">.</span><span class="at">tooltip</span><span class="op">.</span><span class="fu">create</span>(pars)<span class="op">;</span></span>
<span id="cb983-5"><a href="mobile-widgets.html#cb983-5" aria-hidden="true" tabindex="-1"></a><span class="co">// Replace the app data instance</span></span>
<span id="cb983-6"><a href="mobile-widgets.html#cb983-6" aria-hidden="true" tabindex="-1"></a>app<span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="at">tooltips</span>[message<span class="op">.</span><span class="at">targetEl</span>] <span class="op">=</span> t<span class="op">;</span></span></code></pre></div>
<p>The final JS code is:</p>
<div class="sourceCode" id="cb984"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb984-1"><a href="mobile-widgets.html#cb984-1" aria-hidden="true" tabindex="-1"></a>Shiny<span class="op">.</span><span class="fu">addCustomMessageHandler</span>(</span>
<span id="cb984-2"><a href="mobile-widgets.html#cb984-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">'update_tooltip'</span><span class="op">,</span> <span class="kw">function</span>(message) {</span>
<span id="cb984-3"><a href="mobile-widgets.html#cb984-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (app<span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="at">tooltips</span>[message<span class="op">.</span><span class="at">targetEl</span>] <span class="op">!==</span> <span class="kw">undefined</span>) {</span>
<span id="cb984-4"><a href="mobile-widgets.html#cb984-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Unchanged</span></span>
<span id="cb984-5"><a href="mobile-widgets.html#cb984-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (message<span class="op">.</span><span class="at">action</span> <span class="op">===</span> <span class="st">"update"</span>) {</span>
<span id="cb984-6"><a href="mobile-widgets.html#cb984-6" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Unchanged</span></span>
<span id="cb984-7"><a href="mobile-widgets.html#cb984-7" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> <span class="cf">if</span> (message<span class="op">.</span><span class="at">action</span> <span class="op">===</span> <span class="st">"toggle"</span>) {</span>
<span id="cb984-8"><a href="mobile-widgets.html#cb984-8" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (t) {</span>
<span id="cb984-9"><a href="mobile-widgets.html#cb984-9" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Unchanged</span></span>
<span id="cb984-10"><a href="mobile-widgets.html#cb984-10" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb984-11"><a href="mobile-widgets.html#cb984-11" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Capture parameters</span></span>
<span id="cb984-12"><a href="mobile-widgets.html#cb984-12" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> pars <span class="op">=</span> app<span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="at">tooltips</span>[message<span class="op">.</span><span class="at">targetEl</span>]<span class="op">.</span><span class="at">params</span><span class="op">;</span></span>
<span id="cb984-13"><a href="mobile-widgets.html#cb984-13" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Recreate the tooltip based on the copy configuration</span></span>
<span id="cb984-14"><a href="mobile-widgets.html#cb984-14" aria-hidden="true" tabindex="-1"></a>        t <span class="op">=</span> app<span class="op">.</span><span class="at">tooltip</span><span class="op">.</span><span class="fu">create</span>(pars)<span class="op">;</span></span>
<span id="cb984-15"><a href="mobile-widgets.html#cb984-15" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Replace the app data instance</span></span>
<span id="cb984-16"><a href="mobile-widgets.html#cb984-16" aria-hidden="true" tabindex="-1"></a>        app<span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="at">tooltips</span>[message<span class="op">.</span><span class="at">targetEl</span>] <span class="op">=</span> t<span class="op">;</span></span>
<span id="cb984-17"><a href="mobile-widgets.html#cb984-17" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb984-18"><a href="mobile-widgets.html#cb984-18" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb984-19"><a href="mobile-widgets.html#cb984-19" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb984-20"><a href="mobile-widgets.html#cb984-20" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<p>You may find an example below.</p>
<div class="sourceCode" id="cb985"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">### RUN ### </span>
<span class="co"># OSUICode::run_example( </span>
<span class="co">#  "shinyMobile/update-tooltip" </span>
<span class="co">#   "package = "OSUICode" </span>
<span class="co"># ) </span>

<span class="co">### APP CODE ### </span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://shiny.rstudio.com/">shiny</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">OSUICode</span><span class="op">)</span>

<span class="va">shinyMobile_options</span><span class="op">$</span><span class="va">dark</span> <span class="op">&lt;-</span> <span class="cn">FALSE</span>

<span class="va">ui</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/OSUICode/man/f7_page.html">f7_page</a></span><span class="op">(</span>
  allowPWA <span class="op">=</span> <span class="cn">FALSE</span>,
  options <span class="op">=</span> <span class="va">shinyMobile_options</span>,
  <span class="va">tags</span><span class="op">$</span><span class="fu">div</span><span class="op">(</span>
    class <span class="op">=</span> <span class="st">"block"</span>,
    <span class="va">tags</span><span class="op">$</span><span class="fu">button</span><span class="op">(</span>
      id <span class="op">=</span> <span class="st">"mybutton"</span>,
      class <span class="op">=</span> <span class="st">"button button-large button-fill action-button"</span>,
      <span class="st">"Click"</span>
    <span class="op">)</span>,
    <span class="va">tags</span><span class="op">$</span><span class="fu">label</span><span class="op">(</span>
      class <span class="op">=</span> <span class="st">"toggle"</span>,
      <span class="va">tags</span><span class="op">$</span><span class="fu">input</span><span class="op">(</span>type <span class="op">=</span> <span class="st">"checkbox"</span>, id <span class="op">=</span> <span class="st">"enable"</span><span class="op">)</span>,
      <span class="va">tags</span><span class="op">$</span><span class="fu">span</span><span class="op">(</span>class <span class="op">=</span> <span class="st">"toggle-icon"</span><span class="op">)</span>
    <span class="op">)</span>
  <span class="op">)</span>,
  navbar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/OSUICode/man/f7_navbar.html">f7_navbar</a></span><span class="op">(</span><span class="st">"Add tooltip"</span><span class="op">)</span>,
  toolbar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/OSUICode/man/f7_toolbar.html">f7_toolbar</a></span><span class="op">(</span><span class="op">)</span>,
  title <span class="op">=</span> <span class="st">"Notifications"</span>
<span class="op">)</span>

<span class="va">server</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">input</span>, <span class="va">output</span>, <span class="va">session</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/observeEvent.html">observeEvent</a></span><span class="op">(</span><span class="cn">TRUE</span>, once <span class="op">=</span> <span class="cn">TRUE</span>, <span class="op">{</span>
    <span class="fu"><a href="https://rdrr.io/pkg/OSUICode/man/add_f7_tooltip.html">add_f7_tooltip</a></span><span class="op">(</span>
      id <span class="op">=</span> <span class="st">"mybutton"</span>,
      options <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>text <span class="op">=</span> <span class="st">"This is a button"</span><span class="op">)</span>
    <span class="op">)</span>
  <span class="op">}</span><span class="op">)</span>

  <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/observeEvent.html">observeEvent</a></span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">enable</span>, <span class="op">{</span>
    <span class="fu"><a href="https://rdrr.io/pkg/OSUICode/man/update_f7_tooltip.html">update_f7_tooltip</a></span><span class="op">(</span>
      id <span class="op">=</span> <span class="st">"mybutton"</span>,
      action <span class="op">=</span> <span class="st">"toggle"</span>
    <span class="op">)</span>
  <span class="op">}</span><span class="op">)</span>

  <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/observeEvent.html">observeEvent</a></span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">mybutton</span>, <span class="op">{</span>
    <span class="fu"><a href="https://rdrr.io/pkg/OSUICode/man/update_f7_tooltip.html">update_f7_tooltip</a></span><span class="op">(</span>
      id <span class="op">=</span> <span class="st">"mybutton"</span>,
      action <span class="op">=</span> <span class="st">"update"</span>,
      text <span class="op">=</span> <span class="st">"New tooltip text"</span>
    <span class="op">)</span>
  <span class="op">}</span><span class="op">)</span>
<span class="op">}</span>

<span class="fu"><a href="https://rdrr.io/pkg/shiny/man/shinyApp.html">shinyApp</a></span><span class="op">(</span><span class="va">ui</span>, <span class="va">server</span><span class="op">)</span></code></pre></div>

</div>
</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="mobile-pwa.html"><span class="header-section-number">24</span> {shinyMobile} and PWA</a></div>
<div class="next"><a href="mobile-going-further.html"><span class="header-section-number">26</span> Fine tune {shinyMobile}</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#mobile-widgets"><span class="header-section-number">25</span> Design widgets</a></li>
<li><a class="nav-link" href="#build-the-ui"><span class="header-section-number">25.1</span> Build the UI</a></li>
<li><a class="nav-link" href="#widgets-without-preexisting-ui"><span class="header-section-number">25.2</span> Widgets without preexisting UI</a></li>
<li><a class="nav-link" href="#mobile-widgets-initialize"><span class="header-section-number">25.3</span> Initialize the widget</a></li>
<li><a class="nav-link" href="#mobile-widgets-update"><span class="header-section-number">25.4</span> Update widgets</a></li>
<li>
<a class="nav-link" href="#more-complex-elements"><span class="header-section-number">25.5</span> More complex elements</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#add-a-tooltip"><span class="header-section-number">25.5.1</span> Add a tooltip</a></li>
<li><a class="nav-link" href="#update-a-tooltip"><span class="header-section-number">25.5.2</span> Update a tooltip</a></li>
</ul>
</li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/DivadNojnarg/outstanding-shiny-ui/blob/master/mobile-widgets.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/DivadNojnarg/outstanding-shiny-ui/edit/master/mobile-widgets.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Outstanding User Interfaces with Shiny</strong>" was written by David Granjon. It was last built on 2021-10-13.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
