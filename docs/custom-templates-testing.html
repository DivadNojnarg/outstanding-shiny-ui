<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Chapter 20 Testing and validating templates elements | Outstanding User Interfaces with Shiny</title>
<meta name="author" content="David Granjon">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.2"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.5.1/jquery-3.5.1.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.2.5.9002/transition.js"></script><script src="libs/bs3compat-0.2.5.9002/tabs.js"></script><script src="libs/bs3compat-0.2.5.9002/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="libs/accessible-code-block-0.0.1/empty-anchor.js"></script><script src="https://cdn.jsdelivr.net/autocomplete.js/0/autocomplete.jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/mark.js@8.11.1/dist/mark.min.js"></script><!-- CSS --><link rel="stylesheet" href="css/style.css">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">Outstanding User Interfaces with Shiny</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">Welcome</a></li>
<li><a class="" href="foreword.html">Foreword</a></li>
<li class="book-part">Introduction</li>
<li><a class="" href="web-intro.html"><span class="header-section-number">1</span> Shiny and the Web</a></li>
<li><a class="" href="htmltools-overview.html"><span class="header-section-number">2</span> Mastering {htmltools}</a></li>
<li><a class="" href="web-dependencies.html"><span class="header-section-number">3</span> Discover Shiny dependencies</a></li>
<li><a class="" href="htmltools-dependencies.html"><span class="header-section-number">4</span> Dependency utilities</a></li>
<li><a class="" href="web-applications.html"><span class="header-section-number">5</span> Web application concepts</a></li>
<li class="book-part">Beautify with CSS and Sass</li>
<li><a class="" href="beautify-css.html"><span class="header-section-number">6</span> CSS for Shiny</a></li>
<li><a class="" href="beautify-sass.html"><span class="header-section-number">7</span> Introduction to Sass</a></li>
<li><a class="" href="beautify-with-fresh.html"><span class="header-section-number">8</span> Beautify with {fresh}</a></li>
<li><a class="" href="beautify-with-bootstraplib.html"><span class="header-section-number">9</span> Beautify with {bslib}</a></li>
<li class="book-part">Unleash interactivity with JavaScript</li>
<li><a class="" href="survival-kit-javascript.html"><span class="header-section-number">10</span> JavaScript for Shiny</a></li>
<li><a class="" href="shiny-intro.html"><span class="header-section-number">11</span> R and JS</a></li>
<li><a class="" href="shiny-input-system.html"><span class="header-section-number">12</span> Shiny’s input system</a></li>
<li><a class="" href="shiny-input-lifecycle.html"><span class="header-section-number">13</span> Shiny inputs lifecycles</a></li>
<li><a class="" href="shiny-input-gems.html"><span class="header-section-number">14</span> Mastering Shiny’s events</a></li>
<li><a class="" href="shiny-custom-handler.html"><span class="header-section-number">15</span> Dynamically manage content with handlers</a></li>
<li class="book-part">Practice 1: a dashboard template</li>
<li><a class="" href="custom-templates-dependencies.html"><span class="header-section-number">16</span> Define dependencies</a></li>
<li><a class="" href="custom-templates-skeleton.html"><span class="header-section-number">17</span> Create template elements</a></li>
<li><a class="" href="custom-templates-inputs.html"><span class="header-section-number">18</span> Develop custom input widgets</a></li>
<li><a class="" href="custom-templates-interactivity.html"><span class="header-section-number">19</span> Adding more interactivity</a></li>
<li><a class="active" href="custom-templates-testing.html"><span class="header-section-number">20</span> Testing and validating templates elements</a></li>
<li class="book-part">Toward a better workflow</li>
<li><a class="" href="workflow-charpente.html"><span class="header-section-number">21</span> Introduction to {charpente}</a></li>
<li class="book-part">Case study 2: Mobile development with Shiny</li>
<li><a class="" href="mobile-shiny-intro.html"><span class="header-section-number">22</span> Introduction</a></li>
<li><a class="" href="mobile-shinyMobile.html"><span class="header-section-number">23</span> Reconstruct {shinyMobile}</a></li>
<li><a class="" href="mobile-pwa.html"><span class="header-section-number">24</span> {shinyMobile} and PWA</a></li>
<li><a class="" href="mobile-widgets.html"><span class="header-section-number">25</span> Design widgets</a></li>
<li><a class="" href="mobile-going-further.html"><span class="header-section-number">26</span> Fine tune {shinyMobile}</a></li>
<li class="book-part">Going further</li>
<li><a class="" href="going-further-reactR.html"><span class="header-section-number">27</span> R + Shiny + React: welcome {reactR}</a></li>
<li><a class="" href="going-further-webdev.html"><span class="header-section-number">28</span> Divide and Conquere</a></li>
<li><a class="" href="going-further-where-to-go.html"><span class="header-section-number">29</span> What to do next?</a></li>
<li class="book-part">Appendix</li>
<li><a class="" href="code-outputs.html"><span class="header-section-number">A</span> Code outputs</a></li>
<li><a class="" href="references.html">References</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/DivadNojnarg/outstanding-shiny-ui">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="custom-templates-testing" class="section level1">
<h1>
<span class="header-section-number">20</span> Testing and validating templates elements<a class="anchor" aria-label="anchor" href="#custom-templates-testing"><i class="fas fa-link"></i></a>
</h1>
<p>Until now, we have been building the template boilerplate, that is the main skeleton functions (page, navbar, navbar menu, …) as well as some components such as cards, ribbons, progress bars. We also exposed some techniques to substantially give more <strong>interactivity</strong> to the template, leveraging our freshly acquired JavaScript skills. Does this mean we are ready to make the template public? Not yet since some essentials steps are missing:</p>
<ul>
<li>Input <strong>validation</strong> is a crucial step toward success. Briefly, it consists in checking user inputs so that your functions fail <strong>safely</strong> and elegantly by providing meaningful error messages or warnings. This concept has already been covered in R for Data Science <span class="citation">(Wickham and Grolemund <a href="references.html#ref-R4DS" role="doc-biblioref">2017</a>)</span>, Advanced R <span class="citation">(Hadley <a href="references.html#ref-AdvancedR" role="doc-biblioref">2019</a>)</span> and a lot of other resources. Hence, we are not trying to reinvent the wheel and we rely on the already existing patterns, whose effectiveness is no longer to be demonstrated. Welcome to the <strong>defensive programming</strong> world!</li>
<li>On the other hand, testing components allows to check if a functions does what it is supposed to do. Consequently, it is a proof of <strong>robustness</strong>, and increases <strong>reproducibility</strong>. It significantly reduces the mental load when it comes to start code <strong>refactoring</strong>, thereby making you feel slightly less guilty about creating breaking changes since, most of the time, your tests will be able to capture those errors.</li>
</ul>
<div id="validate-template-functions" class="section level2">
<h2>
<span class="header-section-number">20.1</span> Validate template functions<a class="anchor" aria-label="anchor" href="#validate-template-functions"><i class="fas fa-link"></i></a>
</h2>
<div id="create-your-own-validations" class="section level3">
<h3>
<span class="header-section-number">20.1.1</span> Create your own validations<a class="anchor" aria-label="anchor" href="#create-your-own-validations"><i class="fas fa-link"></i></a>
</h3>
<p>Below, we showcase some examples to <strong>validate</strong> user inputs. We first consider the <code><a href="https://rdrr.io/pkg/OSUICode/man/tabler_card.html">tabler_card()</a></code> element from Chapter <a href="custom-templates-skeleton.html#custom-templates-skeleton">17</a>:</p>
<div class="sourceCode" id="cb707"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://shiny.rstudio.com/">shiny</a></span><span class="op">)</span>
<span class="va">tabler_card</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">...</span>, <span class="va">title</span> <span class="op">=</span> <span class="cn">NULL</span>, <span class="va">status</span> <span class="op">=</span> <span class="cn">NULL</span>, <span class="va">width</span> <span class="op">=</span> <span class="fl">6</span>,
                        <span class="va">stacked</span> <span class="op">=</span> <span class="cn">FALSE</span>, <span class="va">padding</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span>

  <span class="va">card_cl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span>
    <span class="st">"card"</span>,
    <span class="kw">if</span> <span class="op">(</span><span class="va">stacked</span><span class="op">)</span> <span class="st">" card-stacked"</span>,
    <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span><span class="op">(</span><span class="va">padding</span><span class="op">)</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">" card-"</span>, <span class="va">padding</span><span class="op">)</span>
  <span class="op">)</span>

  <span class="va">status_tag</span> <span class="op">&lt;-</span> <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span><span class="op">(</span><span class="va">status</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
    <span class="fu"><a href="https://rdrr.io/pkg/htmltools/man/builder.html">div</a></span><span class="op">(</span>class <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"card-status-top bg-"</span>, <span class="va">status</span><span class="op">)</span><span class="op">)</span>
  <span class="op">}</span>

  <span class="va">main_wrapper</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/htmltools/man/builder.html">div</a></span><span class="op">(</span>class <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"col-md-"</span>, <span class="va">width</span><span class="op">)</span><span class="op">)</span>
  
  <span class="co"># ...Code commented for space reasons</span>
<span class="op">}</span></code></pre></div>
<p>The first thing is to think about what to validate. Here, we see at least three test:</p>
<ul>
<li>Checking the <strong>status</strong> value.</li>
<li>Checking the <strong>width</strong> value.</li>
<li>Checking the <strong>padding</strong> value.</li>
</ul>
<p>Writing validation tests requires knowledge about the underlying mechanisms. In our case, we must know the Bootstrap 4 <strong>grid</strong> rules and valid color <strong>statuses</strong>. The Bootstrap 4 <a href="https://getbootstrap.com/docs/4.0/layout/grid/">grid</a> ranges from 1 to 12. In other words, a card having a width of 12 will take the full page whereas, we may align three cards of width 4. Valid <a href="https://getbootstrap.com/docs/4.0/utilities/colors/">statuses</a> are primary, secondary, success, info, danger, warning, light and dark.</p>
<p>It is therefore pretty straightforward to validate the card width as it must be numeric and between 1 and 12. Moreover, since the template has other containers including the width parameter, we create a function to rule them all:</p>
<div class="sourceCode" id="cb708"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">validate_width</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">width</span><span class="op">)</span> <span class="op">{</span>
  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">is.numeric</a></span><span class="op">(</span><span class="va">width</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
    <span class="kw">if</span> <span class="op">(</span><span class="va">width</span> <span class="op">&lt;</span> <span class="fl">1</span> <span class="op">||</span> <span class="va">width</span> <span class="op">&gt;</span> <span class="fl">12</span><span class="op">)</span> <span class="op">{</span>
      <span class="kw"><a href="https://rdrr.io/r/base/stop.html">stop</a></span><span class="op">(</span>
        <span class="st">"width must belong to [1, 12], as per 
        Bootstrap 4 grid documentation. 
        See https://getbootstrap.com/docs/4.0/layout/grid/"</span>
      <span class="op">)</span>
    <span class="op">}</span>
  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
    <span class="kw"><a href="https://rdrr.io/r/base/stop.html">stop</a></span><span class="op">(</span><span class="st">"width must be numeric"</span><span class="op">)</span>
  <span class="op">}</span>
<span class="op">}</span>

<span class="fu"><a href="https://rdrr.io/pkg/OSUICode/man/validate_width.html">validate_width</a></span><span class="op">(</span><span class="fl">4</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/try.html">try</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/OSUICode/man/validate_width.html">validate_width</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span> </code></pre></div>
<pre><code>#&gt; Error in validate_width(-1) : width must belong to [1, 12], as per 
#&gt;         Bootstrap 4 grid documentation. 
#&gt;         See https://getbootstrap.com/docs/4.0/layout/grid/</code></pre>
<div class="sourceCode" id="cb710"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/try.html">try</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/OSUICode/man/validate_width.html">validate_width</a></span><span class="op">(</span><span class="fl">13</span><span class="op">)</span><span class="op">)</span> </code></pre></div>
<pre><code>#&gt; Error in validate_width(13) : width must belong to [1, 12], as per 
#&gt;         Bootstrap 4 grid documentation. 
#&gt;         See https://getbootstrap.com/docs/4.0/layout/grid/</code></pre>
<div class="sourceCode" id="cb712"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/try.html">try</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/OSUICode/man/validate_width.html">validate_width</a></span><span class="op">(</span><span class="st">"string"</span><span class="op">)</span><span class="op">)</span> </code></pre></div>
<pre><code>#&gt; Error in validate_width("string") : width must be numeric</code></pre>
<p>To check the status parameter, we save the valid statuses in a vector and take the <code>validStatuses</code> function from <a href="http://rstudio.github.io/shinydashboard/">shinydashboard</a> <a href="https://github.com/rstudio/shinydashboard/blob/master/R/utils.R">utils</a>. It also make sense to create a function since this parameter is widely used among other template components.
Contrary to the <a href="http://rstudio.github.io/shinydashboard/">shinydashboard</a> function, our custom <code>valid_status()</code> does not fail
if the status is <code>NULL</code> since it is not a mandatory parameter.</p>
<div class="sourceCode" id="cb714"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">valid_statuses</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
  <span class="st">"primary"</span>, 
  <span class="st">"secondary"</span>,
  <span class="st">"success"</span>, 
  <span class="st">"info"</span>, 
  <span class="st">"warning"</span>, 
  <span class="st">"danger"</span>,
  <span class="st">"light"</span>,
  <span class="st">"dark"</span>
<span class="op">)</span>

<span class="va">validate_status</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">status</span><span class="op">)</span> <span class="op">{</span>

  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span><span class="op">(</span><span class="va">status</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="cn">TRUE</span><span class="op">)</span> 
  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
    <span class="kw">if</span> <span class="op">(</span><span class="va">status</span> <span class="op">%in%</span> <span class="va">valid_statuses</span><span class="op">)</span> <span class="op">{</span>
      <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="cn">TRUE</span><span class="op">)</span>
    <span class="op">}</span>
  <span class="op">}</span>

  <span class="kw"><a href="https://rdrr.io/r/base/stop.html">stop</a></span><span class="op">(</span><span class="st">"Invalid status: "</span>, <span class="va">status</span>, <span class="st">". Valid statuses are: "</span>,
       <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">valid_statuses</span>, collapse <span class="op">=</span> <span class="st">", "</span><span class="op">)</span>, <span class="st">"."</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>We finish by the padding validation. According to the Tabler documentation,
there are three possible choices, namely <code>sm</code>, <code>md</code> or <code>lg</code>:</p>
<div class="sourceCode" id="cb715"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">valid_paddings</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"sm"</span>, <span class="st">"md"</span>, <span class="st">"lg"</span><span class="op">)</span>

<span class="va">validate_padding</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">padding</span><span class="op">)</span> <span class="op">{</span>
  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span><span class="op">(</span><span class="va">padding</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
    <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="op">(</span><span class="va">padding</span> <span class="op">%in%</span> <span class="va">valid_paddings</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
      <span class="kw"><a href="https://rdrr.io/r/base/stop.html">stop</a></span><span class="op">(</span><span class="st">"Invalid status: "</span>, <span class="va">padding</span>, <span class="st">". Valid choices are: "</span>,
       <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">valid_paddings</span>, collapse <span class="op">=</span> <span class="st">", "</span><span class="op">)</span>, <span class="st">"."</span><span class="op">)</span>
    <span class="op">}</span>
  <span class="op">}</span>
<span class="op">}</span></code></pre></div>
<p>We apply all these validation to our card element.</p>
<div class="sourceCode" id="cb716"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">tabler_card</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">...</span>, <span class="va">title</span> <span class="op">=</span> <span class="cn">NULL</span>, <span class="va">status</span> <span class="op">=</span> <span class="cn">NULL</span>, 
                        <span class="va">width</span> <span class="op">=</span> <span class="fl">6</span>, <span class="va">stacked</span> <span class="op">=</span> <span class="cn">FALSE</span>, 
                        <span class="va">padding</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span>
  
  <span class="fu"><a href="https://rdrr.io/pkg/OSUICode/man/validate_status.html">validate_status</a></span><span class="op">(</span><span class="va">status</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/pkg/OSUICode/man/validate_width.html">validate_width</a></span><span class="op">(</span><span class="va">width</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/pkg/OSUICode/man/validate_padding.html">validate_padding</a></span><span class="op">(</span><span class="va">padding</span><span class="op">)</span>
  
  <span class="co"># ... remaining code</span>
<span class="op">}</span></code></pre></div>
<p>As of R 4.0.0, the <code><a href="https://rdrr.io/r/base/stopifnot.html">stopifnot()</a></code> function may be a good alternative to <code><a href="https://rdrr.io/r/base/stop.html">stop()</a></code>.</p>
<div class="noteblock">
<p>We recommend to be <strong>reasonable</strong> and not to validate every single parameter, as it might be not that productive and could cause frustration for the
end users.</p>
</div>
</div>
<div id="existing-utils-functions" class="section level3">
<h3>
<span class="header-section-number">20.1.2</span> Existing utils functions<a class="anchor" aria-label="anchor" href="#existing-utils-functions"><i class="fas fa-link"></i></a>
</h3>
<div id="validating-tags" class="section level4">
<h4>
<span class="header-section-number">20.1.2.1</span> Validating tags<a class="anchor" aria-label="anchor" href="#validating-tags"><i class="fas fa-link"></i></a>
</h4>
<p>With the above approach, it takes some time to create all validation functions. Fortunately, packages like <a href="http://rstudio.github.io/shinydashboard/">shinydashboard</a> include really powerful validation functions, especially <code><a href="https://rdrr.io/pkg/OSUICode/man/tagAssert.html">tagAssert()</a></code>. This function has been included in the book side package (<code>{OSUICode}</code>) so that you may use it at any time:</p>
<div class="sourceCode" id="cb717"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">OSUICode</span><span class="op">)</span>
<span class="va">myTag</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/htmltools/man/builder.html">div</a></span><span class="op">(</span>class <span class="op">=</span> <span class="st">"bg-blue"</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/pkg/OSUICode/man/tagAssert.html">tagAssert</a></span><span class="op">(</span><span class="va">myTag</span>, type <span class="op">=</span> <span class="st">"div"</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/try.html">try</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/OSUICode/man/tagAssert.html">tagAssert</a></span><span class="op">(</span><span class="va">myTag</span>, type <span class="op">=</span> <span class="st">"li"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>#&gt; Error in tagAssert(myTag, type = "li") : Expected tag to be of type li</code></pre>
<div class="sourceCode" id="cb719"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/OSUICode/man/tagAssert.html">tagAssert</a></span><span class="op">(</span><span class="va">myTag</span>, class <span class="op">=</span> <span class="st">"bg-blue"</span><span class="op">)</span></code></pre></div>
<p>Importantly, <code><a href="https://rdrr.io/pkg/OSUICode/man/tagAssert.html">tagAssert()</a></code> raises an error if the condition is not fulfilled. Another function, <code><a href="https://rdrr.io/pkg/OSUICode/man/tagMatches.html">tagMatches()</a></code> simply returns <code>TRUE</code> or <code>FALSE</code>. It looks for <code>ìd</code>, <code>class</code>, <code>name</code> and any other tag attribute like <code>data-value</code>. Like <code><a href="https://rdrr.io/pkg/OSUICode/man/tagAssert.html">tagAssert()</a></code>, <code><a href="https://rdrr.io/pkg/OSUICode/man/tagMatches.html">tagMatches()</a></code> is also available in <code>{OSUICode}</code>.</p>
<div class="sourceCode" id="cb720"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/OSUICode/man/tagMatches.html">tagMatches</a></span><span class="op">(</span><span class="va">myTag</span>, id <span class="op">=</span> <span class="st">"d"</span><span class="op">)</span></code></pre></div>
<pre><code>#&gt; [1] FALSE</code></pre>
<div class="sourceCode" id="cb722"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/OSUICode/man/tagMatches.html">tagMatches</a></span><span class="op">(</span><span class="va">myTag</span>, class <span class="op">=</span> <span class="st">"bg-blue"</span><span class="op">)</span></code></pre></div>
<pre><code>#&gt; [1] TRUE</code></pre>
</div>
<div id="validating-css-units" class="section level4">
<h4>
<span class="header-section-number">20.1.2.2</span> Validating CSS units<a class="anchor" aria-label="anchor" href="#validating-css-units"><i class="fas fa-link"></i></a>
</h4>
<p>The <code><a href="https://rdrr.io/pkg/htmltools/man/validateCssUnit.html">validateCssUnit()</a></code> function belongs to the Shiny exported function. It is useful to quickly check any parameter involving a CSS unit like <code>width</code> and <code>height</code>.</p>
<div class="sourceCode" id="cb724"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://shiny.rstudio.com/">shiny</a></span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/htmltools/man/validateCssUnit.html">validateCssUnit</a></span><span class="op">(</span><span class="st">"5px"</span><span class="op">)</span></code></pre></div>
<pre><code>#&gt; [1] "5px"</code></pre>
<div class="sourceCode" id="cb726"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/try.html">try</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/htmltools/man/validateCssUnit.html">validateCssUnit</a></span><span class="op">(</span><span class="st">"plop"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>#&gt; Error in validateCssUnit("plop") : 
#&gt;   "plop" is not a valid CSS unit (e.g., "100%", "400px", "auto")</code></pre>
<div class="sourceCode" id="cb728"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/htmltools/man/validateCssUnit.html">validateCssUnit</a></span><span class="op">(</span><span class="st">"5rem"</span><span class="op">)</span></code></pre></div>
<pre><code>#&gt; [1] "5rem"</code></pre>
<div class="sourceCode" id="cb730"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/htmltools/man/validateCssUnit.html">validateCssUnit</a></span><span class="op">(</span><span class="st">"100%"</span><span class="op">)</span></code></pre></div>
<pre><code>#&gt; [1] "100%"</code></pre>
</div>
</div>
<div id="example-refine-navbar-menu-items" class="section level3">
<h3>
<span class="header-section-number">20.1.3</span> Example: refine navbar menu items<a class="anchor" aria-label="anchor" href="#example-refine-navbar-menu-items"><i class="fas fa-link"></i></a>
</h3>
<div id="avoid-wrong-jquery-selectors" class="section level4">
<h4>
<span class="header-section-number">20.1.3.1</span> Avoid wrong jQuery selectors<a class="anchor" aria-label="anchor" href="#avoid-wrong-jquery-selectors"><i class="fas fa-link"></i></a>
</h4>
<p>In Chapter <a href="custom-templates-skeleton.html#custom-templates-skeleton">17</a>, we developed the <code><a href="https://rdrr.io/pkg/OSUICode/man/tabler_navbar_menu_item.html">tabler_navbar_menu_item()</a></code> function. The <code>tabName</code> parameter is critical since it is responsible for driving the navigation. We must ensure that the value provided by the user is compatible with jQuery <strong>selectors</strong> <a href="https://api.jquery.com/category/selectors/">conventions</a>. To illustrate the problem, we consider the example below, where the second tab name is <code>hello%%&amp;1</code>:</p>
<div class="sourceCode" id="cb732"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/OSUICode/man/tabler_navbar_menu_item.html">tabler_navbar_menu_item</a></span><span class="op">(</span>
  text <span class="op">=</span> <span class="st">"Tab 2"</span>,
  icon <span class="op">=</span> <span class="cn">NULL</span>,
  tabName <span class="op">=</span> <span class="st">"hello%%&amp;1"</span>
<span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb733"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">### RUN ### </span>
<span class="co"># OSUICode::run_example( </span>
<span class="co">#  "tabler/wrong-tab" </span>
<span class="co"># ) </span></code></pre></div>
<p>Notice that we cannot see the second tab content. This issue is quite vicious since we don’t even see any error message on the JS side. Below is a proposal for the <code>validate_tab()</code> function. We first detect any punctuation in the provided input with <code>[[:punct:]]</code>. The trick is not to capture the <code>_</code> that is valid in jQuery. We use a negative look-ahead assertion <code>(?!_)</code>.
We finally raise an error if any punctuation is found:</p>
<div class="sourceCode" id="cb734"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">validate_tabName</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">tabName</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">forbidden</span> <span class="op">&lt;-</span> <span class="st">"(?!_)[[:punct:]]"</span>
  <span class="va">wrong_selector</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span><span class="op">(</span><span class="va">forbidden</span>, <span class="va">tabName</span>, perl <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
  <span class="kw">if</span> <span class="op">(</span><span class="va">wrong_selector</span><span class="op">)</span> <span class="op">{</span>
    <span class="kw"><a href="https://rdrr.io/r/base/stop.html">stop</a></span><span class="op">(</span>
      <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span>
        <span class="st">"Please do not use punctuation characters in tabNames.
        This might cause JavaScript issues."</span>
      <span class="op">)</span>
    <span class="op">)</span>
  <span class="op">}</span>
<span class="op">}</span>
<span class="fu"><a href="https://rdrr.io/pkg/OSUICode/man/validate_tabName.html">validate_tabName</a></span><span class="op">(</span><span class="st">"plop"</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/try.html">try</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/OSUICode/man/validate_tabName.html">validate_tabName</a></span><span class="op">(</span><span class="st">"test%"</span><span class="op">)</span><span class="op">)</span> <span class="co"># will fail</span></code></pre></div>
<pre><code>#&gt; Error in validate_tabName("test%") : 
#&gt;   Please do not use punctuation characters in tabNames.
#&gt;         This might cause JavaScript issues.</code></pre>
<p><code><a href="https://rdrr.io/pkg/OSUICode/man/validate_tabName.html">validate_tabName()</a></code> must be then inserted at the beginning of <code><a href="https://rdrr.io/pkg/OSUICode/man/tabler_navbar_menu_item.html">tabler_navbar_menu_item()</a></code> as well as in <code><a href="https://rdrr.io/pkg/OSUICode/man/tabler_tab_item.html">tabler_tab_item()</a></code>, the latter also relying on tabName.</p>
</div>
<div id="checking-for-multiple-selected-items" class="section level4">
<h4>
<span class="header-section-number">20.1.3.2</span> Checking for multiple selected items<a class="anchor" aria-label="anchor" href="#checking-for-multiple-selected-items"><i class="fas fa-link"></i></a>
</h4>
<p>Another issue is the possibility to have multiple selected tab items at start. Looking back at <code><a href="https://rdrr.io/pkg/OSUICode/man/tabler_navbar_menu.html">tabler_navbar_menu()</a></code>, this is not surprising since there are absolutely no checks!</p>
<div class="sourceCode" id="cb736"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">tabler_navbar_menu</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">...</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">tags</span><span class="op">$</span><span class="fu">ul</span><span class="op">(</span>class <span class="op">=</span> <span class="st">"nav nav-pills navbar-nav"</span>, <span class="va">...</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>A classic method to inspect items provided to <code><a href="https://rdrr.io/pkg/OSUICode/man/tabler_navbar_menu.html">tabler_navbar_menu()</a></code> is to capture them in a list. We extract the children of those items via <code><a href="https://rdrr.io/r/base/lapply.html">lapply(list(...), `[[`, "children")</a></code>. As a reminder, a shiny tag is a structure containing the tag name, a named list of attributes, and the children (See chapter <a href="htmltools-overview.html#htmltools-overview">2</a>). For each children we apply the <a href="http://rstudio.github.io/shinydashboard/">shinydashboard</a> internal function <code><a href="https://rdrr.io/pkg/OSUICode/man/findAttribute.html">findAttribute()</a></code>, that allows to search for a specific attribute value in a given tag. We use the <code><a href="https://rdrr.io/r/base/lapply.html">vapply()</a></code> to return an atomic vector (like <code>c(1, 2</code>), lists are vectors but recursive) and compute the sum of the vector. Each <code>TRUE</code> occurrence is counted as 1 and <code>FALSE</code> 0. Therefore, if the latter is higher than 1, it means that the user provided more than 1 selected tab, which should subsequently raise an error:</p>
<div class="sourceCode" id="cb737"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">tabler_navbar_menu</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">...</span><span class="op">)</span> <span class="op">{</span>
  
  <span class="va">items</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span><span class="op">(</span>
    <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">...</span><span class="op">)</span> , <span class="va">`[[`</span>, <span class="st">"children"</span><span class="op">)</span>, 
    recursive <span class="op">=</span> <span class="cn">FALSE</span>
  <span class="op">)</span>
  <span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span>
    <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">vapply</a></span><span class="op">(</span>
      <span class="va">items</span>, 
      <span class="va">findAttribute</span>, 
      <span class="st">"class"</span>, 
      <span class="st">"nav-link active"</span>, 
      FUN.VALUE <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/logical.html">logical</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>
    <span class="op">)</span>
  <span class="op">)</span>
  <span class="kw">if</span> <span class="op">(</span><span class="va">res</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">)</span> <span class="op">{</span>
    <span class="kw"><a href="https://rdrr.io/r/base/stop.html">stop</a></span><span class="op">(</span><span class="st">"Cannot have multiple selected items at start!"</span><span class="op">)</span>
  <span class="op">}</span>
  
  <span class="va">tags</span><span class="op">$</span><span class="fu">ul</span><span class="op">(</span>class <span class="op">=</span> <span class="st">"nav nav-pills navbar-nav"</span>, <span class="va">...</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<div class="sourceCode" id="cb738"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/try.html">try</a></span><span class="op">(</span><span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/pkg/OSUICode/man/tabler_navbar_menu.html">tabler_navbar_menu</a></span><span class="op">(</span>
    <span class="fu"><a href="https://rdrr.io/pkg/OSUICode/man/tabler_navbar_menu_item.html">tabler_navbar_menu_item</a></span><span class="op">(</span>
      text <span class="op">=</span> <span class="st">"Tab 1"</span>,
      tabName <span class="op">=</span> <span class="st">"tab1"</span>,
      selected <span class="op">=</span> <span class="cn">TRUE</span>
    <span class="op">)</span>,
    <span class="fu"><a href="https://rdrr.io/pkg/OSUICode/man/tabler_navbar_menu_item.html">tabler_navbar_menu_item</a></span><span class="op">(</span>
      text <span class="op">=</span> <span class="st">"Tab 2"</span>,
      tabName <span class="op">=</span> <span class="st">"tab2"</span>,
      selected <span class="op">=</span> <span class="cn">TRUE</span>
    <span class="op">)</span>
  <span class="op">)</span>
<span class="op">}</span><span class="op">)</span>
<span class="co">#&gt; Cannot have multiple selected items at start!</span></code></pre></div>
</div>
</div>
</div>
<div id="testing-templates-elements" class="section level2">
<h2>
<span class="header-section-number">20.2</span> Testing templates elements<a class="anchor" aria-label="anchor" href="#testing-templates-elements"><i class="fas fa-link"></i></a>
</h2>
<p>Imagine if one day, someone or yourself accidentally remove the width validation function, after a significant code refactoring. Later, you receive a new message from GitHub, stating that someone opened a new issue. According to the report, the card is not properly displayed although no error is thrown. Among the 400 lines of code provided, you hardly notice that the width parameter is set to 13, which is not in line with the Bootstrap 4 documentation, as it should remain between 1 and 12. You lost 10 minutes and so did your end user, which is even worse.</p>
<p>With a proper testing pipeline, this problem could have been avoided. Ironically, writing the corresponding test takes only two minutes.</p>
<p>A reference for testing functions is the <a href="https://testthat.r-lib.org/index.html">{testthat}</a> package <span class="citation">(Wickham <a href="references.html#ref-R-testthat" role="doc-biblioref">2021</a>)</span>. In short, a <strong>unit test</strong> consists in setting <strong>expectations</strong> about our function and check whether they <strong>fail</strong> or <strong>pass</strong>. For instance, in the previous <code><a href="https://rdrr.io/pkg/OSUICode/man/tabler_card.html">tabler_card()</a></code> example, <code><a href="https://rdrr.io/pkg/OSUICode/man/validate_width.html">validate_width()</a></code> must fail if the given width is not in the expected bounds or not numeric. We apply the <code><a href="https://testthat.r-lib.org/reference/test_that.html">test_that()</a></code> function with a description containing the test <strong>context</strong>, followed by the expectations inside the curly brackets.</p>
<div class="sourceCode" id="cb739"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://testthat.r-lib.org">testthat</a></span><span class="op">)</span>
<span class="fu"><a href="https://testthat.r-lib.org/reference/test_that.html">test_that</a></span><span class="op">(</span><span class="st">"validate width works"</span>, <span class="op">{</span>
  <span class="fu"><a href="https://testthat.r-lib.org/reference/expect_error.html">expect_error</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/OSUICode/man/tabler_card.html">tabler_card</a></span><span class="op">(</span>width <span class="op">=</span> <span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span>
  <span class="fu"><a href="https://testthat.r-lib.org/reference/expect_error.html">expect_error</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/OSUICode/man/tabler_card.html">tabler_card</a></span><span class="op">(</span>width <span class="op">=</span> <span class="fl">13</span><span class="op">)</span><span class="op">)</span>
  <span class="fu"><a href="https://testthat.r-lib.org/reference/expect_error.html">expect_error</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/OSUICode/man/tabler_card.html">tabler_card</a></span><span class="op">(</span>width <span class="op">=</span> <span class="st">"hello world"</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span></code></pre></div>
<pre><code>#&gt; Test passed 🎉</code></pre>
<p>We then test <code><a href="https://rdrr.io/pkg/OSUICode/man/validate_status.html">validate_status()</a></code> and <code><a href="https://rdrr.io/pkg/OSUICode/man/validate_padding.html">validate_padding()</a></code>.</p>
<div class="sourceCode" id="cb741"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://testthat.r-lib.org/reference/test_that.html">test_that</a></span><span class="op">(</span><span class="st">"validate status works"</span>, <span class="op">{</span>
  <span class="fu"><a href="https://testthat.r-lib.org/reference/expect_error.html">expect_error</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/OSUICode/man/tabler_card.html">tabler_card</a></span><span class="op">(</span>status <span class="op">=</span> <span class="st">"toto"</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span></code></pre></div>
<pre><code>#&gt; Test passed 🌈</code></pre>
<div class="sourceCode" id="cb743"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://testthat.r-lib.org/reference/test_that.html">test_that</a></span><span class="op">(</span><span class="st">"validate padding works"</span>, <span class="op">{</span>
  <span class="fu"><a href="https://testthat.r-lib.org/reference/expect_error.html">expect_error</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/OSUICode/man/tabler_card.html">tabler_card</a></span><span class="op">(</span>width <span class="op">=</span> <span class="st">"xs"</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span></code></pre></div>
<pre><code>#&gt; Test passed 😸</code></pre>
<p>So far so good. In few lines of code, we substantially increased the <strong>robustness</strong> of our function without increasing its <strong>complexity</strong>. Now, let’s try to remove the <code><a href="https://rdrr.io/pkg/OSUICode/man/validate_width.html">validate_width()</a></code> step from the <code><a href="https://rdrr.io/pkg/OSUICode/man/tabler_card.html">tabler_card()</a></code>.</p>
<div class="sourceCode" id="cb745"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">tabler_card</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">...</span>, <span class="va">title</span> <span class="op">=</span> <span class="cn">NULL</span>, <span class="va">status</span> <span class="op">=</span> <span class="cn">NULL</span>, 
                        <span class="va">width</span> <span class="op">=</span> <span class="fl">6</span>, <span class="va">stacked</span> <span class="op">=</span> <span class="cn">FALSE</span>, 
                        <span class="va">padding</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span>
  
  <span class="co"># validation</span>
  <span class="co"># validate_width(width)</span>
  <span class="fu"><a href="https://rdrr.io/pkg/OSUICode/man/validate_status.html">validate_status</a></span><span class="op">(</span><span class="va">status</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/pkg/OSUICode/man/validate_padding.html">validate_padding</a></span><span class="op">(</span><span class="va">padding</span><span class="op">)</span>
  
  <span class="co"># ... Code commented</span>
<span class="op">}</span></code></pre></div>
<div class="sourceCode" id="cb746"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://testthat.r-lib.org/reference/test_that.html">test_that</a></span><span class="op">(</span><span class="st">"validate width works"</span>, <span class="op">{</span>
  <span class="fu"><a href="https://testthat.r-lib.org/reference/expect_error.html">expect_error</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/OSUICode/man/tabler_card.html">tabler_card</a></span><span class="op">(</span>width <span class="op">=</span> <span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span>
  <span class="fu"><a href="https://testthat.r-lib.org/reference/expect_error.html">expect_error</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/OSUICode/man/tabler_card.html">tabler_card</a></span><span class="op">(</span>width <span class="op">=</span> <span class="fl">13</span><span class="op">)</span><span class="op">)</span>
  <span class="fu"><a href="https://testthat.r-lib.org/reference/expect_error.html">expect_error</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/OSUICode/man/tabler_card.html">tabler_card</a></span><span class="op">(</span>width <span class="op">=</span> <span class="st">"hello world"</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span></code></pre></div>
<pre><code>#&gt; ── Failure (&lt;text&gt;:2:3): validate width works ──────────────────────────────────
#&gt; `tabler_card(width = -1)` did not throw an error.
#&gt; 
#&gt; ── Failure (&lt;text&gt;:3:3): validate width works ──────────────────────────────────
#&gt; `tabler_card(width = 13)` did not throw an error.
#&gt; 
#&gt; ── Failure (&lt;text&gt;:4:3): validate width works ──────────────────────────────────
#&gt; `tabler_card(width = "hello world")` did not throw an error.</code></pre>
<p>Notice how the three above tests elegantly fail. The provided context (“validate width works”) immediately indicates the culprit, which is a game changer for debugging.</p>
<div id="testing-template-behavior" class="section level3">
<h3>
<span class="header-section-number">20.2.1</span> Testing template behavior<a class="anchor" aria-label="anchor" href="#testing-template-behavior"><i class="fas fa-link"></i></a>
</h3>
<p>Testing the JavaScript behavior is one of the biggest challenge to validate a template. If the R component has been carefully validated, it does not mean that its JavaScript effects are. For instance, let’s consider the <code><a href="https://rdrr.io/pkg/OSUICode/man/tabler_progress.html">tabler_progress()</a></code> that may be updated with <code><a href="https://rdrr.io/pkg/OSUICode/man/update_tabler_progress.html">update_tabler_progress()</a></code>. How do we check whether the progress value is correctly set?</p>
<div id="r-side" class="section level4">
<h4>
<span class="header-section-number">20.2.1.1</span> R side<a class="anchor" aria-label="anchor" href="#r-side"><i class="fas fa-link"></i></a>
</h4>
<p>Testing the R side is quite easy. Let’s recall the <code><a href="https://rdrr.io/pkg/OSUICode/man/update_tabler_progress.html">update_tabler_progress()</a></code> function:</p>
<div class="sourceCode" id="cb748"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">update_tabler_progress</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span>
  <span class="va">id</span>, 
  <span class="va">value</span>, 
  <span class="va">session</span> <span class="op">=</span> <span class="fu">shiny</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/shiny/man/domains.html">getDefaultReactiveDomain</a></span><span class="op">(</span><span class="op">)</span>
<span class="op">)</span> <span class="op">{</span>
  <span class="va">message</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>id <span class="op">=</span> <span class="va">session</span><span class="op">$</span><span class="fu">ns</span><span class="op">(</span><span class="va">id</span><span class="op">)</span>, value <span class="op">=</span> <span class="va">value</span><span class="op">)</span>
  <span class="va">session</span><span class="op">$</span><span class="fu">sendCustomMessage</span><span class="op">(</span>type <span class="op">=</span> <span class="st">"update-progress"</span>, <span class="va">message</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>This function does two things:</p>
<ul>
<li>
<strong>Captures</strong> the <strong>id</strong> of the targeted progress and its new <strong>value</strong>.</li>
<li>Sends the message the JS.</li>
</ul>
<p>The test consists in checking whether we send all elements to the <strong>session</strong>. We first create
a dummy session environment which contains <code>ns</code> to mimic the <code>session$ns</code> function
and <code>sendCustomMessage</code> to test the message handler part:</p>
<div class="sourceCode" id="cb749"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">session</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.environment.html">as.environment</a></span><span class="op">(</span>
  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
    ns <span class="op">=</span> <span class="va">identity</span>,
    sendCustomMessage <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">type</span>, <span class="va">message</span><span class="op">)</span> <span class="op">{</span>
      <span class="va">session</span><span class="op">$</span><span class="va">lastCustomMessage</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
        type <span class="op">=</span> <span class="va">type</span>, 
        message <span class="op">=</span> <span class="va">message</span>
      <span class="op">)</span>
    <span class="op">}</span>
  <span class="op">)</span>
<span class="op">)</span></code></pre></div>
<p>Here, <code>sendCustomMessage</code> simply stores the last sent message in <code>session$lastCustomMessage</code>, and <code>session$ns</code> returns the provided element:</p>
<div class="sourceCode" id="cb750"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">session</span><span class="op">$</span><span class="fu">ns</span><span class="op">(</span><span class="st">"test"</span><span class="op">)</span></code></pre></div>
<pre><code>#&gt; [1] "test"</code></pre>
<div class="sourceCode" id="cb752"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">session</span><span class="op">$</span><span class="fu">sendCustomMessage</span><span class="op">(</span><span class="st">"test"</span>, message <span class="op">=</span> <span class="st">"hello"</span><span class="op">)</span>
<span class="va">session</span><span class="op">$</span><span class="va">lastCustomMessage</span></code></pre></div>
<pre><code>#&gt; $type
#&gt; [1] "test"
#&gt; 
#&gt; $message
#&gt; [1] "hello"</code></pre>
<p>We then call <code><a href="https://rdrr.io/pkg/OSUICode/man/update_tabler_progress.html">update_tabler_progress()</a></code> with some random parameters and capture the
last sent message in the <code>res</code> variable:</p>
<div class="sourceCode" id="cb754"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">OSUICode</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/OSUICode/man/update_tabler_progress.html">update_tabler_progress</a></span><span class="op">(</span>
  id <span class="op">=</span> <span class="st">"myprogress"</span>, 
  value <span class="op">=</span> <span class="fl">10</span>, 
  session <span class="op">=</span> <span class="va">session</span>
<span class="op">)</span>
<span class="va">res</span> <span class="op">&lt;-</span> <span class="va">session</span><span class="op">$</span><span class="va">lastCustomMessage</span></code></pre></div>
<div class="importantblock">
<p>Importantly, don’t forget to set the session parameter to <code>session</code>, otherwise,
it will default to <code><a href="https://rdrr.io/pkg/shiny/man/domains.html">shiny::getDefaultReactiveDomain</a></code> which is <code>NULL</code> outside of the Shiny app.</p>
</div>
<p>Now we can set expectations:</p>
<ul>
<li>
<code>res</code> must be a list of length 2.</li>
<li>The expected custom handler type is <code>update-progress</code>.</li>
<li>The sent value is 10.</li>
<li>The sent id is <code>myprogress</code>.</li>
</ul>
<p>and translate into <a href="https://testthat.r-lib.org">testthat</a>:</p>
<div class="sourceCode" id="cb755"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://testthat.r-lib.org/reference/test_that.html">test_that</a></span><span class="op">(</span><span class="st">"update progress works"</span>, <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/pkg/OSUICode/man/update_tabler_progress.html">update_tabler_progress</a></span><span class="op">(</span>
    id <span class="op">=</span> <span class="st">"myprogress"</span>, 
    value <span class="op">=</span> <span class="fl">10</span>, 
    session <span class="op">=</span> <span class="va">session</span>
  <span class="op">)</span>
  <span class="va">res</span> <span class="op">&lt;-</span> <span class="va">session</span><span class="op">$</span><span class="va">lastCustomMessage</span>
  
  <span class="fu"><a href="https://testthat.r-lib.org/reference/expect_length.html">expect_length</a></span><span class="op">(</span><span class="va">res</span>, <span class="fl">2</span><span class="op">)</span>
  <span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span><span class="va">res</span><span class="op">$</span><span class="va">type</span>, <span class="st">"update-progress"</span><span class="op">)</span>
  <span class="fu"><a href="https://testthat.r-lib.org/reference/expect_length.html">expect_length</a></span><span class="op">(</span><span class="va">res</span><span class="op">$</span><span class="va">message</span>, <span class="fl">2</span><span class="op">)</span>
  <span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span><span class="va">res</span><span class="op">$</span><span class="va">message</span><span class="op">$</span><span class="va">id</span>, <span class="st">"myprogress"</span><span class="op">)</span>
  <span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span><span class="va">res</span><span class="op">$</span><span class="va">message</span><span class="op">$</span><span class="va">value</span>, <span class="fl">10</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span></code></pre></div>
<pre><code>#&gt; Test passed 😸</code></pre>
<p>This test being set, it ensures to seamlessly capture any breaking change in the API.</p>
</div>
<div id="custom-templates-testing-js" class="section level4">
<h4>
<span class="header-section-number">20.2.1.2</span> JS side<a class="anchor" aria-label="anchor" href="#custom-templates-testing-js"><i class="fas fa-link"></i></a>
</h4>
<p>In the following, we have to test whether the corresponding JS handler works as expected:</p>
<div class="sourceCode" id="cb757"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb757-1"><a href="custom-templates-testing.html#cb757-1"></a><span class="va">Shiny</span>.<span class="at">addCustomMessageHandler</span>(</span>
<span id="cb757-2"><a href="custom-templates-testing.html#cb757-2"></a>  <span class="st">'update-progress'</span><span class="op">,</span> <span class="kw">function</span>(message) <span class="op">{</span></span>
<span id="cb757-3"><a href="custom-templates-testing.html#cb757-3"></a>    <span class="at">$</span>(<span class="st">'#'</span> <span class="op">+</span> <span class="va">message</span>.<span class="at">id</span>)</span>
<span id="cb757-4"><a href="custom-templates-testing.html#cb757-4"></a>      .<span class="at">css</span>(<span class="st">'width'</span><span class="op">,</span> <span class="va">message</span>.<span class="at">value</span> <span class="op">+</span><span class="st">'%'</span>)</span>
<span id="cb757-5"><a href="custom-templates-testing.html#cb757-5"></a>      .<span class="at">attr</span>(<span class="st">'aria-valuenow'</span><span class="op">,</span> <span class="va">message</span>.<span class="at">value</span>)<span class="op">;</span></span>
<span id="cb757-6"><a href="custom-templates-testing.html#cb757-6"></a><span class="op">}</span>)<span class="op">;</span></span></code></pre></div>
<p>We leverage the <a href="https://github.com/ColinFay/crrry">crrry</a> packages developed by Colin Fay from ThinkR.
Overall, <a href="https://github.com/ColinFay/crrry">crrry</a> is an adaptation of <a href="https://rlesur.github.io/crrri/">crrri</a>, specifically optimized for <a href="https://shiny.rstudio.com/">shiny</a>, which is a native Chrome Remote Interface in R using the Chrome Debugging Protocol. In other words, it provides tools to programmatically control
the web browser and do many things like inspecting a web page,
taking screenshots, testing… You may know <a href="https://github.com/rstudio/shinytest">shinytest</a> that relies on another technology,
phantomjs. The latter does not play well with <code>Bootstrap 4</code> templates, which is why we don’t use it
here.</p>
<div class="noteblock">
<p><a href="https://github.com/ColinFay/crrry">crrry</a> is already introduced in the <code>Engineering Production-Grade Shiny Apps</code> <a href="https://engineering-shiny.org/step-secure.html#testing-the-interactive-logic">book</a> <span class="citation">(Fay et al. <a href="references.html#ref-thinkrShiny" role="doc-biblioref">2020</a>)</span>.</p>
</div>
<p>The first step is to call the <code><a href="https://rdrr.io/pkg/OSUICode/man/update_tabler_progress.html">update_tabler_progress()</a></code> example locally and add the returned
url to the following code. We run the app in another process with <a href="https://processx.r-lib.org">processx</a>:</p>
<div class="sourceCode" id="cb758"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu">processx</span><span class="fu">::</span><span class="va"><a href="http://processx.r-lib.org/reference/process.html">process</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>
  <span class="st">"Rscript"</span>, 
  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
    <span class="st">"-e"</span>,  
    <span class="st">"options('shiny.port'= 3515);
     OSUICode::run_example('tabler/update-progress')"</span>
  <span class="op">)</span>
<span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/Sys.sleep.html">Sys.sleep</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span>

<span class="va">p</span><span class="op">$</span><span class="fu">is_alive</span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; [1] TRUE</span></code></pre></div>
<p>That way, we can run our test in the main R process, after checking that our task <code>p</code> is alive. Here the app
loads immediately but you may wait some time if there are computations:</p>
<div class="sourceCode" id="cb759"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/ColinFay/crrry">crrry</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://testthat.r-lib.org">testthat</a></span><span class="op">)</span>
<span class="va">test</span> <span class="op">&lt;-</span> <span class="va"><a href="https://rdrr.io/pkg/crrry/man/CrrryOnPage.html">CrrryOnPage</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>
  chrome_bin <span class="op">=</span> <span class="fu">pagedown</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pagedown/man/find_chrome.html">find_chrome</a></span><span class="op">(</span><span class="op">)</span>,
  chrome_port <span class="op">=</span> <span class="fu">httpuv</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/httpuv/man/randomPort.html">randomPort</a></span><span class="op">(</span><span class="op">)</span>,
  url <span class="op">=</span> <span class="st">"http://localhost:3515/"</span>,
  headless <span class="op">=</span> <span class="cn">TRUE</span>
<span class="op">)</span>
<span class="co">#&gt; Running '/Applications/Google Chrome.app/...' </span>
<span class="co">#&gt;   '--no-first-run --headless' \</span>
<span class="co">#&gt;   '--user-data-dir=/Users/david/Library/...' \</span>
<span class="co">#&gt;   '--remote-debugging-port=31683'</span></code></pre></div>
<p>We wait Shiny to be ready:</p>
<div class="sourceCode" id="cb760"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">test</span><span class="op">$</span><span class="fu">wait_for_shiny_ready</span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; Shiny is computing</span>
<span class="co">#&gt; ✔ Shiny is still running</span></code></pre></div>
<p>Note the output of <code>--remote-debugging-port=31683</code> that gives the link to the Chrome devtools link
to inspect the current app, as shown Figure <a href="custom-templates-testing.html#fig:tabler-crrry-debug">20.1</a>. In practice, open a web browser window and type <code>localhost:&lt;REMOTE-DEBUGGING-PORT&gt;</code>. Follow the instructions and select the <code>Console</code> tab within the developer tools.</p>
<div class="figure">
<span id="fig:tabler-crrry-debug"></span>
<img src="images/practice/tabler-crrry-debug.png" alt="Tabler progress bar debug tools" width="100%"><p class="caption">
FIGURE 20.1: Tabler progress bar debug tools
</p>
</div>
<p>It is now time to write the JS testing logic. We know that moving the slider triggers
the <code><a href="https://rdrr.io/pkg/OSUICode/man/update_tabler_progress.html">update_tabler_progress()</a></code> function. This is how we change the slider value,
thanks to the noUiSlider <a href="https://refreshless.com/nouislider/slider-read-write/#section-setting">API</a>. We first
select the slider DOM element and call <code>noUiSlider.set</code> on the selected instance:</p>
<div class="sourceCode" id="cb761"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb761-1"><a href="custom-templates-testing.html#cb761-1"></a><span class="kw">var</span> slider <span class="op">=</span> <span class="va">document</span>.<span class="at">getElementById</span>(<span class="st">'progress_value'</span>)<span class="op">;</span></span>
<span id="cb761-2"><a href="custom-templates-testing.html#cb761-2"></a><span class="va">slider</span>.<span class="va">noUiSlider</span>.<span class="at">set</span>(<span class="dv">50</span>)<span class="op">;</span></span></code></pre></div>
<p>We use <code>call_js()</code> to update the slider value within our testing pipeline (R side):</p>
<div class="sourceCode" id="cb762"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">test</span><span class="op">$</span><span class="fu">call_js</span><span class="op">(</span>
  <span class="st">"var slider = document.getElementById('progress_value');
   slider.noUiSlider.set(50);
  "</span>
<span class="op">)</span>
<span class="co">#&gt; ── Launching JS: var slider = document.getElementById('progress_value');</span>
<span class="co">#&gt;     slider.noUiSlider.set(50);</span>
<span class="co">#&gt;     ───────────────────────────────────────────────────────────</span>
<span class="co">#&gt; Shiny is computing</span>
<span class="co">#&gt; ✔ Shiny is still running</span></code></pre></div>
<p>According to Figure <a href="custom-templates-testing.html#fig:tabler-crrry-debug-2">20.2</a>, the slider is properly updated,
the progress bar also seems to have the expected value.</p>
<div class="figure">
<span id="fig:tabler-crrry-debug-2"></span>
<img src="images/practice/tabler-crrry-debug-2.png" alt="Updated slider" width="100%"><p class="caption">
FIGURE 20.2: Updated slider
</p>
</div>
<p>We recover the progress value knowing that it is contained in the <code>aria-valuenow</code>
attribute, as a string. We have to convert it to a number with <code>parseInt</code>:</p>
<div class="sourceCode" id="cb763"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">val</span> <span class="op">&lt;-</span> <span class="va">test</span><span class="op">$</span><span class="fu">call_js</span><span class="op">(</span>
  <span class="st">"parseInt($('#progress1').attr('aria-valuenow'), 10);
  "</span>
<span class="op">)</span>
<span class="co">#&gt; ── Launching JS: parseInt($('#progress1').attr('aria-valuenow'), 10);</span>
<span class="co">#&gt;     ──────────────────────────────────────────────────────────────</span>
<span class="co">#&gt; Shiny is computing</span>
<span class="co">#&gt; ✔ Shiny is still running</span>
<span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span><span class="va">val</span><span class="op">$</span><span class="va">result</span><span class="op">$</span><span class="va">value</span>, <span class="fl">50</span><span class="op">)</span>

<span class="co"># Will fail </span>
<span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span><span class="va">val</span><span class="op">$</span><span class="va">result</span><span class="op">$</span><span class="va">value</span>, <span class="fl">30</span><span class="op">)</span>
<span class="co">#&gt; Error: val$result$value not equal to 30.</span>
<span class="co">#&gt; 1/1 mismatches</span>
<span class="co">#&gt; [1] 50 - 30 == 20</span>

<span class="co"># stop the test whenever satisfied</span>
<span class="va">test</span><span class="op">$</span><span class="kw">stop</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p>The test is a success, meaning that <code><a href="https://rdrr.io/pkg/OSUICode/man/update_tabler_progress.html">update_tabler_progress()</a></code>, especially the associated
custom message handler, works. This test was simple and did not involve any input elements.
Yet, <a href="https://github.com/ColinFay/crrry">crrry</a> also support setting input values with <code>shiny_set_input(id, value)</code>.</p>
</div>
</div>
<div id="test-input-bindings" class="section level3">
<h3>
<span class="header-section-number">20.2.2</span> Test input bindings<a class="anchor" aria-label="anchor" href="#test-input-bindings"><i class="fas fa-link"></i></a>
</h3>
<p>We decide to add more complexity and show how to test a home made <strong>input binding</strong>. We are going to test the tabler navbar JavaScript logic developed in Chapter <a href="custom-templates-inputs.html#custom-templates-inputs-navbar">18.3</a>. Before starting to test, we define the expectations:</p>
<ul>
<li>If no <code><a href="https://rdrr.io/pkg/OSUICode/man/tabler_navbar_menu_item.html">tabler_navbar_menu_item()</a></code> is selected by default, at start, the first item is selected.
It must have the <code>active</code> class on it. Hence, we have to check whether the first <code>&lt;a class="nav-link"&gt;</code>
has the active class.</li>
<li>Moreover, if one item is selected at start, we have to make sure this item has the <code>active</code> class.</li>
<li>We have to ensure that clicking on another link switch the currently selected link so that
the corresponding input on the R side is properly updated.</li>
<li>When we call <code><a href="https://rdrr.io/pkg/OSUICode/man/update_tabler_tab_item.html">update_tabler_tab_item()</a></code> we have to check whether the active link is
successfully changed.</li>
<li>Each time a navbar item is active, the corresponding body <code><a href="https://rdrr.io/pkg/OSUICode/man/tabler_tab_item.html">tabler_tab_item()</a></code> must hold the
<code>active show</code> class, to make sure the tab content is visible. Only on tab may have those classes at a time.</li>
</ul>
<p>As described above, we run our app in another R process, so as to keep the main process
for the test:</p>
<div class="sourceCode" id="cb764"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu">processx</span><span class="fu">::</span><span class="va"><a href="http://processx.r-lib.org/reference/process.html">process</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>
  <span class="st">"Rscript"</span>, 
  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
    <span class="st">"-e"</span>,  
    <span class="st">"options('shiny.port'= 3515); 
    OSUICode::run_example('tabler/update-navbar')"</span> 
  <span class="op">)</span>
<span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/Sys.sleep.html">Sys.sleep</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span>

<span class="va">p</span><span class="op">$</span><span class="fu">is_alive</span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; [1] TRUE</span>

<span class="va">test</span> <span class="op">&lt;-</span> <span class="va"><a href="https://rdrr.io/pkg/crrry/man/CrrryOnPage.html">CrrryOnPage</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>
  chrome_bin <span class="op">=</span> <span class="fu">pagedown</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pagedown/man/find_chrome.html">find_chrome</a></span><span class="op">(</span><span class="op">)</span>,
  chrome_port <span class="op">=</span> <span class="fu">httpuv</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/httpuv/man/randomPort.html">randomPort</a></span><span class="op">(</span><span class="op">)</span>,
  url <span class="op">=</span> <span class="st">"http://localhost:3515/"</span>,
  headless <span class="op">=</span> <span class="cn">TRUE</span>
<span class="op">)</span>
<span class="co">#&gt; Running '/Applications/Google Chrome.app/...' </span>
<span class="co">#&gt;   '--no-first-run --headless' \</span>
<span class="co">#&gt;   '--user-data-dir=/Users/david/Library/...' \</span>
<span class="co">#&gt;   '--remote-debugging-port=11028'</span>

<span class="va">test</span><span class="op">$</span><span class="fu">wait_for_shiny_ready</span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; Shiny is computing</span>
<span class="co">#&gt; ✔ Shiny is still running</span></code></pre></div>
<p>After running the above code, browse to <code>localhost:&lt;REMOTE-DEBUGGING-PORT&gt;</code> and you should get what is shown on Figure <a href="custom-templates-testing.html#fig:tabler-crrry-debug-3">20.3</a>.</p>
<div class="figure">
<span id="fig:tabler-crrry-debug-3"></span>
<img src="images/practice/tabler-crrry-debug-3.png" alt="Tabler navbar example with debug tools" width="100%"><p class="caption">
FIGURE 20.3: Tabler navbar example with debug tools
</p>
</div>
<p>At start, no link was selected, meaning we expect the first link to be active and shown. The navbar
may be targeted using the <code>navbar-nav</code> class and we use <code>find</code> to locate the active child, which must
have the <code>nav-link active</code> classes. We also control that only one item is selected by inspecting the length
of the active nav link items. We extract its index with <code>index</code> which is contained in the <code>data-value</code> attribute:</p>
<div class="sourceCode" id="cb765"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">active</span> <span class="op">&lt;-</span> <span class="va">test</span><span class="op">$</span><span class="fu">call_js</span><span class="op">(</span>
  <span class="st">"$('.navbar-nav').find('.nav-link.active').length"</span>
<span class="op">)</span>
<span class="co">#&gt; ── Launching JS: $('.navbar-nav').find('.nav-link.active').length </span>
<span class="co">#&gt;     ───────────────────────────────────────────────────────────</span>
<span class="co">#&gt; Shiny is computing</span>
<span class="co">#&gt; ✔ Shiny is still running</span>
<span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span><span class="va">active</span><span class="op">$</span><span class="va">result</span><span class="op">$</span><span class="va">value</span>, <span class="fl">1</span><span class="op">)</span>

<span class="va">test</span><span class="op">$</span><span class="fu">wait_for_shiny_ready</span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; Shiny is computing</span>
<span class="co">#&gt; ✔ Shiny is still running</span>

<span class="va">res1</span> <span class="op">&lt;-</span> <span class="va">test</span><span class="op">$</span><span class="fu">call_js</span><span class="op">(</span>
  <span class="st">"$('.navbar-nav')
    .find('.nav-link.active')
    .attr('data-value')"</span>
<span class="op">)</span>
<span class="co">#&gt; ── Launching JS: $('.navbar-nav')</span>
<span class="co">#&gt;     .find('.nav-link.active')</span>
<span class="co">#&gt;     .attr('data-value')</span>
<span class="co">#&gt;     ───────────────────────────────────────────────────────────</span>
<span class="co">#&gt; Shiny is computing</span>
<span class="co">#&gt; ✔ Shiny is still running</span>
<span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span><span class="va">res1</span><span class="op">$</span><span class="va">result</span><span class="op">$</span><span class="va">value</span>, <span class="st">"tab1"</span><span class="op">)</span></code></pre></div>
<p>Now let’s see whether to body tab has the good index. We target the <code>tab-content</code> class and look
for the element having <code>active show</code> classes. We recover its id which contains the tab name:</p>
<div class="sourceCode" id="cb766"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">res2</span> <span class="op">&lt;-</span> <span class="va">test</span><span class="op">$</span><span class="fu">call_js</span><span class="op">(</span>
  <span class="st">"$('.tab-content').find('.active.show').attr('id')"</span>
<span class="op">)</span>
<span class="co">#&gt; ── Launching JS: $('.tab-content').find('.active.show').attr('id') </span>
<span class="co">#&gt;     ───────────────────────────────────────────────────────────</span>
<span class="co">#&gt; Shiny is computing</span>
<span class="co">#&gt; ✔ Shiny is still running</span>
<span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span><span class="va">res1</span><span class="op">$</span><span class="va">result</span><span class="op">$</span><span class="va">value</span>, <span class="va">res2</span><span class="op">$</span><span class="va">result</span><span class="op">$</span><span class="va">value</span><span class="op">)</span></code></pre></div>
<p>We programmatically change the active tab by clicking on the second link, with <code>click</code>. Below we use
<code>.nav-link:eq(1)</code> to select the second link but we could use <code>.nav-link:not(.active)</code> since
we only have 2 links. We also recover the index of the selected link and the corresponding tab. If
everything happens well, we expect their value to be 2:</p>
<div class="sourceCode" id="cb767"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">test</span><span class="op">$</span><span class="fu">call_js</span><span class="op">(</span><span class="st">"$('.navbar-nav .nav-link:eq(1)').click();"</span><span class="op">)</span>

<span class="va">res3</span> <span class="op">&lt;-</span> <span class="va">test</span><span class="op">$</span><span class="fu">call_js</span><span class="op">(</span>
  <span class="st">"$('.navbar-nav')
    .find('.nav-link.active')
    .attr('data-value')"</span>
<span class="op">)</span>
<span class="co">#&gt; ── Launching JS: $('.navbar-nav')</span>
<span class="co">#&gt;     .find('.nav-link.active')</span>
<span class="co">#&gt;     .attr('data-value') </span>
<span class="co">#&gt;     ───────────────────────────────────────────────────────────</span>
<span class="co">#&gt; Shiny is computing</span>
<span class="co">#&gt; ✔ Shiny is still running</span>
<span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span><span class="va">res3</span><span class="op">$</span><span class="va">result</span><span class="op">$</span><span class="va">value</span>, <span class="st">"tab2"</span><span class="op">)</span>

<span class="va">test</span><span class="op">$</span><span class="fu">wait_for_shiny_ready</span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; Shiny is computing</span>
<span class="co">#&gt; ✔ Shiny is still running</span>

<span class="va">res4</span> <span class="op">&lt;-</span> <span class="va">test</span><span class="op">$</span><span class="fu">call_js</span><span class="op">(</span>
  <span class="st">"$('.tab-content')
    .find('.active.show')
    .attr('id')"</span>
<span class="op">)</span>
<span class="co">#&gt; ── Launching JS: $('.tab-content')</span>
<span class="co">#&gt;     .find('.active.show')</span>
<span class="co">#&gt;     .attr('id')</span>
<span class="co">#&gt;     ───────────────────────────────────────────────────────────</span>
<span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span><span class="va">res3</span><span class="op">$</span><span class="va">result</span><span class="op">$</span><span class="va">value</span>, <span class="va">res4</span><span class="op">$</span><span class="va">result</span><span class="op">$</span><span class="va">value</span><span class="op">)</span></code></pre></div>
<p>We then click on the “change tab” button, that has the <code>update</code> id. The latter,
actually triggers <code><a href="https://rdrr.io/pkg/OSUICode/man/update_tabler_tab_item.html">update_tabler_tab_item()</a></code>. We also want to check its behavior and expect
to be back on tab 1:</p>
<div class="sourceCode" id="cb768"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">test</span><span class="op">$</span><span class="fu">call_js</span><span class="op">(</span><span class="st">"$('#update').click();"</span><span class="op">)</span>
<span class="co">#&gt; ── Launching JS: $('#update').click(); </span>
<span class="co">#&gt;     ───────────────────────────────────────────────────────────</span>
<span class="co">#&gt; Shiny is computing</span>
<span class="co">#&gt; ✔ Shiny is still running</span>

<span class="va">res5</span> <span class="op">&lt;-</span> <span class="va">test</span><span class="op">$</span><span class="fu">call_js</span><span class="op">(</span>
  <span class="st">"$('.navbar-nav')
    .find('.nav-link.active')
    .attr('data-value')"</span>
<span class="op">)</span>
<span class="co">#&gt; ── Launching JS: $('.navbar-nav')</span>
<span class="co">#&gt;     .find('.nav-link.active')</span>
<span class="co">#&gt;     .attr('data-value')</span>
<span class="co">#&gt;     ───────────────────────────────────────────────────────────</span>
<span class="co">#&gt; Shiny is computing</span>
<span class="co">#&gt; ✔ Shiny is still running</span>
<span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span><span class="va">res5</span><span class="op">$</span><span class="va">result</span><span class="op">$</span><span class="va">value</span>, <span class="st">"tab1"</span><span class="op">)</span>

<span class="va">test</span><span class="op">$</span><span class="fu">wait_for_shiny_ready</span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; Shiny is computing</span>
<span class="co">#&gt; ✔ Shiny is still running</span>

<span class="va">res6</span> <span class="op">&lt;-</span> <span class="va">test</span><span class="op">$</span><span class="fu">call_js</span><span class="op">(</span>
  <span class="st">"$('.tab-content')
    .find('.active.show')
    .attr('id')"</span>
<span class="op">)</span>
<span class="co">#&gt; Shiny is computing</span>
<span class="co">#&gt; ✔ Shiny is still running</span>
<span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span><span class="va">res5</span><span class="op">$</span><span class="va">result</span><span class="op">$</span><span class="va">value</span>, <span class="va">res6</span><span class="op">$</span><span class="va">result</span><span class="op">$</span><span class="va">value</span><span class="op">)</span></code></pre></div>
<p>If the test is successful, it means that the <code>receiveMessage</code> and <code>setValue</code> methods
work as expected. We finally test the input value by setting its value to <code>tab2</code> with <code>shiny_set_input</code>.
All Shiny input values are stored in the <code>Shiny.shinyapp.$inputValues</code> object, as shown in Chapter <a href="shiny-input-lifecycle.html#shiny-input-lifecycle">13</a>:</p>
<div class="sourceCode" id="cb769"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">test</span><span class="op">$</span><span class="fu">shiny_set_input</span><span class="op">(</span><span class="st">"current_tab"</span>, <span class="st">"tab2"</span><span class="op">)</span>
<span class="co">#&gt; ── Setting id current_tab with value tab2 </span>
<span class="co">#&gt;     ───────────────────────────────────────────────────────────</span>
<span class="co">#&gt; Shiny is computing</span>
<span class="co">#&gt; ✔ Shiny is still running</span>
<span class="va">tab_input</span> <span class="op">&lt;-</span> <span class="va">test</span><span class="op">$</span><span class="fu">call_js</span><span class="op">(</span>
  <span class="st">"Shiny.shinyapp.$inputValues.current_tab"</span>
<span class="op">)</span>
<span class="co">#&gt; ── Launching JS: Shiny.shinyapp.$inputValues.current_tab </span>
<span class="co">#&gt;     ───────────────────────────────────────────────────────────</span>
<span class="co">#&gt; Shiny is computing</span>
<span class="co">#&gt; ✔ Shiny is still running</span>
<span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span><span class="va">tab_input</span><span class="op">$</span><span class="va">result</span><span class="op">$</span><span class="va">value</span>, <span class="st">"tab2"</span><span class="op">)</span>
<span class="va">test</span><span class="op">$</span><span class="kw">stop</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p>This does not effect the navbar but triggers the notification.</p>
<p>As an exercise, we leave the reader to write a test to check the app behavior when
the second tab is active at start.</p>

</div>
</div>
</div>



<div class="chapter-nav">
<div class="prev"><a href="custom-templates-interactivity.html"><span class="header-section-number">19</span> Adding more interactivity</a></div>
<div class="next"><a href="workflow-charpente.html"><span class="header-section-number">21</span> Introduction to {charpente}</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#custom-templates-testing"><span class="header-section-number">20</span> Testing and validating templates elements</a></li>
<li>
<a class="nav-link" href="#validate-template-functions"><span class="header-section-number">20.1</span> Validate template functions</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#create-your-own-validations"><span class="header-section-number">20.1.1</span> Create your own validations</a></li>
<li><a class="nav-link" href="#existing-utils-functions"><span class="header-section-number">20.1.2</span> Existing utils functions</a></li>
<li><a class="nav-link" href="#example-refine-navbar-menu-items"><span class="header-section-number">20.1.3</span> Example: refine navbar menu items</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#testing-templates-elements"><span class="header-section-number">20.2</span> Testing templates elements</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#testing-template-behavior"><span class="header-section-number">20.2.1</span> Testing template behavior</a></li>
<li><a class="nav-link" href="#test-input-bindings"><span class="header-section-number">20.2.2</span> Test input bindings</a></li>
</ul>
</li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/DivadNojnarg/outstanding-shiny-ui/blob/master/custom-templates-testing.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/DivadNojnarg/outstanding-shiny-ui/edit/master/custom-templates-testing.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>
</div>
  

  

</div>
 <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Outstanding User Interfaces with Shiny</strong>" was written by David Granjon. It was last built on 2021-09-08.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>
</html>
