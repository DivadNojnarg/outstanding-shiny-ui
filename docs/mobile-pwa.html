<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Chapter 25 {shinyMobile} and PWA | Outstanding User Interfaces with Shiny</title>
<meta name="author" content="David Granjon">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.2"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.5.1/jquery-3.5.1.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.2.5.9002/transition.js"></script><script src="libs/bs3compat-0.2.5.9002/tabs.js"></script><script src="libs/bs3compat-0.2.5.9002/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="libs/accessible-code-block-0.0.1/empty-anchor.js"></script><script src="https://cdn.jsdelivr.net/autocomplete.js/0/autocomplete.jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/mark.js@8.11.1/dist/mark.min.js"></script><!-- CSS --><link rel="stylesheet" href="css/style.css">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">Outstanding User Interfaces with Shiny</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">Welcome</a></li>
<li><a class="" href="foreword.html">Foreword</a></li>
<li class="book-part">Introduction</li>
<li><a class="" href="web-intro.html"><span class="header-section-number">1</span> Shiny and the Web</a></li>
<li><a class="" href="htmltools-overview.html"><span class="header-section-number">2</span> Mastering {htmltools}</a></li>
<li><a class="" href="web-dependencies.html"><span class="header-section-number">3</span> Discover Shiny dependencies</a></li>
<li><a class="" href="htmltools-dependencies.html"><span class="header-section-number">4</span> Dependency utilities</a></li>
<li><a class="" href="web-applications.html"><span class="header-section-number">5</span> Web application concepts</a></li>
<li class="book-part">Beautify with CSS and Sass</li>
<li><a class="" href="beautify-css.html"><span class="header-section-number">6</span> CSS for Shiny</a></li>
<li><a class="" href="beautify-sass.html"><span class="header-section-number">7</span> Introduction to Sass</a></li>
<li><a class="" href="beautify-with-fresh.html"><span class="header-section-number">8</span> Beautify with {fresh}</a></li>
<li><a class="" href="beautify-with-bootstraplib.html"><span class="header-section-number">9</span> Beautify with {bslib}</a></li>
<li class="book-part">Unleash interactivity with JavaScript</li>
<li><a class="" href="survival-kit-javascript.html"><span class="header-section-number">10</span> JavaScript for Shiny</a></li>
<li><a class="" href="shiny-intro.html"><span class="header-section-number">11</span> R and JS</a></li>
<li><a class="" href="shiny-input-system.html"><span class="header-section-number">12</span> Shiny’s input system</a></li>
<li><a class="" href="shiny-input-lifecycle.html"><span class="header-section-number">13</span> Shiny inputs lifecycles</a></li>
<li><a class="" href="shiny-input-gems.html"><span class="header-section-number">14</span> Mastering Shiny’s events</a></li>
<li><a class="" href="shiny-custom-handler.html"><span class="header-section-number">15</span> Dynamically manage content with handlers</a></li>
<li class="book-part">Practice 1: a dashboard template</li>
<li><a class="" href="custom-templates-selection.html"><span class="header-section-number">16</span> Template selection</a></li>
<li><a class="" href="custom-templates-dependencies.html"><span class="header-section-number">17</span> Define dependencies</a></li>
<li><a class="" href="custom-templates-skeleton.html"><span class="header-section-number">18</span> Create template elements</a></li>
<li><a class="" href="custom-templates-inputs.html"><span class="header-section-number">19</span> Develop custom input widgets</a></li>
<li><a class="" href="custom-templates-interactivity.html"><span class="header-section-number">20</span> Adding more interactivity</a></li>
<li><a class="" href="custom-templates-testing.html"><span class="header-section-number">21</span> Testing and validating templates elements</a></li>
<li class="book-part">Toward a better workflow</li>
<li><a class="" href="workflow-charpente.html"><span class="header-section-number">22</span> Introduction to {charpente}</a></li>
<li class="book-part">Case study 2: Mobile development with Shiny</li>
<li><a class="" href="mobile-shiny-intro.html"><span class="header-section-number">23</span> Introduction</a></li>
<li><a class="" href="mobile-shinyMobile.html"><span class="header-section-number">24</span> Reconstruct {shinyMobile}</a></li>
<li><a class="active" href="mobile-pwa.html"><span class="header-section-number">25</span> {shinyMobile} and PWA</a></li>
<li><a class="" href="mobile-widgets.html"><span class="header-section-number">26</span> Design widgets</a></li>
<li><a class="" href="mobile-going-further.html"><span class="header-section-number">27</span> Fine tune {shinyMobile}</a></li>
<li class="book-part">Going further</li>
<li><a class="" href="going-further-reactR.html"><span class="header-section-number">28</span> R + Shiny + React: welcome {reactR}</a></li>
<li><a class="" href="going-further-where-to-go.html"><span class="header-section-number">29</span> What to do next?</a></li>
<li class="book-part">Appendix</li>
<li><a class="" href="code-outputs.html"><span class="header-section-number">A</span> Code outputs</a></li>
<li><a class="" href="references.html">References</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/DivadNojnarg/outstanding-shiny-ui">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="mobile-pwa" class="section level1">
<h1>
<span class="header-section-number">25</span> <code>{shinyMobile}</code> and PWA<a class="anchor" aria-label="anchor" href="#mobile-pwa"><i class="fas fa-link"></i></a>
</h1>
<p>Transforming a classic Shiny app into a <strong>PWA</strong> is a game changer for end users.
The first step is to setup a valid <strong>web manifest</strong> with icons and <strong>favicon</strong>.</p>
<div class="importantblock">
<p>Some of the PWA features won’t work with <a href="https://medium.com/@firt/progressive-web-apps-on-ios-are-here-d00430dee3a7">iOS</a>, like the
install prompt.</p>
</div>
<div class="warningblock">
<p>As a reminder, the code examples shown throughout this chapter are gathered in the <code>{OSUICode}</code> package accessible <a href="https://github.com/DivadNojnarg/outstanding-shiny-ui-code">here</a>, specifically PWA apps are available <a href="https://github.com/DivadNojnarg/outstanding-shiny-ui-code/tree/master/inst/shinyMobile/pwa">here</a>.</p>
</div>
<div id="introduction-5" class="section level2">
<h2>
<span class="header-section-number">25.1</span> Introduction<a class="anchor" aria-label="anchor" href="#introduction-5"><i class="fas fa-link"></i></a>
</h2>
<p>Below, we review one by one the necessary steps to convert a shiny app to a PWA.
To get a good idea of what our mission exactly is, we leverage the <code>Application</code> tab of the
developer tools.</p>
<p>The overall expected result is shown Figure <a href="mobile-pwa.html#fig:mobile-pwa-1">25.1</a>. Alternatively, one
may use the <a href="https://developers.google.com/web/tools/lighthouse/">Google Lighthouse</a> utility to provide a general diagnosis to the app, as illustrated on Figure <a href="mobile-pwa.html#fig:mobile-pwa-2">25.2</a>. There are many categories like performance, accessibility. In our case, let’s just select the PWA category, check the mobile device radio and click on generate a report.</p>
<div class="figure" style="text-align: center">
<span id="fig:mobile-pwa-1"></span>
<img src="images/mobile/mobile-pwa-application.png" alt="Application tab of the developers tools" width="100%"><p class="caption">
FIGURE 25.1: Application tab of the developers tools
</p>
</div>
<div class="figure" style="text-align: center">
<span id="fig:mobile-pwa-2"></span>
<img src="images/mobile/mobile-pwa-lighthouse.png" alt="Google Lightouse utility" width="100%"><p class="caption">
FIGURE 25.2: Google Lightouse utility
</p>
</div>
<p>According to the diagnostic result displayed on Figure <a href="mobile-pwa.html#fig:mobile-pwa-lighthouse-result">25.3</a>, we don’t meet all requirements, most importantly there is:</p>
<ul>
<li>No manifest.</li>
<li>No service worker.</li>
<li>No icons.</li>
</ul>
<div class="figure">
<span id="fig:mobile-pwa-lighthouse-result"></span>
<img src="images/mobile/mobile-pwa-lighthouse-result.png" alt="Lighthouse audit result" width="100%"><p class="caption">
FIGURE 25.3: Lighthouse audit result
</p>
</div>
</div>
<div id="charpente-and-pwa-tools" class="section level2">
<h2>
<span class="header-section-number">25.2</span> <code>{charpente}</code> and PWA tools<a class="anchor" aria-label="anchor" href="#charpente-and-pwa-tools"><i class="fas fa-link"></i></a>
</h2>
<p><a href="https://github.com/RinteRface/charpente">charpente</a> has tools to help design a PWA, particularly the <code>set_pwa</code> function which does all the previously mentioned steps in only one line of code. There are however a few prerequisites:</p>
<ul>
<li>The app must <strong>belong to a package</strong>.</li>
<li>The function must target the app directory.</li>
</ul>
<p>Let’s create a <code>inst/examples/pwa-app</code> sub-folder and the <code>app.R</code> file:</p>
<div class="sourceCode" id="cb850"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://shiny.rstudio.com/">shiny</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/RinteRface/shinyMobile">shinyMobile</a></span><span class="op">)</span>

<span class="va">ui</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/OSUICode/man/f7_page.html">f7_page</a></span><span class="op">(</span>
  <span class="st">"Test"</span>,
  navbar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/OSUICode/man/f7_navbar.html">f7_navbar</a></span><span class="op">(</span><span class="st">"Title"</span><span class="op">)</span>,
  toolbar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/OSUICode/man/f7_toolbar.html">f7_toolbar</a></span><span class="op">(</span><span class="op">)</span>,
  title <span class="op">=</span> <span class="st">"shinyMobile"</span>,
  options <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
    theme <span class="op">=</span> <span class="st">"ios"</span>,
    version <span class="op">=</span> <span class="st">"1.0.0"</span>,
    touch <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
      tapHold <span class="op">=</span> <span class="cn">TRUE</span>
    <span class="op">)</span>,
    color <span class="op">=</span> <span class="st">"#42f5a1"</span>,
    filled <span class="op">=</span> <span class="cn">TRUE</span>,
    dark <span class="op">=</span> <span class="cn">TRUE</span>
  <span class="op">)</span>
<span class="op">)</span>

<span class="va">server</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">input</span>, <span class="va">output</span>, <span class="va">session</span><span class="op">)</span> <span class="op">{</span><span class="op">}</span>
<span class="fu"><a href="https://rdrr.io/pkg/shiny/man/shinyApp.html">shinyApp</a></span><span class="op">(</span><span class="va">ui</span>, <span class="va">server</span><span class="op">)</span></code></pre></div>
<p>Then we set the PWA configuration with <code>set_pwa</code>. Overall, this function generates a <code>manifest.webmanifest</code> file, downloads the Google PWA compatibility
script, adds a custom dependency pointing to the <code>manifest.webmanifest</code> file and a <code>144x144</code> icon file, copies a boilerplate <code>service-worker.js</code> with its <code>offline.html</code> page and registers the service worker (whose code is borrowed from <a href="https://web.dev/offline-fallback-page/#registering-the-service-worker">web.dev</a>):</p>
<div class="sourceCode" id="cb851"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb851-1"><a href="mobile-pwa.html#cb851-1"></a><span class="va">window</span>.<span class="at">addEventListener</span>(<span class="st">'load'</span><span class="op">,</span> () <span class="kw">=&gt;</span> <span class="op">{</span></span>
<span id="cb851-2"><a href="mobile-pwa.html#cb851-2"></a>  <span class="cf">if</span> (<span class="st">'serviceWorker'</span> <span class="kw">in</span> navigator) <span class="op">{</span></span>
<span id="cb851-3"><a href="mobile-pwa.html#cb851-3"></a>    <span class="kw">var</span> pathname <span class="op">=</span> <span class="va">window</span>.<span class="va">location</span>.<span class="at">pathname</span><span class="op">;</span></span>
<span id="cb851-4"><a href="mobile-pwa.html#cb851-4"></a>    <span class="va">navigator</span>.<span class="at">serviceWorker</span></span>
<span id="cb851-5"><a href="mobile-pwa.html#cb851-5"></a>      .<span class="at">register</span>(pathname <span class="op">+</span> <span class="st">'service-worker.js'</span><span class="op">,</span> <span class="op">{</span> <span class="dt">scope</span><span class="op">:</span> pathname<span class="op">}</span>)</span>
<span id="cb851-6"><a href="mobile-pwa.html#cb851-6"></a>      .<span class="at">then</span>(<span class="kw">function</span>() <span class="op">{</span> <span class="va">console</span>.<span class="at">log</span>(<span class="st">'Service Worker Registered'</span>)<span class="op">;</span> <span class="op">}</span>)<span class="op">;</span></span>
<span id="cb851-7"><a href="mobile-pwa.html#cb851-7"></a>  <span class="op">};</span></span>
<span id="cb851-8"><a href="mobile-pwa.html#cb851-8"></a><span class="op">}</span>)<span class="op">;</span></span></code></pre></div>
<p>In the <a href="https://github.com/RinteRface/shinyMobile">shinyMobile</a> case, as Framework7 already registers any provided <strong>service
worker</strong>, we don’t need that initialization script. Therefore, to skip the creation
of <code>sw-register.js</code> and importing it in <code>main.js</code>, we should actually call:</p>
<div class="sourceCode" id="cb852"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/charpente/man/set_pwa.html">set_pwa</a></span><span class="op">(</span><span class="st">"inst/examples/pwa-app"</span>, register_service_worker <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
<p>Importantly, this function does not handle icon creation. There are tools such as
<a href="https://appsco.pe/developer/splash-screens">appsco</a> and
<a href="https://app-manifest.firebaseapp.com">app-manifest</a>, to create
those custom icons and splash screens, if you need to.</p>
<p>In the following, we provide more detail about the mentioned steps.</p>
<div id="create-the-manifest" class="section level3">
<h3>
<span class="header-section-number">25.2.1</span> Create the manifest<a class="anchor" aria-label="anchor" href="#create-the-manifest"><i class="fas fa-link"></i></a>
</h3>
<p>We would like to create a <strong>JSON</strong> configuration file like this:</p>
<div class="sourceCode" id="cb853"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb853-1"><a href="mobile-pwa.html#cb853-1"></a><span class="op">{</span></span>
<span id="cb853-2"><a href="mobile-pwa.html#cb853-2"></a>  <span class="st">"short_name"</span><span class="op">:</span> <span class="st">"My App"</span><span class="op">,</span></span>
<span id="cb853-3"><a href="mobile-pwa.html#cb853-3"></a>  <span class="st">"name"</span><span class="op">:</span> <span class="st">"Super amazing app"</span><span class="op">,</span></span>
<span id="cb853-4"><a href="mobile-pwa.html#cb853-4"></a>  <span class="st">"description"</span><span class="op">:</span> <span class="st">"This app is just mind blowing"</span><span class="op">,</span></span>
<span id="cb853-5"><a href="mobile-pwa.html#cb853-5"></a>  <span class="st">"icons"</span><span class="op">:</span> [</span>
<span id="cb853-6"><a href="mobile-pwa.html#cb853-6"></a>    <span class="op">{</span></span>
<span id="cb853-7"><a href="mobile-pwa.html#cb853-7"></a>      <span class="st">"src"</span><span class="op">:</span> <span class="st">"icons/icon.png"</span><span class="op">,</span></span>
<span id="cb853-8"><a href="mobile-pwa.html#cb853-8"></a>      <span class="st">"type"</span><span class="op">:</span> <span class="st">"image/png"</span><span class="op">,</span></span>
<span id="cb853-9"><a href="mobile-pwa.html#cb853-9"></a>      <span class="st">"sizes"</span><span class="op">:</span> <span class="st">"192x192"</span></span>
<span id="cb853-10"><a href="mobile-pwa.html#cb853-10"></a>    <span class="op">}</span></span>
<span id="cb853-11"><a href="mobile-pwa.html#cb853-11"></a>    <span class="co">// ...</span></span>
<span id="cb853-12"><a href="mobile-pwa.html#cb853-12"></a>  ]<span class="op">,</span></span>
<span id="cb853-13"><a href="mobile-pwa.html#cb853-13"></a>  <span class="st">"start_url"</span><span class="op">:</span> <span class="st">"&lt;APP_URL&gt;"</span><span class="op">,</span></span>
<span id="cb853-14"><a href="mobile-pwa.html#cb853-14"></a>  <span class="st">"background_color"</span><span class="op">:</span> <span class="st">"#3367D6"</span><span class="op">,</span></span>
<span id="cb853-15"><a href="mobile-pwa.html#cb853-15"></a>  <span class="st">"display"</span><span class="op">:</span> <span class="st">"standalone"</span><span class="op">,</span></span>
<span id="cb853-16"><a href="mobile-pwa.html#cb853-16"></a>  <span class="st">"scope"</span><span class="op">:</span> <span class="st">"/"</span><span class="op">,</span></span>
<span id="cb853-17"><a href="mobile-pwa.html#cb853-17"></a>  <span class="st">"theme_color"</span><span class="op">:</span> <span class="st">"#3367D6"</span><span class="op">,</span></span>
<span id="cb853-18"><a href="mobile-pwa.html#cb853-18"></a>  <span class="st">"shortcuts"</span><span class="op">:</span> [</span>
<span id="cb853-19"><a href="mobile-pwa.html#cb853-19"></a>    <span class="op">{</span></span>
<span id="cb853-20"><a href="mobile-pwa.html#cb853-20"></a>      <span class="st">"name"</span><span class="op">:</span> <span class="st">"Open toast"</span><span class="op">,</span></span>
<span id="cb853-21"><a href="mobile-pwa.html#cb853-21"></a>      <span class="st">"short_name"</span><span class="op">:</span> <span class="st">"Shortcut"</span><span class="op">,</span></span>
<span id="cb853-22"><a href="mobile-pwa.html#cb853-22"></a>      <span class="st">"description"</span><span class="op">:</span> <span class="st">"Do something"</span><span class="op">,</span></span>
<span id="cb853-23"><a href="mobile-pwa.html#cb853-23"></a>      <span class="st">"url"</span><span class="op">:</span> <span class="st">"&lt;APP_URL&gt;/..."</span><span class="op">,</span></span>
<span id="cb853-24"><a href="mobile-pwa.html#cb853-24"></a>      <span class="st">"icons"</span><span class="op">:</span> [<span class="op">{</span> <span class="st">"src"</span><span class="op">:</span> <span class="st">"icons/shortcut.png"</span><span class="op">,</span> <span class="st">"sizes"</span><span class="op">:</span> <span class="st">"192x192"</span> <span class="op">}</span>]</span>
<span id="cb853-25"><a href="mobile-pwa.html#cb853-25"></a>    <span class="op">}</span></span>
<span id="cb853-26"><a href="mobile-pwa.html#cb853-26"></a>  ]</span>
<span id="cb853-27"><a href="mobile-pwa.html#cb853-27"></a><span class="op">}</span></span></code></pre></div>
<p>This file has to be accessible by the app, hence best practice is to put it in the <code>/www</code> folder,
icon images being hosted in the <code>/www/icons</code> sub-directory. The <a href="https://github.com/RinteRface/charpente">charpente</a> <code>create_manifest</code> function writes a JSON file at the provided location.
Interestingly the <code>shortcuts</code> fields gives the ability to start the app in a specific state, so that end users save time. This feature is only supported by latest Android devices as well as up to date Windows 10 computers (no Apple support). In practice, the shortcut url can be processed by <code><a href="https://rdrr.io/pkg/shiny/man/parseQueryString.html">shiny::parseQueryString</a></code> on the server side. For instance, if the url contains a query string like <code>https://domain/path/?foo=1</code>, we could do:</p>
<div class="sourceCode" id="cb854"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/shiny/man/observeEvent.html">observeEvent</a></span><span class="op">(</span><span class="va">session</span><span class="op">$</span><span class="va">clientData</span><span class="op">$</span><span class="va">url_search</span>, <span class="op">{</span>
  <span class="va">query</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/parseQueryString.html">parseQueryString</a></span><span class="op">(</span><span class="va">session</span><span class="op">$</span><span class="va">clientData</span><span class="op">$</span><span class="va">url_search</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/req.html">req</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">query</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span>
  <span class="co"># Ways of accessing the values</span>
  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">query</span><span class="op">$</span><span class="va">foo</span><span class="op">)</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">{</span>
    <span class="fu"><a href="https://rinterface.github.io/shinyMobile/reference/f7Toast.html">f7Toast</a></span><span class="op">(</span>text <span class="op">=</span> <span class="st">"Plop"</span><span class="op">)</span>
  <span class="op">}</span>
<span class="op">}</span><span class="op">)</span></code></pre></div>
<p>The web manifest and icons have to be included in the <code>head</code> before the Google PWA compatibility script:</p>
<div class="sourceCode" id="cb855"><pre class="sourceCode html"><code class="sourceCode html"><span id="cb855-1"><a href="mobile-pwa.html#cb855-1"></a><span class="kw">&lt;link</span><span class="ot"> rel=</span><span class="st">"manifest"</span><span class="ot"> href=</span><span class="st">"manifest.webmanifest"</span> <span class="kw">/&gt;</span></span>
<span id="cb855-2"><a href="mobile-pwa.html#cb855-2"></a><span class="co">&lt;!-- include icon also from manifest --&gt;</span></span>
<span id="cb855-3"><a href="mobile-pwa.html#cb855-3"></a><span class="kw">&lt;link</span><span class="ot"> rel=</span><span class="st">"icon"</span><span class="ot"> type=</span><span class="st">"image/png"</span> </span>
<span id="cb855-4"><a href="mobile-pwa.html#cb855-4"></a><span class="ot">  href=</span><span class="st">"icons/icon-144.png"</span><span class="ot"> sizes=</span><span class="st">"144x144"</span> <span class="kw">/&gt;</span></span></code></pre></div>
<p><code><a href="https://rdrr.io/pkg/charpente/man/set_pwa.html">set_pwa()</a></code> internally calls <code><a href="https://rdrr.io/pkg/charpente/man/create_pwa_dependency.html">create_pwa_dependency()</a></code> which creates an HTML <strong>dependency</strong> containing all necessary resources:</p>
<div class="sourceCode" id="cb856"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#' PWA dependencies utils</span>
<span class="co">#'</span>
<span class="co">#' @description This function attaches PWA manifest and icons to the given tag</span>
<span class="co">#'</span>
<span class="co">#' @param tag Element to attach the dependencies.</span>
<span class="co">#'</span>
<span class="co">#' @importFrom utils packageVersion</span>
<span class="co">#' @importFrom htmltools tagList htmlDependency</span>
<span class="co">#' @export</span>
<span class="va">add_pwa_deps</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">tag</span><span class="op">)</span> <span class="op">{</span>
 <span class="va">pwa_deps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/htmltools/man/htmlDependency.html">htmlDependency</a></span><span class="op">(</span>
  name <span class="op">=</span> <span class="st">"pwa-utils"</span>,
  version <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/utils/packageDescription.html">packageVersion</a></span><span class="op">(</span><span class="st">"shinyMobile"</span><span class="op">)</span>,
  src <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>file <span class="op">=</span> <span class="st">"shinyMobile-0.0.0.9000"</span><span class="op">)</span>,
  head <span class="op">=</span> <span class="st">"&lt;link rel=\"manifest\" 
    href=\"manifest.webmanifest\"/&gt;
    &lt;link rel=\"icon\" type=\"image/png\" 
    href=\"icons/icon-144.png\" sizes=\"144x144\" /&gt;"</span>,
  package <span class="op">=</span> <span class="st">"mypkg2"</span>,
 <span class="op">)</span>
 <span class="fu"><a href="https://rdrr.io/pkg/htmltools/man/tagList.html">tagList</a></span><span class="op">(</span><span class="va">tag</span>, <span class="va">pwa_deps</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>In practice, since the package already relies on other dependencies like Framework7, we will leverage the <code><a href="https://rinterface.github.io/shinyMobile/reference/add_dependencies.html">add_dependencies()</a></code> function to add all dependencies at once.</p>
<div class="noteblock">
<p>All provided icons must follow the convention <code>icon-&lt;size_in_px&gt;.png</code> like
<code>icon-144.png</code>, which is the default.</p>
</div>
</div>
<div id="google-pwa-compatibility" class="section level3">
<h3>
<span class="header-section-number">25.2.2</span> Google PWA compatibility<a class="anchor" aria-label="anchor" href="#google-pwa-compatibility"><i class="fas fa-link"></i></a>
</h3>
<p>As we use the Google PWA compatibility script, we have to include at least one icon
like <code>&lt;link rel="icon" type="image/png" href="res/icon-128.png" sizes="128x128" /&gt;</code>.
However, we found some discrepancies between the developer tools recommendations and the
PWA compatibility script. Therefore, we recommend to follow the developer tools prescriptions, that
is to include at least one icon of size 144x144. All other elements are generated by the script itself,
which is convenient. Indeed, having to handle all possible screen sizes and different OS is particularly
tricky, repetitive, and not interesting.</p>
<p>The HTML dependency is downloaded with <code><a href="https://rdrr.io/pkg/charpente/man/create_dependency.html">create_dependency("pwacompat", options = charpente_options(bundle = FALSE))</a></code>.
Don’t forget to update the <code><a href="https://rinterface.github.io/shinyMobile/reference/add_dependencies.html">add_dependencies()</a></code> call in <code><a href="https://rdrr.io/pkg/OSUICode/man/f7_page.html">f7_page()</a></code> by including the two new dependencies:</p>
<div class="sourceCode" id="cb857"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">f7_page</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">...</span>, <span class="va">navbar</span>, <span class="va">toolbar</span>, <span class="va">title</span> <span class="op">=</span> <span class="cn">NULL</span>, 
                    <span class="va">options</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span>

  <span class="va">config_tag</span> <span class="op">&lt;-</span> <span class="va">tags</span><span class="op">$</span><span class="fu">script</span><span class="op">(</span>
    type <span class="op">=</span> <span class="st">"application/json"</span>,
    `data-for` <span class="op">=</span> <span class="st">"app"</span>,
    <span class="fu">jsonlite</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/jsonlite/man/fromJSON.html">toJSON</a></span><span class="op">(</span>
      x <span class="op">=</span> <span class="va">options</span>,
      auto_unbox <span class="op">=</span> <span class="cn">TRUE</span>,
      json_verbatim <span class="op">=</span> <span class="cn">TRUE</span>
    <span class="op">)</span>
  <span class="op">)</span>

  <span class="co"># create body_tag</span>
  <span class="va">body_tag</span> <span class="op">&lt;-</span> <span class="va">tags</span><span class="op">$</span><span class="fu">body</span><span class="op">(</span>
    <span class="va">tags</span><span class="op">$</span><span class="fu">div</span><span class="op">(</span>
      id <span class="op">=</span> <span class="st">"app"</span>,
      <span class="va">tags</span><span class="op">$</span><span class="fu">div</span><span class="op">(</span>
        class <span class="op">=</span> <span class="st">"view view-main"</span>,
        <span class="va">tags</span><span class="op">$</span><span class="fu">div</span><span class="op">(</span>
          class <span class="op">=</span> <span class="st">"page"</span>,
          <span class="va">navbar</span>,
          <span class="va">toolbar</span>,
          <span class="va">tags</span><span class="op">$</span><span class="fu">div</span><span class="op">(</span>
            class <span class="op">=</span> <span class="st">"page-content"</span>,
            <span class="va">...</span>
          <span class="op">)</span>
        <span class="op">)</span>
      <span class="op">)</span>
    <span class="op">)</span>,
    <span class="va">config_tag</span>
  <span class="op">)</span>

  <span class="fu"><a href="https://rdrr.io/pkg/htmltools/man/tagList.html">tagList</a></span><span class="op">(</span>
    <span class="va">tags</span><span class="op">$</span><span class="fu">head</span><span class="op">(</span>
      <span class="va">tags</span><span class="op">$</span><span class="fu">meta</span><span class="op">(</span>charset <span class="op">=</span> <span class="st">"utf-8"</span><span class="op">)</span>,
      <span class="va">tags</span><span class="op">$</span><span class="fu">meta</span><span class="op">(</span>
        name <span class="op">=</span> <span class="st">"viewport"</span>,
        content <span class="op">=</span> <span class="st">"width=device-width, initial-scale=1, 
        maximum-scale=1, minimum-scale=1, user-scalable=no, 
        viewport-fit=cover"</span>
      <span class="op">)</span>,
      <span class="va">tags</span><span class="op">$</span><span class="fu">meta</span><span class="op">(</span>
        name <span class="op">=</span> <span class="st">"apple-mobile-web-app-capable"</span>,
        content <span class="op">=</span> <span class="st">"yes"</span>
      <span class="op">)</span>,
      <span class="va">tags</span><span class="op">$</span><span class="fu">meta</span><span class="op">(</span>
        name <span class="op">=</span> <span class="st">"theme-color"</span>,
        content <span class="op">=</span> <span class="st">"#2196f3"</span>
      <span class="op">)</span>,
      <span class="va">tags</span><span class="op">$</span><span class="fu">title</span><span class="op">(</span><span class="va">title</span><span class="op">)</span>
    <span class="op">)</span>,
    <span class="fu"><a href="https://rinterface.github.io/shinyMobile/reference/add_dependencies.html">add_dependencies</a></span><span class="op">(</span>
      <span class="va">body_tag</span>,
      deps <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"framework7"</span>, <span class="st">"shinyMobile"</span>, <span class="st">"pwa"</span>, <span class="st">"pwacompat"</span><span class="op">)</span>
    <span class="op">)</span>
  <span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>Calling <code><a href="https://devtools.r-lib.org//reference/load_all.html">devtools::load_all()</a></code> and running the app again, you should see the new dependencies
in the <code>head</code> (Figure <a href="mobile-pwa.html#fig:mobile-pwa-deps">25.4</a>).</p>
<div class="figure">
<span id="fig:mobile-pwa-deps"></span>
<img src="images/mobile/mobile-pwa-deps.png" alt="New PWA dependencies in the head tag." width="100%"><p class="caption">
FIGURE 25.4: New PWA dependencies in the head tag.
</p>
</div>
<p>Yet, according to Figure <a href="mobile-pwa.html#fig:mobile-pwa-missing-sw">25.5</a>, we still miss the <strong>service worker</strong>,
as shown in the manifest diagnostic. This demonstrates how powerful are the developer tools as
the end user is always guided step by step.</p>
<div class="figure">
<span id="fig:mobile-pwa-missing-sw"></span>
<img src="images/mobile/mobile-pwa-missing-sw.png" alt="Missing service worker registration." width="100%"><p class="caption">
FIGURE 25.5: Missing service worker registration.
</p>
</div>
</div>
<div id="service-worker-and-offline-page" class="section level3">
<h3>
<span class="header-section-number">25.2.3</span> Service worker and offline page<a class="anchor" aria-label="anchor" href="#service-worker-and-offline-page"><i class="fas fa-link"></i></a>
</h3>
<p>The second mandatory step to make our app installable is the <strong>service worker</strong>.
We borrowed and modified the code from <a href="https://web.dev/offline-fallback-page/">web.dev</a>. <code><a href="https://rdrr.io/pkg/charpente/man/set_pwa.html">set_pwa()</a></code> copies this code in the the provided app <code>/www</code> folder:</p>
<div class="sourceCode" id="cb858"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb858-1"><a href="mobile-pwa.html#cb858-1"></a><span class="co">/*</span></span>
<span id="cb858-2"><a href="mobile-pwa.html#cb858-2"></a><span class="co">Copyright 2015, 2019, 2020 Google LLC. All Rights Reserved.</span></span>
<span id="cb858-3"><a href="mobile-pwa.html#cb858-3"></a><span class="co"> Licensed under the Apache License, Version 2.0 (the "License");</span></span>
<span id="cb858-4"><a href="mobile-pwa.html#cb858-4"></a><span class="co"> you may not use this file except in compliance with the License.</span></span>
<span id="cb858-5"><a href="mobile-pwa.html#cb858-5"></a><span class="co"> You may obtain a copy of the License at</span></span>
<span id="cb858-6"><a href="mobile-pwa.html#cb858-6"></a><span class="co"> http://www.apache.org/licenses/LICENSE-2.0</span></span>
<span id="cb858-7"><a href="mobile-pwa.html#cb858-7"></a><span class="co"> Unless required by applicable law or agreed to in writing, software</span></span>
<span id="cb858-8"><a href="mobile-pwa.html#cb858-8"></a><span class="co"> distributed under the License is distributed on an "AS IS" BASIS,</span></span>
<span id="cb858-9"><a href="mobile-pwa.html#cb858-9"></a><span class="co"> WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></span>
<span id="cb858-10"><a href="mobile-pwa.html#cb858-10"></a><span class="co"> See the License for the specific language governing permissions and</span></span>
<span id="cb858-11"><a href="mobile-pwa.html#cb858-11"></a><span class="co"> limitations under the License.</span></span>
<span id="cb858-12"><a href="mobile-pwa.html#cb858-12"></a><span class="co">*/</span></span>
<span id="cb858-13"><a href="mobile-pwa.html#cb858-13"></a></span>
<span id="cb858-14"><a href="mobile-pwa.html#cb858-14"></a><span class="co">// Incrementing OFFLINE_VERSION will kick off the install event and force</span></span>
<span id="cb858-15"><a href="mobile-pwa.html#cb858-15"></a><span class="co">// previously cached resources to be updated from the network.</span></span>
<span id="cb858-16"><a href="mobile-pwa.html#cb858-16"></a><span class="kw">const</span> OFFLINE_VERSION <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb858-17"><a href="mobile-pwa.html#cb858-17"></a><span class="kw">const</span> CACHE_NAME <span class="op">=</span> <span class="st">"offline"</span><span class="op">;</span></span>
<span id="cb858-18"><a href="mobile-pwa.html#cb858-18"></a><span class="co">// Customize this with a different URL if needed.</span></span>
<span id="cb858-19"><a href="mobile-pwa.html#cb858-19"></a><span class="kw">const</span> OFFLINE_URL <span class="op">=</span> <span class="st">"offline.html"</span><span class="op">;</span></span>
<span id="cb858-20"><a href="mobile-pwa.html#cb858-20"></a></span>
<span id="cb858-21"><a href="mobile-pwa.html#cb858-21"></a><span class="va">self</span>.<span class="at">addEventListener</span>(<span class="st">"install"</span><span class="op">,</span> (event) <span class="kw">=&gt;</span> <span class="op">{</span></span>
<span id="cb858-22"><a href="mobile-pwa.html#cb858-22"></a>  <span class="va">event</span>.<span class="at">waitUntil</span>(</span>
<span id="cb858-23"><a href="mobile-pwa.html#cb858-23"></a>    (<span class="kw">async</span> () <span class="kw">=&gt;</span> <span class="op">{</span></span>
<span id="cb858-24"><a href="mobile-pwa.html#cb858-24"></a>      <span class="kw">const</span> cache <span class="op">=</span> <span class="cf">await</span> <span class="va">caches</span>.<span class="at">open</span>(CACHE_NAME)<span class="op">;</span></span>
<span id="cb858-25"><a href="mobile-pwa.html#cb858-25"></a>      <span class="co">// Setting {cache: 'reload'} in the new request will </span></span>
<span id="cb858-26"><a href="mobile-pwa.html#cb858-26"></a>      <span class="co">// ensure that the response isn't fulfilled from the </span></span>
<span id="cb858-27"><a href="mobile-pwa.html#cb858-27"></a>      <span class="co">// HTTP cache; i.e., it will be from the network.</span></span>
<span id="cb858-28"><a href="mobile-pwa.html#cb858-28"></a>      <span class="cf">await</span> <span class="va">cache</span>.<span class="at">add</span>(<span class="kw">new</span> <span class="at">Request</span>(OFFLINE_URL<span class="op">,</span> <span class="op">{</span> <span class="dt">cache</span><span class="op">:</span> <span class="st">"reload"</span> <span class="op">}</span>))<span class="op">;</span></span>
<span id="cb858-29"><a href="mobile-pwa.html#cb858-29"></a>      <span class="cf">await</span> <span class="va">cache</span>.<span class="at">add</span>( <span class="kw">new</span> <span class="at">Request</span>(<span class="st">"framework7-5.7.14/css/framework7.bundle.min.css"</span><span class="op">,</span> <span class="op">{</span> <span class="dt">cache</span><span class="op">:</span> <span class="st">"reload"</span> <span class="op">}</span>) )<span class="op">;</span></span>
<span id="cb858-30"><a href="mobile-pwa.html#cb858-30"></a>      <span class="cf">await</span> <span class="va">cache</span>.<span class="at">add</span>( <span class="kw">new</span> <span class="at">Request</span>(<span class="st">"framework7-5.7.14/js/framework7.bundle.min.js"</span><span class="op">,</span> <span class="op">{</span> <span class="dt">cache</span><span class="op">:</span> <span class="st">"reload"</span> <span class="op">}</span>) )<span class="op">;</span></span>
<span id="cb858-31"><a href="mobile-pwa.html#cb858-31"></a>      <span class="cf">await</span> <span class="va">cache</span>.<span class="at">add</span>( <span class="kw">new</span> <span class="at">Request</span>(<span class="st">"shared/jquery.min.js"</span><span class="op">,</span> <span class="op">{</span> <span class="dt">cache</span><span class="op">:</span> <span class="st">"reload"</span> <span class="op">}</span>) )<span class="op">;</span></span>
<span id="cb858-32"><a href="mobile-pwa.html#cb858-32"></a>    <span class="op">}</span>)()</span>
<span id="cb858-33"><a href="mobile-pwa.html#cb858-33"></a>  )<span class="op">;</span></span>
<span id="cb858-34"><a href="mobile-pwa.html#cb858-34"></a>  <span class="co">// Force the waiting service worker to become the active service worker.</span></span>
<span id="cb858-35"><a href="mobile-pwa.html#cb858-35"></a>  <span class="va">self</span>.<span class="at">skipWaiting</span>()<span class="op">;</span></span>
<span id="cb858-36"><a href="mobile-pwa.html#cb858-36"></a><span class="op">}</span>)<span class="op">;</span></span>
<span id="cb858-37"><a href="mobile-pwa.html#cb858-37"></a></span>
<span id="cb858-38"><a href="mobile-pwa.html#cb858-38"></a><span class="va">self</span>.<span class="at">addEventListener</span>(<span class="st">"activate"</span><span class="op">,</span> (event) <span class="kw">=&gt;</span> <span class="op">{</span></span>
<span id="cb858-39"><a href="mobile-pwa.html#cb858-39"></a>  <span class="va">event</span>.<span class="at">waitUntil</span>(</span>
<span id="cb858-40"><a href="mobile-pwa.html#cb858-40"></a>    (<span class="kw">async</span> () <span class="kw">=&gt;</span> <span class="op">{</span></span>
<span id="cb858-41"><a href="mobile-pwa.html#cb858-41"></a>      <span class="co">// Enable navigation preload if it's supported.</span></span>
<span id="cb858-42"><a href="mobile-pwa.html#cb858-42"></a>      <span class="co">// See https://developers.google.com/web/updates/2017/02/navigation-preload</span></span>
<span id="cb858-43"><a href="mobile-pwa.html#cb858-43"></a>      <span class="cf">if</span> (<span class="st">"navigationPreload"</span> <span class="kw">in</span> <span class="va">self</span>.<span class="at">registration</span>) <span class="op">{</span></span>
<span id="cb858-44"><a href="mobile-pwa.html#cb858-44"></a>        <span class="cf">await</span> <span class="va">self</span>.<span class="va">registration</span>.<span class="va">navigationPreload</span>.<span class="at">enable</span>()<span class="op">;</span></span>
<span id="cb858-45"><a href="mobile-pwa.html#cb858-45"></a>      <span class="op">}</span></span>
<span id="cb858-46"><a href="mobile-pwa.html#cb858-46"></a>    <span class="op">}</span>)()</span>
<span id="cb858-47"><a href="mobile-pwa.html#cb858-47"></a>  )<span class="op">;</span></span>
<span id="cb858-48"><a href="mobile-pwa.html#cb858-48"></a></span>
<span id="cb858-49"><a href="mobile-pwa.html#cb858-49"></a>  <span class="co">// Tell the active service worker to take control of </span></span>
<span id="cb858-50"><a href="mobile-pwa.html#cb858-50"></a>  <span class="co">// the page immediately.</span></span>
<span id="cb858-51"><a href="mobile-pwa.html#cb858-51"></a>  <span class="va">self</span>.<span class="va">clients</span>.<span class="at">claim</span>()<span class="op">;</span></span>
<span id="cb858-52"><a href="mobile-pwa.html#cb858-52"></a><span class="op">}</span>)<span class="op">;</span></span>
<span id="cb858-53"><a href="mobile-pwa.html#cb858-53"></a></span>
<span id="cb858-54"><a href="mobile-pwa.html#cb858-54"></a><span class="va">self</span>.<span class="at">addEventListener</span>(<span class="st">"fetch"</span><span class="op">,</span> (event) <span class="kw">=&gt;</span> <span class="op">{</span></span>
<span id="cb858-55"><a href="mobile-pwa.html#cb858-55"></a></span>
<span id="cb858-56"><a href="mobile-pwa.html#cb858-56"></a>  <span class="co">// Fix service-worker bug</span></span>
<span id="cb858-57"><a href="mobile-pwa.html#cb858-57"></a>  <span class="cf">if</span> (<span class="va">event</span>.<span class="va">request</span>.<span class="at">cache</span> <span class="op">===</span> <span class="st">'only-if-cached'</span>) <span class="cf">return</span><span class="op">;</span></span>
<span id="cb858-58"><a href="mobile-pwa.html#cb858-58"></a></span>
<span id="cb858-59"><a href="mobile-pwa.html#cb858-59"></a>  <span class="co">// We only want to call event.respondWith() if this </span></span>
<span id="cb858-60"><a href="mobile-pwa.html#cb858-60"></a>  <span class="co">// is a navigation request for an HTML page ...</span></span>
<span id="cb858-61"><a href="mobile-pwa.html#cb858-61"></a>  <span class="cf">if</span> (<span class="va">event</span>.<span class="va">request</span>.<span class="at">mode</span> <span class="op">===</span> <span class="st">"navigate"</span>) <span class="op">{</span></span>
<span id="cb858-62"><a href="mobile-pwa.html#cb858-62"></a>    <span class="va">event</span>.<span class="at">respondWith</span>(</span>
<span id="cb858-63"><a href="mobile-pwa.html#cb858-63"></a>      (<span class="kw">async</span> () <span class="kw">=&gt;</span> <span class="op">{</span></span>
<span id="cb858-64"><a href="mobile-pwa.html#cb858-64"></a>        <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb858-65"><a href="mobile-pwa.html#cb858-65"></a>          <span class="co">// First, try to use the navigation preload response </span></span>
<span id="cb858-66"><a href="mobile-pwa.html#cb858-66"></a>          <span class="co">// if it's supported.</span></span>
<span id="cb858-67"><a href="mobile-pwa.html#cb858-67"></a>          <span class="kw">const</span> preloadResponse <span class="op">=</span> <span class="cf">await</span> <span class="va">event</span>.<span class="at">preloadResponse</span><span class="op">;</span></span>
<span id="cb858-68"><a href="mobile-pwa.html#cb858-68"></a>          <span class="cf">if</span> (preloadResponse) <span class="op">{</span></span>
<span id="cb858-69"><a href="mobile-pwa.html#cb858-69"></a>            <span class="cf">return</span> preloadResponse<span class="op">;</span></span>
<span id="cb858-70"><a href="mobile-pwa.html#cb858-70"></a>          <span class="op">}</span></span>
<span id="cb858-71"><a href="mobile-pwa.html#cb858-71"></a></span>
<span id="cb858-72"><a href="mobile-pwa.html#cb858-72"></a>          <span class="co">// Always try the network first.</span></span>
<span id="cb858-73"><a href="mobile-pwa.html#cb858-73"></a>          <span class="kw">const</span> networkResponse <span class="op">=</span> <span class="cf">await</span> <span class="at">fetch</span>(<span class="va">event</span>.<span class="at">request</span>)<span class="op">;</span></span>
<span id="cb858-74"><a href="mobile-pwa.html#cb858-74"></a>          <span class="cf">return</span> networkResponse<span class="op">;</span></span>
<span id="cb858-75"><a href="mobile-pwa.html#cb858-75"></a>        <span class="op">}</span> <span class="cf">catch</span> (error) <span class="op">{</span></span>
<span id="cb858-76"><a href="mobile-pwa.html#cb858-76"></a>          <span class="co">// catch is only triggered if an exception is thrown, </span></span>
<span id="cb858-77"><a href="mobile-pwa.html#cb858-77"></a>          <span class="co">// which is likely due to a network error.</span></span>
<span id="cb858-78"><a href="mobile-pwa.html#cb858-78"></a>          <span class="co">// If fetch() returns a valid HTTP response with a </span></span>
<span id="cb858-79"><a href="mobile-pwa.html#cb858-79"></a>          <span class="co">// response code in the 4xx or 5xx range, the catch() </span></span>
<span id="cb858-80"><a href="mobile-pwa.html#cb858-80"></a>          <span class="co">// will NOT be called.</span></span>
<span id="cb858-81"><a href="mobile-pwa.html#cb858-81"></a>          <span class="va">console</span>.<span class="at">log</span>(<span class="st">"Returning offline page instead."</span><span class="op">,</span> error)<span class="op">;</span></span>
<span id="cb858-82"><a href="mobile-pwa.html#cb858-82"></a></span>
<span id="cb858-83"><a href="mobile-pwa.html#cb858-83"></a>          <span class="kw">const</span> cache <span class="op">=</span> <span class="cf">await</span> <span class="va">caches</span>.<span class="at">open</span>(CACHE_NAME)<span class="op">;</span></span>
<span id="cb858-84"><a href="mobile-pwa.html#cb858-84"></a>          <span class="kw">const</span> cachedResponse <span class="op">=</span> <span class="cf">await</span> <span class="va">cache</span>.<span class="at">match</span>(OFFLINE_URL)<span class="op">;</span></span>
<span id="cb858-85"><a href="mobile-pwa.html#cb858-85"></a>          <span class="cf">return</span> cachedResponse<span class="op">;</span></span>
<span id="cb858-86"><a href="mobile-pwa.html#cb858-86"></a>        <span class="op">}</span></span>
<span id="cb858-87"><a href="mobile-pwa.html#cb858-87"></a>      <span class="op">}</span>)()</span>
<span id="cb858-88"><a href="mobile-pwa.html#cb858-88"></a>    )<span class="op">;</span></span>
<span id="cb858-89"><a href="mobile-pwa.html#cb858-89"></a>  <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb858-90"><a href="mobile-pwa.html#cb858-90"></a>    <span class="co">// ... but also serve other cached assets </span></span>
<span id="cb858-91"><a href="mobile-pwa.html#cb858-91"></a>    <span class="co">// (not a navigation request).</span></span>
<span id="cb858-92"><a href="mobile-pwa.html#cb858-92"></a>    <span class="va">event</span>.<span class="at">respondWith</span>(</span>
<span id="cb858-93"><a href="mobile-pwa.html#cb858-93"></a>      (<span class="kw">async</span> () <span class="kw">=&gt;</span> <span class="op">{</span></span>
<span id="cb858-94"><a href="mobile-pwa.html#cb858-94"></a>        </span>
<span id="cb858-95"><a href="mobile-pwa.html#cb858-95"></a>        <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb858-96"><a href="mobile-pwa.html#cb858-96"></a>          <span class="co">// Always try the network first.</span></span>
<span id="cb858-97"><a href="mobile-pwa.html#cb858-97"></a>          <span class="kw">const</span> networkResponse <span class="op">=</span> <span class="cf">await</span> <span class="at">fetch</span>(<span class="va">event</span>.<span class="at">request</span>)<span class="op">;</span></span>
<span id="cb858-98"><a href="mobile-pwa.html#cb858-98"></a>          <span class="cf">return</span> networkResponse<span class="op">;</span></span>
<span id="cb858-99"><a href="mobile-pwa.html#cb858-99"></a>          </span>
<span id="cb858-100"><a href="mobile-pwa.html#cb858-100"></a>        <span class="op">}</span> <span class="cf">catch</span> (error) <span class="op">{</span></span>
<span id="cb858-101"><a href="mobile-pwa.html#cb858-101"></a>          </span>
<span id="cb858-102"><a href="mobile-pwa.html#cb858-102"></a>          <span class="kw">const</span> cache <span class="op">=</span> <span class="cf">await</span> <span class="va">caches</span>.<span class="at">open</span>(CACHE_NAME)<span class="op">;</span></span>
<span id="cb858-103"><a href="mobile-pwa.html#cb858-103"></a>          <span class="kw">const</span> cachedResponse <span class="op">=</span> <span class="cf">await</span> <span class="va">cache</span>.<span class="at">match</span>(<span class="va">event</span>.<span class="at">request</span>)<span class="op">;</span></span>
<span id="cb858-104"><a href="mobile-pwa.html#cb858-104"></a>          <span class="cf">if</span> (cachedResponse) <span class="cf">return</span> cachedResponse<span class="op">;</span></span>
<span id="cb858-105"><a href="mobile-pwa.html#cb858-105"></a>          </span>
<span id="cb858-106"><a href="mobile-pwa.html#cb858-106"></a>        <span class="op">}</span></span>
<span id="cb858-107"><a href="mobile-pwa.html#cb858-107"></a>      <span class="op">}</span>)()</span>
<span id="cb858-108"><a href="mobile-pwa.html#cb858-108"></a>    )<span class="op">;</span></span>
<span id="cb858-109"><a href="mobile-pwa.html#cb858-109"></a>  <span class="op">}</span></span>
<span id="cb858-110"><a href="mobile-pwa.html#cb858-110"></a></span>
<span id="cb858-111"><a href="mobile-pwa.html#cb858-111"></a>  <span class="co">// If our if() condition is false, then this fetch handler </span></span>
<span id="cb858-112"><a href="mobile-pwa.html#cb858-112"></a>  <span class="co">// will still intercept the</span></span>
<span id="cb858-113"><a href="mobile-pwa.html#cb858-113"></a>  <span class="co">// request and tries to return an answer either from </span></span>
<span id="cb858-114"><a href="mobile-pwa.html#cb858-114"></a>  <span class="co">// network or from the relevant cache location. If there </span></span>
<span id="cb858-115"><a href="mobile-pwa.html#cb858-115"></a>  <span class="co">// are any other fetch handlers registered, they will get a</span></span>
<span id="cb858-116"><a href="mobile-pwa.html#cb858-116"></a>  <span class="co">// chance to call event.respondWith(). If no fetch handlers </span></span>
<span id="cb858-117"><a href="mobile-pwa.html#cb858-117"></a>  <span class="co">// call event.respondWith(), the request will be handled by </span></span>
<span id="cb858-118"><a href="mobile-pwa.html#cb858-118"></a>  <span class="co">// the browser as if there were no service worker involvement.</span></span>
<span id="cb858-119"><a href="mobile-pwa.html#cb858-119"></a><span class="op">}</span>)<span class="op">;</span></span></code></pre></div>
<p>Overall, the above service worker is composed of three steps:</p>
<ul>
<li>
<strong>Installation</strong>: cache is initialized and assets like HTML page, CSS, JS, images are asynchronously cached. In addition to caching the <code>offline.html</code> page, we also
cache necessary assets. Their respective path is taken from the server location, for instance, Framework7 assets are located in <code>framework7-5.7.14/...</code> and jQuery assets in <code>shared/</code>. Best practice is to look at the developer tools <code>Source</code> tab which provides the right location.</li>
<li>
<strong>Activation</strong>.</li>
<li>
<strong>Fetch</strong>: the service worker intercepts all network requests sent by the client and returns answers according to a predefined strategy. Here we set the “network first” strategy, meaning we always try to return an answer from the network and fall back to the cache if the request failed (for instance in case of missing internet connection). In the above code, there are two kind of requests: navigation, that is related to an HTML page and other requests corresponding to static assets like CSS or JS. Therefore, we have an <code>if</code> and <code>else</code> statement to consider those two cases. If you would like to know more about caching strategies please refer to the Google documentation: <a href="https://developers.google.com/web/tools/workbox/modules/workbox-strategies" class="uri">https://developers.google.com/web/tools/workbox/modules/workbox-strategies</a>.</li>
</ul>
<p>This service worker redirects the end user to the offline cached page (<code>offline.html</code>) whenever the app is offline, thereby offering a better user experience.</p>
<div class="importantblock">
<p>We strongly advise to keep the same file names.</p>
</div>
<p>The next step involves the service worker registration. Framework7 has a dedicated module in the app configuration. We modify the <code>config</code> in <code>init.js</code> before initializing the <code>app</code> and run <code><a href="https://rdrr.io/pkg/charpente/man/build_js.html">build_js()</a></code> to update the minified file:</p>
<div class="sourceCode" id="cb859"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb859-1"><a href="mobile-pwa.html#cb859-1"></a><span class="va">config</span>.<span class="at">serviceWorker</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb859-2"><a href="mobile-pwa.html#cb859-2"></a>  <span class="dt">path</span><span class="op">:</span> <span class="va">window</span>.<span class="va">location</span>.<span class="at">pathname</span> <span class="op">+</span> <span class="st">'service-worker.js'</span><span class="op">,</span></span>
<span id="cb859-3"><a href="mobile-pwa.html#cb859-3"></a>  <span class="dt">scope</span><span class="op">:</span> <span class="va">window</span>.<span class="va">location</span>.<span class="at">pathname</span></span>
<span id="cb859-4"><a href="mobile-pwa.html#cb859-4"></a><span class="op">}</span></span></code></pre></div>
<p>If the process is successful, you get the result shown in Figure <a href="mobile-pwa.html#fig:mobile-pwa-registered-sw">25.6</a>.</p>
<div class="figure">
<span id="fig:mobile-pwa-registered-sw"></span>
<img src="images/mobile/mobile-pwa-registered-sw.png" alt="Registered service worker." width="100%"><p class="caption">
FIGURE 25.6: Registered service worker.
</p>
</div>
<p>The new PWA standard imposes to return a valid response when the app is <strong>offline</strong>. The offline page is also copied from <a href="https://github.com/RinteRface/charpente">charpente</a>:</p>
<div class="sourceCode" id="cb860"><pre class="sourceCode html"><code class="sourceCode html"><span id="cb860-1"><a href="mobile-pwa.html#cb860-1"></a><span class="dt">&lt;!DOCTYPE </span>html<span class="dt">&gt;</span></span>
<span id="cb860-2"><a href="mobile-pwa.html#cb860-2"></a><span class="kw">&lt;html&gt;</span></span>
<span id="cb860-3"><a href="mobile-pwa.html#cb860-3"></a>  <span class="kw">&lt;head&gt;</span></span>
<span id="cb860-4"><a href="mobile-pwa.html#cb860-4"></a>    <span class="co">&lt;!-- Required meta tags--&gt;</span></span>
<span id="cb860-5"><a href="mobile-pwa.html#cb860-5"></a>    <span class="kw">&lt;meta</span><span class="ot"> charset=</span><span class="st">"utf-8"</span><span class="kw">&gt;</span></span>
<span id="cb860-6"><a href="mobile-pwa.html#cb860-6"></a>    <span class="kw">&lt;meta</span><span class="ot"> name=</span><span class="st">"viewport"</span> </span>
<span id="cb860-7"><a href="mobile-pwa.html#cb860-7"></a><span class="ot">    content=</span><span class="st">"width=device-width, </span></span>
<span id="cb860-8"><a href="mobile-pwa.html#cb860-8"></a><span class="st">    initial-scale=1, </span></span>
<span id="cb860-9"><a href="mobile-pwa.html#cb860-9"></a><span class="st">    maximum-scale=1, </span></span>
<span id="cb860-10"><a href="mobile-pwa.html#cb860-10"></a><span class="st">    minimum-scale=1, </span></span>
<span id="cb860-11"><a href="mobile-pwa.html#cb860-11"></a><span class="st">    user-scalable=no, </span></span>
<span id="cb860-12"><a href="mobile-pwa.html#cb860-12"></a><span class="st">    viewport-fit=cover"</span><span class="kw">&gt;</span></span>
<span id="cb860-13"><a href="mobile-pwa.html#cb860-13"></a>    <span class="kw">&lt;meta</span><span class="ot"> name=</span><span class="st">"apple-mobile-web-app-capable"</span><span class="ot"> content=</span><span class="st">"yes"</span><span class="kw">&gt;</span></span>
<span id="cb860-14"><a href="mobile-pwa.html#cb860-14"></a>    <span class="co">&lt;!-- Color theme for statusbar (Android only) --&gt;</span></span>
<span id="cb860-15"><a href="mobile-pwa.html#cb860-15"></a>    <span class="kw">&lt;meta</span><span class="ot"> name=</span><span class="st">"theme-color"</span><span class="ot"> content=</span><span class="st">"#2196f3"</span><span class="kw">&gt;</span></span>
<span id="cb860-16"><a href="mobile-pwa.html#cb860-16"></a>    <span class="co">&lt;!-- Your app title --&gt;</span></span>
<span id="cb860-17"><a href="mobile-pwa.html#cb860-17"></a>    <span class="kw">&lt;title&gt;</span>Oups<span class="kw">&lt;/title&gt;</span></span>
<span id="cb860-18"><a href="mobile-pwa.html#cb860-18"></a>    <span class="co">&lt;!-- Path to Framework7 Library Bundle CSS --&gt;</span></span>
<span id="cb860-19"><a href="mobile-pwa.html#cb860-19"></a>    <span class="kw">&lt;link</span> </span>
<span id="cb860-20"><a href="mobile-pwa.html#cb860-20"></a><span class="ot">      rel=</span><span class="st">"stylesheet"</span> </span>
<span id="cb860-21"><a href="mobile-pwa.html#cb860-21"></a><span class="ot">      href=</span><span class="st">"framework7-5.7.14/css/framework7.bundle.min.css"</span><span class="kw">&gt;</span></span>
<span id="cb860-22"><a href="mobile-pwa.html#cb860-22"></a>    <span class="co">&lt;!-- Path to your custom app styles--&gt;</span></span>
<span id="cb860-23"><a href="mobile-pwa.html#cb860-23"></a>  <span class="kw">&lt;/head&gt;</span></span>
<span id="cb860-24"><a href="mobile-pwa.html#cb860-24"></a>  <span class="kw">&lt;body&gt;</span></span>
<span id="cb860-25"><a href="mobile-pwa.html#cb860-25"></a>    <span class="co">&lt;!-- App root element --&gt;</span></span>
<span id="cb860-26"><a href="mobile-pwa.html#cb860-26"></a>    <span class="kw">&lt;div</span><span class="ot"> id=</span><span class="st">"app"</span><span class="kw">&gt;</span></span>
<span id="cb860-27"><a href="mobile-pwa.html#cb860-27"></a></span>
<span id="cb860-28"><a href="mobile-pwa.html#cb860-28"></a>      <span class="co">&lt;!-- Your main view, should have "view-main" class --&gt;</span></span>
<span id="cb860-29"><a href="mobile-pwa.html#cb860-29"></a>      <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">"view view-main"</span><span class="kw">&gt;</span></span>
<span id="cb860-30"><a href="mobile-pwa.html#cb860-30"></a>        <span class="co">&lt;!-- Initial Page, "data-name" contains page name --&gt;</span></span>
<span id="cb860-31"><a href="mobile-pwa.html#cb860-31"></a>        <span class="kw">&lt;div</span><span class="ot"> data-name=</span><span class="st">"home"</span><span class="ot"> class=</span><span class="st">"page"</span><span class="kw">&gt;</span></span>
<span id="cb860-32"><a href="mobile-pwa.html#cb860-32"></a></span>
<span id="cb860-33"><a href="mobile-pwa.html#cb860-33"></a>          <span class="co">&lt;!-- Top Navbar --&gt;</span></span>
<span id="cb860-34"><a href="mobile-pwa.html#cb860-34"></a>          <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">"navbar"</span><span class="kw">&gt;</span></span>
<span id="cb860-35"><a href="mobile-pwa.html#cb860-35"></a>            <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">"navbar-bg"</span><span class="kw">&gt;&lt;/div&gt;</span></span>
<span id="cb860-36"><a href="mobile-pwa.html#cb860-36"></a>            <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">"navbar-inner"</span><span class="kw">&gt;</span></span>
<span id="cb860-37"><a href="mobile-pwa.html#cb860-37"></a>              <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">"title"</span><span class="kw">&gt;</span>Offline page<span class="kw">&lt;/div&gt;</span></span>
<span id="cb860-38"><a href="mobile-pwa.html#cb860-38"></a>            <span class="kw">&lt;/div&gt;</span></span>
<span id="cb860-39"><a href="mobile-pwa.html#cb860-39"></a>          <span class="kw">&lt;/div&gt;</span></span>
<span id="cb860-40"><a href="mobile-pwa.html#cb860-40"></a></span>
<span id="cb860-41"><a href="mobile-pwa.html#cb860-41"></a>          <span class="co">&lt;!-- Bottom Toolbar --&gt;</span></span>
<span id="cb860-42"><a href="mobile-pwa.html#cb860-42"></a>          <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">"toolbar toolbar-bottom"</span><span class="kw">&gt;</span></span>
<span id="cb860-43"><a href="mobile-pwa.html#cb860-43"></a>            <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">"toolbar-inner"</span><span class="kw">&gt;</span></span>
<span id="cb860-44"><a href="mobile-pwa.html#cb860-44"></a>              <span class="co">&lt;!-- Toolbar links --&gt;</span></span>
<span id="cb860-45"><a href="mobile-pwa.html#cb860-45"></a>              <span class="kw">&lt;a</span><span class="ot"> href=</span><span class="st">"#"</span><span class="ot"> class=</span><span class="st">"link"</span><span class="kw">&gt;</span>Link 1<span class="kw">&lt;/a&gt;</span></span>
<span id="cb860-46"><a href="mobile-pwa.html#cb860-46"></a>              <span class="kw">&lt;a</span><span class="ot"> href=</span><span class="st">"#"</span><span class="ot"> class=</span><span class="st">"link"</span><span class="kw">&gt;</span>Link 2<span class="kw">&lt;/a&gt;</span></span>
<span id="cb860-47"><a href="mobile-pwa.html#cb860-47"></a>            <span class="kw">&lt;/div&gt;</span></span>
<span id="cb860-48"><a href="mobile-pwa.html#cb860-48"></a>          <span class="kw">&lt;/div&gt;</span></span>
<span id="cb860-49"><a href="mobile-pwa.html#cb860-49"></a></span>
<span id="cb860-50"><a href="mobile-pwa.html#cb860-50"></a>          <span class="co">&lt;!-- Scrollable page content --&gt;</span></span>
<span id="cb860-51"><a href="mobile-pwa.html#cb860-51"></a>          <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">"page-content"</span><span class="kw">&gt;</span></span>
<span id="cb860-52"><a href="mobile-pwa.html#cb860-52"></a>            <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">"block"</span><span class="kw">&gt;</span></span>
<span id="cb860-53"><a href="mobile-pwa.html#cb860-53"></a>              <span class="kw">&lt;p&gt;</span>Welcome to the offline page<span class="kw">&lt;/p&gt;</span></span>
<span id="cb860-54"><a href="mobile-pwa.html#cb860-54"></a>              <span class="kw">&lt;button</span> </span>
<span id="cb860-55"><a href="mobile-pwa.html#cb860-55"></a><span class="ot">                onclick=</span><span class="st">"location.reload();"</span> </span>
<span id="cb860-56"><a href="mobile-pwa.html#cb860-56"></a><span class="ot">                class=</span><span class="st">"toast-button button color-red col"</span><span class="kw">&gt;</span></span>
<span id="cb860-57"><a href="mobile-pwa.html#cb860-57"></a>                Reload</span>
<span id="cb860-58"><a href="mobile-pwa.html#cb860-58"></a>              <span class="kw">&lt;/button&gt;</span></span>
<span id="cb860-59"><a href="mobile-pwa.html#cb860-59"></a>            <span class="kw">&lt;/div&gt;</span></span>
<span id="cb860-60"><a href="mobile-pwa.html#cb860-60"></a>          <span class="kw">&lt;/div&gt;</span></span>
<span id="cb860-61"><a href="mobile-pwa.html#cb860-61"></a>        <span class="kw">&lt;/div&gt;</span></span>
<span id="cb860-62"><a href="mobile-pwa.html#cb860-62"></a>      <span class="kw">&lt;/div&gt;</span></span>
<span id="cb860-63"><a href="mobile-pwa.html#cb860-63"></a>    <span class="kw">&lt;/div&gt;</span></span>
<span id="cb860-64"><a href="mobile-pwa.html#cb860-64"></a>    <span class="co">&lt;!-- jQuery --&gt;</span></span>
<span id="cb860-65"><a href="mobile-pwa.html#cb860-65"></a>    <span class="kw">&lt;script</span> </span>
<span id="cb860-66"><a href="mobile-pwa.html#cb860-66"></a><span class="ot">      type=</span><span class="st">"text/javascript"</span> </span>
<span id="cb860-67"><a href="mobile-pwa.html#cb860-67"></a><span class="ot">      src=</span><span class="st">"shared/jquery.min.js"</span><span class="kw">&gt;</span></span>
<span id="cb860-68"><a href="mobile-pwa.html#cb860-68"></a>    <span class="kw">&lt;/script&gt;</span></span>
<span id="cb860-69"><a href="mobile-pwa.html#cb860-69"></a>    <span class="co">&lt;!-- Path to Framework7 Library Bundle JS --&gt;</span></span>
<span id="cb860-70"><a href="mobile-pwa.html#cb860-70"></a>    <span class="kw">&lt;script</span> </span>
<span id="cb860-71"><a href="mobile-pwa.html#cb860-71"></a><span class="ot">      type=</span><span class="st">"text/javascript"</span>     </span>
<span id="cb860-72"><a href="mobile-pwa.html#cb860-72"></a><span class="ot">      src=</span><span class="st">"framework7-5.7.14/js/framework7.bundle.min.js"</span><span class="kw">&gt;</span></span>
<span id="cb860-73"><a href="mobile-pwa.html#cb860-73"></a>    <span class="kw">&lt;/script&gt;</span></span>
<span id="cb860-74"><a href="mobile-pwa.html#cb860-74"></a>    <span class="co">&lt;!-- Path to your app js --&gt;</span></span>
<span id="cb860-75"><a href="mobile-pwa.html#cb860-75"></a>    <span class="kw">&lt;script&gt;</span></span>
<span id="cb860-76"><a href="mobile-pwa.html#cb860-76"></a>      <span class="kw">var</span> app <span class="op">=</span> <span class="kw">new</span> <span class="at">Framework7</span>(<span class="op">{</span></span>
<span id="cb860-77"><a href="mobile-pwa.html#cb860-77"></a>        <span class="co">// App root element</span></span>
<span id="cb860-78"><a href="mobile-pwa.html#cb860-78"></a>        <span class="dt">root</span><span class="op">:</span> <span class="st">'#app'</span><span class="op">,</span></span>
<span id="cb860-79"><a href="mobile-pwa.html#cb860-79"></a>        <span class="co">// App Name</span></span>
<span id="cb860-80"><a href="mobile-pwa.html#cb860-80"></a>        <span class="dt">name</span><span class="op">:</span> <span class="st">'My App'</span><span class="op">,</span></span>
<span id="cb860-81"><a href="mobile-pwa.html#cb860-81"></a>        <span class="co">// App id</span></span>
<span id="cb860-82"><a href="mobile-pwa.html#cb860-82"></a>        <span class="dt">id</span><span class="op">:</span> <span class="st">'com.myapp.test'</span><span class="op">,</span></span>
<span id="cb860-83"><a href="mobile-pwa.html#cb860-83"></a>        <span class="co">// Enable swipe panel</span></span>
<span id="cb860-84"><a href="mobile-pwa.html#cb860-84"></a>        <span class="dt">panel</span><span class="op">:</span> <span class="op">{</span></span>
<span id="cb860-85"><a href="mobile-pwa.html#cb860-85"></a>          <span class="dt">swipe</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb860-86"><a href="mobile-pwa.html#cb860-86"></a>        <span class="op">},</span></span>
<span id="cb860-87"><a href="mobile-pwa.html#cb860-87"></a>        <span class="dt">autoDarkTheme</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb860-88"><a href="mobile-pwa.html#cb860-88"></a>        <span class="co">// ... other parameters</span></span>
<span id="cb860-89"><a href="mobile-pwa.html#cb860-89"></a>      <span class="op">}</span>)<span class="op">;</span></span>
<span id="cb860-90"><a href="mobile-pwa.html#cb860-90"></a></span>
<span id="cb860-91"><a href="mobile-pwa.html#cb860-91"></a>      <span class="kw">var</span> mainView <span class="op">=</span> <span class="va">app</span>.<span class="va">views</span>.<span class="at">create</span>(<span class="st">'.view-main'</span>)<span class="op">;</span></span>
<span id="cb860-92"><a href="mobile-pwa.html#cb860-92"></a>      </span>
<span id="cb860-93"><a href="mobile-pwa.html#cb860-93"></a>      <span class="cf">if</span> (<span class="va">Framework7</span>.<span class="va">device</span>.<span class="at">standalone</span>) <span class="op">{</span></span>
<span id="cb860-94"><a href="mobile-pwa.html#cb860-94"></a>        <span class="at">$</span>(<span class="st">"html, body"</span>).<span class="at">css</span>(<span class="op">{</span> <span class="dt">height</span><span class="op">:</span> <span class="st">"100vh"</span><span class="op">,</span> <span class="dt">width</span><span class="op">:</span> <span class="st">"100vw"</span> <span class="op">}</span>)<span class="op">;</span></span>
<span id="cb860-95"><a href="mobile-pwa.html#cb860-95"></a>        <span class="cf">if</span> (<span class="at">$</span>(<span class="st">".appbar"</span>).<span class="at">length</span> <span class="op">&gt;</span> <span class="dv">0</span>) <span class="op">{</span></span>
<span id="cb860-96"><a href="mobile-pwa.html#cb860-96"></a>          <span class="at">$</span>(<span class="st">".toolbar"</span>).<span class="at">css</span>(<span class="st">"margin-bottom"</span><span class="op">,</span> <span class="st">"20px"</span>)<span class="op">;</span></span>
<span id="cb860-97"><a href="mobile-pwa.html#cb860-97"></a>        <span class="op">}</span></span>
<span id="cb860-98"><a href="mobile-pwa.html#cb860-98"></a>      <span class="op">}</span></span>
<span id="cb860-99"><a href="mobile-pwa.html#cb860-99"></a>    <span class="kw">&lt;/script&gt;</span></span>
<span id="cb860-100"><a href="mobile-pwa.html#cb860-100"></a>  <span class="kw">&lt;/body&gt;</span></span>
<span id="cb860-101"><a href="mobile-pwa.html#cb860-101"></a><span class="kw">&lt;/html&gt;</span></span></code></pre></div>
<p>Notice that jQuery, required for easier DOM interactions, as well as Framework7 CSS and JS assets are cached in the above service worker script, thereby making them
available to <code>offline.html</code>. This offline fallback relies on Framework7 for consistency reasons but could be replace by any other HTML page, keeping in mind the update
the service worker.</p>
<p>Now, let’s audit our app again: congrats! It is <strong>installable</strong> and reliable, although
further PWA optimization may be provided.</p>
<div class="figure">
<span id="fig:mobile-pwa-audit-final"></span>
<img src="images/mobile/mobile-pwa-audit-final.png" alt="Installable shinyMobile app." width="100%"><p class="caption">
FIGURE 25.7: Installable shinyMobile app.
</p>
</div>
<div class="importantblock">
<p>A common source of error is the <strong>browser cache</strong>. It is best practice to regularly empty it. Alternatively, one may runs in incognito mode, which does not cache files.</p>
</div>
</div>
<div id="disable-pwa-for-the-end-user" class="section level3">
<h3>
<span class="header-section-number">25.2.4</span> Disable PWA for the end user<a class="anchor" aria-label="anchor" href="#disable-pwa-for-the-end-user"><i class="fas fa-link"></i></a>
</h3>
<p>With the above approach, <a href="https://github.com/RinteRface/shinyMobile">shinyMobile</a> will always look for a service worker to register.
Particularly, this would raise an error in case no service worker is found on the server.
What if the user doesn’t want to create a PWA, let’s say for less important applications?
We may add a parameter to <code>f7_page</code>, for instance <code>allowPWA</code>, that is either <code>TRUE</code> or <code>FALSE</code>,
store its value in the <code>body</code> <code>data-pwa</code> attribute and recover it on the JS side within <code>init.js</code>:</p>
<div class="sourceCode" id="cb861"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb861-1"><a href="mobile-pwa.html#cb861-1"></a><span class="co">// check if the app is intended to be a PWA</span></span>
<span id="cb861-2"><a href="mobile-pwa.html#cb861-2"></a><span class="kw">let</span> isPWA <span class="op">=</span> <span class="at">$</span>(<span class="st">'body'</span>).<span class="at">attr</span>(<span class="st">'data-pwa'</span>) <span class="op">===</span> <span class="st">"true"</span><span class="op">;</span></span>
<span id="cb861-3"><a href="mobile-pwa.html#cb861-3"></a></span>
<span id="cb861-4"><a href="mobile-pwa.html#cb861-4"></a><span class="cf">if</span> (isPWA) <span class="op">{</span></span>
<span id="cb861-5"><a href="mobile-pwa.html#cb861-5"></a>  <span class="va">config</span>.<span class="at">serviceWorker</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb861-6"><a href="mobile-pwa.html#cb861-6"></a>    <span class="dt">path</span><span class="op">:</span> <span class="va">window</span>.<span class="va">location</span>.<span class="at">pathname</span> <span class="op">+</span> <span class="st">"service-worker.js"</span><span class="op">,</span></span>
<span id="cb861-7"><a href="mobile-pwa.html#cb861-7"></a>    <span class="dt">scope</span><span class="op">:</span> <span class="va">window</span>.<span class="va">location</span>.<span class="at">pathname</span></span>
<span id="cb861-8"><a href="mobile-pwa.html#cb861-8"></a>  <span class="op">};</span></span>
<span id="cb861-9"><a href="mobile-pwa.html#cb861-9"></a><span class="op">}</span></span></code></pre></div>
<p>It <strong>only</strong> creates <code>config.serviceWorker</code> if the user specified <code>allowPWA = TRUE</code>.</p>
</div>
</div>
<div id="handle-the-installation" class="section level2">
<h2>
<span class="header-section-number">25.3</span> Handle the installation<a class="anchor" aria-label="anchor" href="#handle-the-installation"><i class="fas fa-link"></i></a>
</h2>
<p>It is a great opportunity to propose a <a href="https://developers.google.com/web/fundamentals/app-install-banners/native">custom</a> installation experience.</p>
<div class="warningblock">
<p>To be able to install the app, make sure to replace <code>start_url</code> by the url
where the app is deployed like <code>https://dgranjon.shinyapps.io/installable-pwa-app/</code> for instance.
Missing that step would cause an issue during the service worker registration.</p>
</div>
<p>Once the installation criteria are met, the web browser raises the <strong>beforeinstallprompt</strong> event, (except
on the iOS platform which is not compatible yet. We edit the <code>init.js</code> script and write:</p>
<div class="sourceCode" id="cb862"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb862-1"><a href="mobile-pwa.html#cb862-1"></a><span class="kw">let</span> deferredPrompt<span class="op">;</span></span>
<span id="cb862-2"><a href="mobile-pwa.html#cb862-2"></a><span class="va">window</span>.<span class="at">addEventListener</span>(<span class="st">'beforeinstallprompt'</span><span class="op">,</span> (e) <span class="kw">=&gt;</span> <span class="op">{</span></span>
<span id="cb862-3"><a href="mobile-pwa.html#cb862-3"></a>  <span class="co">// Prevent the mini-infobar from appearing on mobile</span></span>
<span id="cb862-4"><a href="mobile-pwa.html#cb862-4"></a>  <span class="va">e</span>.<span class="at">preventDefault</span>()<span class="op">;</span></span>
<span id="cb862-5"><a href="mobile-pwa.html#cb862-5"></a>  <span class="co">// Stash the event so it can be triggered later.</span></span>
<span id="cb862-6"><a href="mobile-pwa.html#cb862-6"></a>  deferredPrompt <span class="op">=</span> e<span class="op">;</span></span>
<span id="cb862-7"><a href="mobile-pwa.html#cb862-7"></a><span class="op">}</span>)<span class="op">;</span></span></code></pre></div>
<p>This code adds an event listener to the window, prevents it from showing at start with <code>e.preventDefault</code> and
captures it in an external variable called <code>deferredPrompt</code>. The next step comprises the design of our custom piece of UI that will trigger the <code>prompt</code> install. We can benefit from the rich Framework7 interface and display
a <a href="https://framework7.io/docs/toast.html">toast</a> containing an install button. The initialization
is fairly simple, following the pattern <code>app.&lt;COMPONENT&gt;.create(parameters)</code>:</p>
<div class="sourceCode" id="cb863"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb863-1"><a href="mobile-pwa.html#cb863-1"></a><span class="co">// Create custom install UI</span></span>
<span id="cb863-2"><a href="mobile-pwa.html#cb863-2"></a><span class="kw">let</span> installToast <span class="op">=</span> <span class="va">app</span>.<span class="va">toast</span>.<span class="at">create</span>(<span class="op">{</span></span>
<span id="cb863-3"><a href="mobile-pwa.html#cb863-3"></a>  <span class="dt">position</span><span class="op">:</span> <span class="st">'center'</span><span class="op">,</span></span>
<span id="cb863-4"><a href="mobile-pwa.html#cb863-4"></a>  <span class="dt">text</span><span class="op">:</span> <span class="vs">`&lt;button </span></span>
<span id="cb863-5"><a href="mobile-pwa.html#cb863-5"></a><span class="vs">    id="install-button" </span></span>
<span id="cb863-6"><a href="mobile-pwa.html#cb863-6"></a><span class="vs">    class="toast-button button color-green"&gt;</span></span>
<span id="cb863-7"><a href="mobile-pwa.html#cb863-7"></a><span class="vs">    Install</span></span>
<span id="cb863-8"><a href="mobile-pwa.html#cb863-8"></a><span class="vs">  &lt;/button&gt;`</span></span>
<span id="cb863-9"><a href="mobile-pwa.html#cb863-9"></a><span class="op">}</span>)<span class="op">;</span></span></code></pre></div>
<p>We give it an id so as to call it later and edit the <strong>beforeinstallprompt</strong> event listener to show
the toast:</p>
<div class="sourceCode" id="cb864"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb864-1"><a href="mobile-pwa.html#cb864-1"></a><span class="kw">let</span> deferredPrompt<span class="op">;</span></span>
<span id="cb864-2"><a href="mobile-pwa.html#cb864-2"></a><span class="va">window</span>.<span class="at">addEventListener</span>(<span class="st">'beforeinstallprompt'</span><span class="op">,</span> (e) <span class="kw">=&gt;</span> <span class="op">{</span></span>
<span id="cb864-3"><a href="mobile-pwa.html#cb864-3"></a>  <span class="co">// Prevent the mini-infobar from appearing on mobile</span></span>
<span id="cb864-4"><a href="mobile-pwa.html#cb864-4"></a>  <span class="va">e</span>.<span class="at">preventDefault</span>()<span class="op">;</span></span>
<span id="cb864-5"><a href="mobile-pwa.html#cb864-5"></a>  <span class="co">// Stash the event so it can be triggered later.</span></span>
<span id="cb864-6"><a href="mobile-pwa.html#cb864-6"></a>  deferredPrompt <span class="op">=</span> e<span class="op">;</span></span>
<span id="cb864-7"><a href="mobile-pwa.html#cb864-7"></a>  <span class="co">// Show install trigger</span></span>
<span id="cb864-8"><a href="mobile-pwa.html#cb864-8"></a>  <span class="va">installToast</span>.<span class="at">open</span>()<span class="op">;</span></span>
<span id="cb864-9"><a href="mobile-pwa.html#cb864-9"></a><span class="op">}</span>)<span class="op">;</span></span></code></pre></div>
<div class="noteblock">
<p>With jQuery like <code>$(window).on('beforeinstallprompt', ...)</code>, we would capture the event with <code>e.originalEvent</code>!</p>
</div>
<p>We register a second event listener, which fires on the toast button click. We first close the
toast, call the <code>prompt</code> method on the deferred event and log the result:</p>
<div class="sourceCode" id="cb865"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb865-1"><a href="mobile-pwa.html#cb865-1"></a><span class="va">app</span>.<span class="va">utils</span>.<span class="at">nextTick</span>(<span class="kw">function</span>() <span class="op">{</span></span>
<span id="cb865-2"><a href="mobile-pwa.html#cb865-2"></a>  <span class="at">$</span>(<span class="st">'#install-button'</span>).<span class="at">on</span>(<span class="st">'click'</span><span class="op">,</span> <span class="kw">function</span>() <span class="op">{</span></span>
<span id="cb865-3"><a href="mobile-pwa.html#cb865-3"></a>    <span class="co">// close install toast</span></span>
<span id="cb865-4"><a href="mobile-pwa.html#cb865-4"></a>    <span class="va">installToast</span>.<span class="at">close</span>()<span class="op">;</span></span>
<span id="cb865-5"><a href="mobile-pwa.html#cb865-5"></a>    <span class="cf">if</span> (<span class="op">!</span>deferredPrompt) <span class="op">{</span></span>
<span id="cb865-6"><a href="mobile-pwa.html#cb865-6"></a>      <span class="co">// The deferred prompt isn't available.</span></span>
<span id="cb865-7"><a href="mobile-pwa.html#cb865-7"></a>      <span class="cf">return</span><span class="op">;</span></span>
<span id="cb865-8"><a href="mobile-pwa.html#cb865-8"></a>    <span class="op">}</span></span>
<span id="cb865-9"><a href="mobile-pwa.html#cb865-9"></a>    <span class="co">// Show the install prompt.</span></span>
<span id="cb865-10"><a href="mobile-pwa.html#cb865-10"></a>    <span class="va">deferredPrompt</span>.<span class="at">prompt</span>()<span class="op">;</span></span>
<span id="cb865-11"><a href="mobile-pwa.html#cb865-11"></a>    <span class="co">// Log the result</span></span>
<span id="cb865-12"><a href="mobile-pwa.html#cb865-12"></a>    <span class="va">deferredPrompt</span>.<span class="va">userChoice</span>.<span class="at">then</span>((result) <span class="kw">=&gt;</span> <span class="op">{</span></span>
<span id="cb865-13"><a href="mobile-pwa.html#cb865-13"></a>      <span class="va">console</span>.<span class="at">log</span>(<span class="st">'OK'</span><span class="op">,</span> <span class="st">'userChoice'</span><span class="op">,</span> result)<span class="op">;</span></span>
<span id="cb865-14"><a href="mobile-pwa.html#cb865-14"></a>      <span class="co">// Reset the deferred prompt variable, since</span></span>
<span id="cb865-15"><a href="mobile-pwa.html#cb865-15"></a>      <span class="co">// prompt() can only be called once.</span></span>
<span id="cb865-16"><a href="mobile-pwa.html#cb865-16"></a>      deferredPrompt <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb865-17"><a href="mobile-pwa.html#cb865-17"></a>    <span class="op">}</span>)<span class="op">;</span></span>
<span id="cb865-18"><a href="mobile-pwa.html#cb865-18"></a>  <span class="op">}</span>)<span class="op">;</span></span>
<span id="cb865-19"><a href="mobile-pwa.html#cb865-19"></a><span class="op">},</span> <span class="dv">500</span>)<span class="op">;</span></span></code></pre></div>
<p>We run <code><a href="https://rdrr.io/pkg/charpente/man/build_js.html">build_js()</a></code> and deploy the app to shinyapps.io (remember: we must serve the app under HTTPS!). Figure <a href="mobile-pwa.html#fig:mobile-pwa-installable">25.8</a>
illustrates the install prompt window that appears to install the app. Once installed, the <strong>beforeinstallprompt</strong>
event does not fire anymore and the app may be launched as a standalone app, for instance on macOSX (Figure <a href="mobile-pwa.html#fig:mobile-pwa-installed">25.9</a>).</p>
<div class="figure">
<span id="fig:mobile-pwa-installable"></span>
<img src="images/mobile/mobile-pwa-installable.png" alt="Install prompt window." width="100%"><p class="caption">
FIGURE 25.8: Install prompt window.
</p>
</div>
<div class="figure">
<span id="fig:mobile-pwa-installed"></span>
<img src="images/mobile/mobile-pwa-installed.png" alt="Installed PWA on macOSX." width="100%"><p class="caption">
FIGURE 25.9: Installed PWA on macOSX.
</p>
</div>
<p>On Figure <a href="mobile-pwa.html#fig:mobile-pwa-installed">25.9</a>, the blue window color corresponds to the <code>tags$meta(name = "theme-color", content = "#2196f3")</code>, passed in the <code>f7_page</code> layout element. Whenever the connection is lost, the redirection occurs to
the <code>offline.html</code> page, as shown on Figure <a href="mobile-pwa.html#fig:mobile-pwa-offline">25.10</a>.</p>
<div class="figure">
<span id="fig:mobile-pwa-offline"></span>
<img src="images/mobile/mobile-pwa-offline.png" alt="Offline HTML template." width="100%"><p class="caption">
FIGURE 25.10: Offline HTML template.
</p>
</div>
<p>The final product may be run with:</p>
<div class="sourceCode" id="cb866"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/shiny/man/shinyApp.html">shinyAppDir</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"shinyMobile/pwa"</span>, package <span class="op">=</span> <span class="st">"OSUICode"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
</div>
<div id="workbox" class="section level2">
<h2>
<span class="header-section-number">25.4</span> Workbox<a class="anchor" aria-label="anchor" href="#workbox"><i class="fas fa-link"></i></a>
</h2>
<p><a href="https://developers.google.com/web/tools/workbox">Workbox</a> is a more robust alternative
to the approach described above with boilerplate code to enable:</p>
<ul>
<li>pre-caching of dependencies like CSS and JS but also images and Google fonts
to improve performances.</li>
<li>Improve offline experience.</li>
<li>…</li>
</ul>
<div class="importantblock">
<p>This part does not work yet at the time of review submission.
I’ll probably remove it …</p>
</div>
</div>
<div id="other-resources" class="section level2">
<h2>
<span class="header-section-number">25.5</span> Other resources<a class="anchor" aria-label="anchor" href="#other-resources"><i class="fas fa-link"></i></a>
</h2>
<p>The process described above works perfectly for any Shiny template. The reader may also consider other packages like <a href="https://github.com/pedrocoutinhosilva/shiny.pwa">{shiny.pwa}</a>, that creates a PWA compatible structure at run time, within the app <code>/www</code> folder.</p>

</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="mobile-shinyMobile.html"><span class="header-section-number">24</span> Reconstruct {shinyMobile}</a></div>
<div class="next"><a href="mobile-widgets.html"><span class="header-section-number">26</span> Design widgets</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#mobile-pwa"><span class="header-section-number">25</span> {shinyMobile} and PWA</a></li>
<li><a class="nav-link" href="#introduction-5"><span class="header-section-number">25.1</span> Introduction</a></li>
<li>
<a class="nav-link" href="#charpente-and-pwa-tools"><span class="header-section-number">25.2</span> {charpente} and PWA tools</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#create-the-manifest"><span class="header-section-number">25.2.1</span> Create the manifest</a></li>
<li><a class="nav-link" href="#google-pwa-compatibility"><span class="header-section-number">25.2.2</span> Google PWA compatibility</a></li>
<li><a class="nav-link" href="#service-worker-and-offline-page"><span class="header-section-number">25.2.3</span> Service worker and offline page</a></li>
<li><a class="nav-link" href="#disable-pwa-for-the-end-user"><span class="header-section-number">25.2.4</span> Disable PWA for the end user</a></li>
</ul>
</li>
<li><a class="nav-link" href="#handle-the-installation"><span class="header-section-number">25.3</span> Handle the installation</a></li>
<li><a class="nav-link" href="#workbox"><span class="header-section-number">25.4</span> Workbox</a></li>
<li><a class="nav-link" href="#other-resources"><span class="header-section-number">25.5</span> Other resources</a></li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/DivadNojnarg/outstanding-shiny-ui/blob/master/mobile-pwa.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/DivadNojnarg/outstanding-shiny-ui/edit/master/mobile-pwa.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Outstanding User Interfaces with Shiny</strong>" was written by David Granjon. It was last built on 2021-08-27.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer>
</body>
</html>
